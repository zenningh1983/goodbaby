<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â•ΩÂØ∂ÂØ∂ÈªûÊï∏Â≠òÊë∫</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#F2F2F7',
                            card: '#FFFFFF',
                            blue: '#007AFF',
                            green: '#34C759',
                            indigo: '#5856D6',
                            orange: '#FF9500',
                            pink: '#FF2D55',
                            purple: '#AF52DE',
                            red: '#FF3B30',
                            teal: '#5AC8FA',
                            yellow: '#FFCC00',
                            gray: '#8E8E93',
                            gray2: '#AEAEB2',
                            gray3: '#C7C7CC',
                            gray4: '#D1D1D6',
                            gray5: '#E5E5EA',
                            gray6: '#F2F2F7',
                        }
                    },
                    boxShadow: {
                        'ios': '0 4px 12px rgba(0, 0, 0, 0.05)',
                        'ios-lg': '0 10px 20px rgba(0, 0, 0, 0.08)',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', "Noto Sans TC", 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* iOS Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #34C759;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #34C759;
        }
        
        /* Custom Scrollbar for hidden feel */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .sidebar-transition {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuration ---
        const REPO_OWNER = "zenningh1983";
        const REPO_NAME = "goodbaby";
        const FILE_PATH = "data.json";

        // --- Icons (using FontAwesome via className) ---
        const Icons = {
            Sync: "fa-solid fa-rotate",
            Check: "fa-solid fa-check",
            Xmark: "fa-solid fa-xmark",
            Child: "fa-solid fa-child-reaching",
            Parent: "fa-solid fa-user-shield",
            Task: "fa-solid fa-star",
            Reward: "fa-solid fa-gift",
            History: "fa-solid fa-clock-rotate-left",
            Settings: "fa-solid fa-gear",
            Plus: "fa-solid fa-plus",
            Minus: "fa-solid fa-minus",
            Trash: "fa-solid fa-trash-can",
            Lock: "fa-solid fa-lock",
            Edit: "fa-solid fa-pen",
            Coins: "fa-solid fa-coins",
            Eye: "fa-solid fa-eye",
            EyeSlash: "fa-solid fa-eye-slash",
            ChevronLeft: "fa-solid fa-chevron-left",
            ChevronRight: "fa-solid fa-chevron-right",
            Exit: "fa-solid fa-right-from-bracket",
            Image: "fa-regular fa-image",
            Face: "fa-regular fa-face-smile",
        };

        // --- Helper Functions ---
        
        // Base64 handling for UTF-8 (Chinese characters)
        const toBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
        const fromBase64 = (str) => decodeURIComponent(escape(atob(str)));

        // Initial Data Structure
        const INITIAL_DATA = {
            children: [], // { id, name, points, avatar }
            tasks: [],    // { id, title, points, assignee: 'all'|childId }
            rewards: [],  // { id, title, points, assignee: 'all'|childId }
            history: [],  // { id, type: 'task_pending'|'redeem_pending'|'approved'|'rejected'|'manual', childId, itemId, itemName, points, timestamp, status, note }
        };

        // --- Github API ---
        const githubApi = {
            async getData(token) {
                if (!token) return null;
                try {
                    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        headers: { 
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        cache: 'no-store'
                    });
                    if (res.status === 404) return { content: JSON.parse(JSON.stringify(INITIAL_DATA)), sha: null }; // File doesn't exist yet
                    if (res.status === 401) throw new Error('Token ÁÑ°Êïà (401)');
                    if (!res.ok) throw new Error('Fetch failed: ' + res.status);
                    
                    const data = await res.json();
                    let content;
                    try {
                        const decoded = fromBase64(data.content);
                        const parsed = JSON.parse(decoded);
                        // Merge with INITIAL_DATA to ensure all arrays exist even if file is partial
                        content = {
                            children: parsed.children || [],
                            tasks: parsed.tasks || [],
                            rewards: parsed.rewards || [],
                            history: parsed.history || []
                        };
                    } catch (err) {
                        console.error("Parse Error:", err);
                        content = JSON.parse(JSON.stringify(INITIAL_DATA));
                    }
                    return { content, sha: data.sha };
                } catch (e) {
                    console.error("Sync Error (Get):", e);
                    throw e;
                }
            },
            async saveData(token, content, sha) {
                if (!token) throw new Error("No Token");
                try {
                    const body = {
                        message: "Update GoodBaby Data",
                        content: toBase64(JSON.stringify(content, null, 2)),
                        sha: sha || undefined
                    };
                    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });
                    if (res.status === 401) throw new Error('Token ÁÑ°Êïà (401)');
                    if (!res.ok) throw new Error('Save failed: ' + res.status);
                    return await res.json(); // Returns new SHA
                } catch (e) {
                    console.error("Sync Error (Save):", e);
                    throw e;
                }
            }
        };

        // --- Components ---

        // 1. Toast Notification (Centered)
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 2000); // 2s auto close
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-ios-red/90' : (type === 'warning' ? 'bg-ios-orange/90' : 'bg-ios-green/90');

            return (
                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 animate-fade-in pointer-events-none">
                    <div className={`${bgClass} text-white px-8 py-4 rounded-3xl shadow-ios-lg backdrop-blur-md flex flex-col items-center gap-2 font-bold text-lg min-w-[200px] text-center`}>
                        <i className={`text-3xl ${type === 'error' ? Icons.Xmark : (type === 'warning' ? Icons.Sync : Icons.Check)}`}></i>
                        {message}
                    </div>
                </div>
            );
        };

        // 2. Modal
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-40 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="relative bg-white rounded-3xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto animate-slide-up hide-scrollbar">
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 sticky top-0 z-10">
                            <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                                <i className={Icons.Xmark}></i>
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Avatar Component
        const Avatar = ({ avatar, size = "md", className = "" }) => {
            const isImage = avatar && avatar.startsWith('data:image');
            const sizeClass = size === 'lg' ? 'w-24 h-24 text-6xl' : (size === 'xl' ? 'w-32 h-32 text-8xl' : 'w-12 h-12 text-2xl');
            
            if (isImage) {
                return <img src={avatar} className={`rounded-full object-cover border-2 border-white shadow-sm ${sizeClass} ${className}`} alt="avatar" />;
            }
            return (
                <div className={`rounded-full bg-gray-100 flex items-center justify-center border-2 border-white shadow-sm ${sizeClass} ${className}`}>
                    {avatar || 'üë∂'}
                </div>
            );
        };

        // 4. Image Cropper Component
        const ImageCropper = ({ onCrop }) => {
            const [imageSrc, setImageSrc] = useState(null);
            const [scale, setScale] = useState(1);
            const [pos, setPos] = useState({ x: 0, y: 0 });
            const imgRef = useRef(null);
            const canvasRef = useRef(null);

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => setImageSrc(e.target.result);
                    reader.readAsDataURL(e.target.files[0]);
                }
            };

            const handleSave = () => {
                if (!imgRef.current) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const size = 150; // Output size
                canvas.width = size;
                canvas.height = size;

                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);

                const img = imgRef.current;
                ctx.save();
                ctx.beginPath();
                ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
                ctx.clip();
                
                const drawWidth = img.naturalWidth * scale * (size / 100); 
                const drawHeight = img.naturalHeight * scale * (size / 100);
                const drawX = (size - drawWidth) / 2 + pos.x * 2;
                const drawY = (size - drawHeight) / 2 + pos.y * 2;

                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                ctx.restore();

                onCrop(canvas.toDataURL('image/jpeg', 0.8));
                setImageSrc(null);
                setScale(1);
                setPos({ x: 0, y: 0 });
            };

            if (!imageSrc) {
                return (
                    <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-2xl cursor-pointer hover:bg-gray-50 hover:border-ios-blue transition">
                        <div className="flex flex-col items-center justify-center pt-5 pb-6 text-gray-400">
                            <i className={`${Icons.Image} text-3xl mb-2`}></i>
                            <p className="text-sm">ÈªûÊìä‰∏äÂÇ≥ÁÖßÁâá</p>
                        </div>
                        <input type="file" className="hidden" accept="image/*" onChange={handleFileChange} />
                    </label>
                );
            }

            return (
                <div className="flex flex-col gap-4">
                    <div className="relative w-48 h-48 mx-auto bg-gray-100 rounded-full overflow-hidden border-4 border-ios-blue/20 shadow-inner">
                        <img 
                            ref={imgRef}
                            src={imageSrc} 
                            style={{ 
                                transform: `translate(-50%, -50%) translate(${50 + pos.x}%, ${50 + pos.y}%) scale(${scale})`,
                                position: 'absolute',
                                left: '50%',
                                top: '50%',
                                maxWidth: 'none',
                                maxHeight: 'none',
                                width: 'auto',
                                height: 'auto',
                                minWidth: '100%',
                                minHeight: '100%'
                            }}
                            className="pointer-events-none"
                        />
                    </div>
                    
                    <div className="space-y-3 bg-gray-50 p-4 rounded-xl">
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-gray-500 w-8">Á∏ÆÊîæ</span>
                            <input type="range" min="0.5" max="3" step="0.1" value={scale} onChange={(e) => setScale(parseFloat(e.target.value))} className="flex-1 accent-ios-blue" />
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-gray-500 w-8">Ê∞¥Âπ≥</span>
                            <input type="range" min="-50" max="50" value={pos.x} onChange={(e) => setPos({...pos, x: parseInt(e.target.value)})} className="flex-1 accent-ios-blue" />
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-gray-500 w-8">ÂûÇÁõ¥</span>
                            <input type="range" min="-50" max="50" value={pos.y} onChange={(e) => setPos({...pos, y: parseInt(e.target.value)})} className="flex-1 accent-ios-blue" />
                        </div>
                    </div>

                    <div className="flex gap-2">
                        <button type="button" onClick={() => setImageSrc(null)} className="flex-1 py-2 rounded-xl border border-gray-300 text-gray-500 font-bold">ÂèñÊ∂à</button>
                        <button type="button" onClick={handleSave} className="flex-1 py-2 rounded-xl bg-ios-blue text-white font-bold">Á¢∫Ë™çË£ÅÂàá</button>
                    </div>
                    <canvas ref={canvasRef} className="hidden" />
                </div>
            );
        };

        // 5. ChildModal Component (Fixes the Hook error)
        const ChildModal = ({ isOpen, onClose, type, data, onSave }) => {
            const isEdit = type === 'edit_child';
            const initialAvatar = isEdit && data ? data.avatar : 'üë∂';
            const initialName = isEdit && data ? data.name : '';
            
            const [currentAvatar, setCurrentAvatar] = useState(initialAvatar);
            const [avatarType, setAvatarType] = useState(initialAvatar.startsWith('data:image') ? 'image' : 'emoji');

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={isEdit ? "Á∑®ËºØÂ∞èÂ≠©" : "Êñ∞Â¢ûÂ∞èÂ≠©"}>
                    <form onSubmit={(e) => {
                        e.preventDefault();
                        onSave({
                            id: isEdit ? data.id : undefined,
                            name: e.target.name.value,
                            avatar: currentAvatar
                        });
                    }} className="flex flex-col gap-6">
                        <input name="name" placeholder="ÂêçÂ≠ó" defaultValue={initialName} required className="bg-gray-100 p-3 rounded-xl" />
                        
                        <div className="bg-gray-50 p-4 rounded-xl">
                            <div className="flex gap-4 mb-4">
                                <button type="button" onClick={() => setAvatarType('emoji')} className={`flex-1 py-2 rounded-lg font-bold transition ${avatarType === 'emoji' ? 'bg-white shadow text-ios-blue' : 'text-gray-400'}`}>
                                    <i className={`${Icons.Face} mr-2`}></i> Ë°®ÊÉÖÁ¨¶Ëôü
                                </button>
                                <button type="button" onClick={() => setAvatarType('image')} className={`flex-1 py-2 rounded-lg font-bold transition ${avatarType === 'image' ? 'bg-white shadow text-ios-blue' : 'text-gray-400'}`}>
                                    <i className={`${Icons.Image} mr-2`}></i> ÁÖßÁâá
                                </button>
                            </div>

                            {avatarType === 'emoji' ? (
                                <div className="grid grid-cols-5 gap-2">
                                    {['üë¶', 'üëß', 'üë∂', 'üßë‚ÄçüöÄ', 'ü¶Ñ', 'üê±', 'üê∂', 'ü¶ä', 'ü¶Å', 'üê∏'].map(emoji => (
                                        <div key={emoji} onClick={() => setCurrentAvatar(emoji)} className={`text-2xl p-2 rounded-lg text-center cursor-pointer transition ${currentAvatar === emoji ? 'bg-ios-blue/20 scale-110' : 'hover:bg-gray-200'}`}>
                                            {emoji}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <ImageCropper onCrop={(base64) => setCurrentAvatar(base64)} />
                            )}
                        </div>

                        <div className="flex items-center justify-center gap-4">
                            <span className="text-sm text-gray-400">È†êË¶Ω</span>
                            <Avatar avatar={currentAvatar} size="md" />
                        </div>

                        <button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2">{isEdit ? 'ÂÑ≤Â≠ò‰øÆÊîπ' : 'Êñ∞Â¢û'}</button>
                    </form>
                </Modal>
            );
        };

        // --- Main App ---
        const App = () => {
            // State
            const [mode, setMode] = useState('landing'); // landing, parent, child_select, child_dashboard
            const [data, setData] = useState(INITIAL_DATA);
            const [sha, setSha] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, success, error
            const [toast, setToast] = useState(null); // { message, type }
            const [ghToken, setGhToken] = useState(localStorage.getItem('gh_token') || '');
            const [currentChild, setCurrentChild] = useState(null);
            
            // Parent Mode State
            const [parentPass, setParentPass] = useState(localStorage.getItem('parent_pass') || '0000');
            const [tempParentPass, setTempParentPass] = useState(localStorage.getItem('parent_pass') || '0000'); // For editing
            const [isParentAuth, setIsParentAuth] = useState(false);
            const [parentTab, setParentTab] = useState('approvals'); // approvals, tasks, rewards, children, settings
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            
            // UI State
            const [showParentPass, setShowParentPass] = useState(false);
            const [showToken, setShowToken] = useState(false);

            // Modals
            const [modalConfig, setModalConfig] = useState({ open: false, type: '', data: null });

            // --- Effects ---
            
            // Initial Load
            useEffect(() => {
                if (ghToken) fetchData(ghToken);
            }, []); // Run once on mount if token exists

            // --- Logic Functions ---

            const showToast = (msg, type = 'success') => {
                setToast({ message: msg, type });
            };

            const fetchData = async (token = ghToken) => {
                if (!token) return;
                setSyncStatus('syncing');
                try {
                    const result = await githubApi.getData(token);
                    if (result) {
                        setData(result.content);
                        setSha(result.sha);
                        setSyncStatus('success');
                    }
                } catch (e) {
                    setSyncStatus('error');
                    console.log(e);
                    // Don't show toast on initial load error to avoid annoyance, just show icon state
                    if (mode !== 'landing') {
                         if (e.message.includes('401')) {
                            showToast("Token ÁÑ°Êïà (401)ÔºåË´ãÊ™¢Êü•Ë®≠ÂÆö", 'error');
                         } else {
                            showToast("ÂêåÊ≠•Â§±ÊïóÔºåÈÄ≤ÂÖ•Èõ¢Á∑öÊ®°Âºè", 'warning');
                         }
                    }
                }
            };

            const saveData = async (newData) => {
                if (!ghToken) {
                    // Just return, handled by UI logic as offline
                    throw new Error("No Token");
                }
                setSyncStatus('syncing');
                try {
                    // Always fetch latest SHA before saving to avoid conflicts
                    const fresh = await githubApi.getData(ghToken);
                    const currentSha = fresh ? fresh.sha : null;
                    
                    const res = await githubApi.saveData(ghToken, newData, currentSha);
                    // Update SHA after successful save
                    setSha(res.content.sha);
                    setSyncStatus('success');
                } catch (e) {
                    setSyncStatus('error');
                    console.error(e);
                    throw e; // Re-throw to handle in UI
                }
            };

            const handleModeChange = (newMode) => {
                // Refresh data when switching major modes
                if ((newMode === 'parent' || newMode === 'child_select') && ghToken) {
                    fetchData(ghToken);
                }
                setMode(newMode);
            };

            // --- Action Handlers ---

            const handleAction = async (actionType, payload) => {
                // 1. Calculate New Data
                let newData = JSON.parse(JSON.stringify(data));
                const timestamp = Date.now();

                // Ensure arrays exist
                newData.children = newData.children || [];
                newData.tasks = newData.tasks || [];
                newData.rewards = newData.rewards || [];
                newData.history = newData.history || [];

                if (actionType === 'ADD_CHILD') {
                    newData.children.push({ id: timestamp, name: payload.name, points: 0, avatar: payload.avatar });
                } 
                else if (actionType === 'EDIT_CHILD') {
                    const idx = newData.children.findIndex(c => c.id === payload.id);
                    if (idx !== -1) newData.children[idx] = { ...newData.children[idx], ...payload };
                }
                else if (actionType === 'ADD_TASK') {
                    newData.tasks.push({ id: timestamp, ...payload });
                }
                else if (actionType === 'EDIT_TASK') {
                    const idx = newData.tasks.findIndex(t => t.id === payload.id);
                    if (idx !== -1) newData.tasks[idx] = { ...newData.tasks[idx], ...payload };
                }
                else if (actionType === 'ADD_REWARD') {
                    newData.rewards.push({ id: timestamp, ...payload });
                }
                else if (actionType === 'EDIT_REWARD') {
                    const idx = newData.rewards.findIndex(r => r.id === payload.id);
                    if (idx !== -1) newData.rewards[idx] = { ...newData.rewards[idx], ...payload };
                }
                else if (actionType === 'DELETE_ITEM') {
                    if(newData[payload.collection]) {
                        newData[payload.collection] = newData[payload.collection].filter(i => i.id !== payload.id);
                    }
                }
                else if (actionType === 'REQUEST_TASK') {
                    newData.history.unshift({
                        id: timestamp,
                        type: 'task_pending',
                        childId: currentChild.id,
                        itemId: payload.id,
                        itemName: payload.title,
                        points: payload.points,
                        timestamp: timestamp,
                        status: 'pending'
                    });
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
                else if (actionType === 'REQUEST_REDEEM') {
                    if (currentChild.points < payload.points) {
                        showToast("ÈªûÊï∏‰∏çÂ§†ÂñîÔºÅÂÜçÂä†Ê≤π‰∏Ä‰∏ã", 'error');
                        return;
                    }
                    newData.history.unshift({
                        id: timestamp,
                        type: 'redeem_pending',
                        childId: currentChild.id,
                        itemId: payload.id,
                        itemName: payload.title,
                        points: payload.points,
                        timestamp: timestamp,
                        status: 'pending'
                    });
                }
                else if (actionType === 'APPROVE') {
                    const historyIdx = newData.history.findIndex(h => h.id === payload.id);
                    if (historyIdx === -1) return;
                    const historyItem = newData.history[historyIdx];
                    const childIdx = newData.children.findIndex(c => c.id === historyItem.childId);
                    if (childIdx === -1) return;

                    if (historyItem.type === 'task_pending') {
                        newData.children[childIdx].points += parseInt(historyItem.points);
                        newData.history[historyIdx].status = 'approved';
                    } else if (historyItem.type === 'redeem_pending') {
                         if (newData.children[childIdx].points >= parseInt(historyItem.points)) {
                            newData.children[childIdx].points -= parseInt(historyItem.points);
                            newData.history[historyIdx].status = 'approved';
                         } else {
                             showToast("Â∞èÂ≠©ÈªûÊï∏‰∏çË∂≥Êâ£Èô§", 'error');
                             return;
                         }
                    }
                }
                else if (actionType === 'REJECT') {
                    const historyIdx = newData.history.findIndex(h => h.id === payload.id);
                    if (historyIdx !== -1) {
                        newData.history[historyIdx].status = 'rejected';
                    }
                }
                else if (actionType === 'MANUAL_ADJUST') {
                    const childIdx = newData.children.findIndex(c => c.id === parseInt(payload.childId));
                    if (childIdx !== -1) {
                        const points = parseInt(payload.points);
                        newData.children[childIdx].points += points;
                        newData.history.unshift({
                            id: timestamp,
                            type: 'manual',
                            childId: parseInt(payload.childId),
                            itemName: payload.reason,
                            points: points,
                            timestamp: timestamp,
                            status: 'approved',
                            note: payload.reason
                        });
                    }
                }

                // 2. Optimistic Update
                setData(newData);
                
                // Show success toast
                if (actionType === 'REQUEST_TASK') showToast("‰ªªÂãôÊèê‰∫§ÊàêÂäüÔºÅ");
                else if (actionType === 'REQUEST_REDEEM') showToast("ÂÖåÊèõÁî≥Ë´ãÂ∑≤ÈÄÅÂá∫ÔºÅ");
                else if (actionType === 'DELETE_ITEM') showToast("Âà™Èô§ÊàêÂäü");
                else if (actionType === 'APPROVE') showToast("Â∑≤Ê†∏ÂáÜ");
                else if (actionType === 'REJECT') showToast("Â∑≤ÈßÅÂõû", 'error');
                else if (actionType.includes('EDIT')) showToast("‰øÆÊîπÊàêÂäü");
                else if (actionType.includes('ADD')) showToast("Êñ∞Â¢ûÊàêÂäü");

                // 3. Sync in Background
                try {
                    await saveData(newData);
                } catch (e) {
                    showToast("Â∑≤ÂÑ≤Â≠òÊñºÊú¨Ê©ü (ÂêåÊ≠•Â§±Êïó)", 'warning');
                }
            };

            // --- Render Components ---

            const SyncIcon = () => (
                <div className="fixed top-4 right-4 z-50 flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-full glass flex items-center justify-center shadow-sm transition-all ${syncStatus === 'syncing' ? 'animate-spin text-ios-blue' : syncStatus === 'success' ? 'text-ios-green' : syncStatus === 'error' ? 'text-ios-red' : 'text-gray-400'}`}>
                        <i className={Icons.Sync}></i>
                    </div>
                </div>
            );

            // Landing Screen
            if (mode === 'landing') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
                        <SyncIcon />
                        <div className="absolute top-[-10%] left-[-10%] w-64 h-64 bg-ios-blue/20 rounded-full blur-3xl"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-64 h-64 bg-ios-pink/20 rounded-full blur-3xl"></div>
                        
                        <h1 className="text-4xl font-bold text-gray-800 mb-2 tracking-tight flex items-center gap-3">
                            <i className="fa-solid fa-star text-ios-yellow animate-bounce"></i>
                            Â•ΩÂØ∂ÂØ∂
                            <i className="fa-solid fa-heart text-ios-pink animate-bounce" style={{animationDelay: '0.1s'}}></i>
                        </h1>
                        <h2 className="text-2xl font-medium text-gray-500 mb-12 flex items-center gap-2">
                            ÈªûÊï∏Â≠òÊë∫ <span className="text-3xl">üß∏</span>
                        </h2>

                        <div className="flex flex-col gap-4 w-full max-w-xs">
                            <button 
                                onClick={() => handleModeChange('child_select')}
                                className="bg-ios-blue text-white py-4 px-6 rounded-2xl shadow-ios-lg text-lg font-bold hover:scale-105 transition active:scale-95 flex items-center justify-center gap-3"
                            >
                                <i className={Icons.Child}></i> Â∞èÂ≠©Â∞àÂçÄ
                            </button>
                            <button 
                                onClick={() => setModalConfig({ open: true, type: 'parent_login' })}
                                className="bg-white text-ios-indigo py-4 px-6 rounded-2xl shadow-ios text-lg font-bold hover:bg-gray-50 transition active:scale-95 flex items-center justify-center gap-3 border border-ios-indigo/10"
                            >
                                <i className={Icons.Parent}></i> ÂÆ∂Èï∑Â∞àÂçÄ
                            </button>
                        </div>

                        {/* Parent Login Modal */}
                        <Modal isOpen={modalConfig.open && modalConfig.type === 'parent_login'} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="ÂÆ∂Èï∑ÁôªÂÖ•">
                            <div className="flex flex-col gap-4">
                                <p className="text-gray-500 text-sm">Ë´ãËº∏ÂÖ•ÂÆ∂Èï∑ÂØÜÁ¢º (È†êË®≠: 0000)</p>
                                <input 
                                    type="password" 
                                    id="p_pass"
                                    className="w-full p-4 bg-gray-100 rounded-xl text-center text-2xl tracking-widest outline-none focus:ring-2 focus:ring-ios-indigo"
                                    placeholder="‚óè‚óè‚óè‚óè"
                                    maxLength="8"
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            const val = e.target.value;
                                            if (val === parentPass) {
                                                setIsParentAuth(true);
                                                setModalConfig({ ...modalConfig, open: false });
                                                handleModeChange('parent');
                                            } else {
                                                showToast("ÂØÜÁ¢ºÈåØË™§", 'error');
                                            }
                                        }
                                    }}
                                />
                                <button 
                                    onClick={() => {
                                        const val = document.getElementById('p_pass').value;
                                        if (val === parentPass) {
                                            setIsParentAuth(true);
                                            setModalConfig({ ...modalConfig, open: false });
                                            handleModeChange('parent');
                                        } else {
                                            showToast("ÂØÜÁ¢ºÈåØË™§", 'error');
                                        }
                                    }}
                                    className="bg-ios-indigo text-white py-3 rounded-xl font-bold shadow-md"
                                >
                                    ÁôªÂÖ•
                                </button>
                            </div>
                        </Modal>
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            // Child Selection
            if (mode === 'child_select') {
                return (
                    <div className="min-h-screen p-6 flex flex-col items-center">
                         <SyncIcon />
                         <button onClick={() => setMode('landing')} className="self-start mb-8 text-gray-500"><i className="fa-solid fa-arrow-left"></i> ËøîÂõû</button>
                         <h2 className="text-3xl font-bold text-gray-800 mb-8">‰Ω†ÊòØË™∞Âë¢Ôºü</h2>
                         <div className="grid grid-cols-2 gap-6 w-full max-w-md">
                            {(data.children || []).length === 0 && (
                                <div className="col-span-2 text-center text-gray-400 py-10 bg-white rounded-2xl border-dashed border-2 border-gray-200">
                                    ÈÇÑÊ≤íÊúâÂª∫Á´ãÂ∞èÊúãÂèãÊ™îÊ°àÂñî<br/>Ë´ãÁà∏Â™ΩÂÖàÂéªË®≠ÂÆö
                                </div>
                            )}
                            {(data.children || []).map(child => (
                                <button 
                                    key={child.id}
                                    onClick={() => { setCurrentChild(child); setMode('child_dashboard'); }}
                                    className="bg-white p-6 rounded-3xl shadow-ios flex flex-col items-center gap-4 hover:shadow-ios-lg transition transform hover:-translate-y-1"
                                >
                                    <Avatar avatar={child.avatar} size="lg" />
                                    <span className="text-xl font-bold text-gray-700">{child.name}</span>
                                    <span className="bg-ios-yellow/20 text-ios-orange px-3 py-1 rounded-full text-sm font-bold">
                                        {child.points} Èªû
                                    </span>
                                </button>
                            ))}
                         </div>
                    </div>
                );
            }

            // Child Dashboard
            if (mode === 'child_dashboard' && currentChild) {
                // Find fresh data for current child
                const liveChildData = (data.children || []).find(c => c.id === currentChild.id) || currentChild;
                const relevantTasks = (data.tasks || []).filter(t => t.assignee === 'all' || parseInt(t.assignee) === liveChildData.id);
                const relevantRewards = (data.rewards || []).filter(r => r.assignee === 'all' || parseInt(r.assignee) === liveChildData.id);
                const myHistory = (data.history || []).filter(h => h.childId === liveChildData.id).slice(0, 10); // Last 10

                return (
                    <div className="min-h-screen bg-ios-bg pb-24">
                        <SyncIcon />
                        {/* Header */}
                        <div className="bg-white p-6 rounded-b-[40px] shadow-ios sticky top-0 z-20">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => setMode('child_select')} className="w-10 h-10 bg-gray-100 rounded-full text-gray-500"><i className="fa-solid fa-arrow-left"></i></button>
                                <span className="font-bold text-lg text-gray-600">{liveChildData.name} ÁöÑÂ≠òÊë∫</span>
                                <div className="w-10"></div>
                            </div>
                            <div className="flex flex-col items-center">
                                <div className="mb-2">
                                    <Avatar avatar={liveChildData.avatar} size="xl" />
                                </div>
                                <div className="text-5xl font-black text-ios-blue tracking-tighter flex items-center gap-2">
                                    <i className={`${Icons.Coins} text-3xl text-ios-yellow`}></i>
                                    {liveChildData.points}
                                </div>
                                <div className="text-gray-400 text-sm mt-1">ÁõÆÂâçÊìÅÊúâÁöÑÈªûÊï∏</div>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-6 space-y-8">
                            
                            {/* Tasks Section */}
                            <section>
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <span className="bg-ios-blue text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i className={Icons.Task}></i></span>
                                    Ë≥∫ÂèñÈªûÊï∏
                                </h3>
                                <div className="grid gap-4">
                                    {relevantTasks.map(task => (
                                        <div key={task.id} 
                                             onClick={() => {
                                                 if(confirm(`ÂÆåÊàê "${task.title}" ÂóéÔºü`)) handleAction('REQUEST_TASK', task);
                                             }}
                                             className="bg-white p-4 rounded-2xl shadow-ios flex justify-between items-center active:scale-[0.98] transition cursor-pointer border-l-4 border-ios-blue"
                                        >
                                            <span className="font-bold text-lg text-gray-700">{task.title}</span>
                                            <span className="bg-ios-blue/10 text-ios-blue px-3 py-1 rounded-full font-bold">+{task.points}</span>
                                        </div>
                                    ))}
                                    {relevantTasks.length === 0 && <p className="text-center text-gray-400">ÁõÆÂâçÊ≤íÊúâ‰ªªÂãôÂñîÔºÅ</p>}
                                </div>
                            </section>

                            {/* Rewards Section */}
                            <section>
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <span className="bg-ios-pink text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i className={Icons.Reward}></i></span>
                                    ÂÖåÊèõÁçéÂãµ
                                </h3>
                                <div className="grid grid-cols-2 gap-4">
                                    {relevantRewards.map(reward => {
                                        const canAfford = liveChildData.points >= parseInt(reward.points);
                                        return (
                                            <div key={reward.id} 
                                                onClick={() => {
                                                    if(canAfford) {
                                                        if(confirm(`Á¢∫ÂÆöË¶ÅÂÖåÊèõ "${reward.title}" ÂóéÔºü`)) handleAction('REQUEST_REDEEM', reward);
                                                    }
                                                }}
                                                className={`bg-white p-4 rounded-2xl shadow-ios flex flex-col items-center text-center gap-2 transition ${!canAfford ? 'opacity-50 grayscale' : 'active:scale-[0.98] cursor-pointer'}`}
                                            >
                                                <span className="font-bold text-gray-700">{reward.title}</span>
                                                <span className={`px-3 py-1 rounded-full font-bold text-sm ${canAfford ? 'bg-ios-pink/10 text-ios-pink' : 'bg-gray-200 text-gray-500'}`}>
                                                    -{reward.points}
                                                </span>
                                            </div>
                                        )
                                    })}
                                    {relevantRewards.length === 0 && <p className="col-span-2 text-center text-gray-400">ÁõÆÂâçÊ≤íÊúâÁçéÂìÅÂñîÔºÅ</p>}
                                </div>
                            </section>

                            {/* History Section */}
                            <section>
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <span className="bg-ios-gray text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i className={Icons.History}></i></span>
                                    Á¥ÄÈåÑ
                                </h3>
                                <div className="bg-white rounded-2xl shadow-ios overflow-hidden">
                                    {myHistory.map((h, i) => (
                                        <div key={i} className="p-4 border-b border-gray-100 last:border-0 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-gray-700">{h.itemName}</div>
                                                <div className="text-xs text-gray-400">
                                                    {new Date(h.timestamp).toLocaleDateString()}
                                                    {h.status === 'pending' && <span className="ml-2 text-ios-orange">ÂØ©Ê†∏‰∏≠</span>}
                                                    {h.status === 'approved' && <span className="ml-2 text-ios-green">Â∑≤ÂÆåÊàê</span>}
                                                    {h.status === 'rejected' && <span className="ml-2 text-ios-red">Ë¢´ÊãíÁµï</span>}
                                                </div>
                                            </div>
                                            <div className={`font-bold ${
                                                h.type.includes('task') || (h.type === 'manual' && h.points > 0) ? 'text-ios-blue' : 'text-ios-pink'
                                            }`}>
                                                {h.type.includes('task') || (h.type === 'manual' && h.points > 0) ? '+' : '-'}{Math.abs(h.points)}
                                            </div>
                                        </div>
                                    ))}
                                    {myHistory.length === 0 && <div className="p-4 text-center text-gray-400">ÈÇÑÊ≤íÊúâÁ¥ÄÈåÑ</div>}
                                </div>
                            </section>
                        </div>
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            // Parent Dashboard
            if (mode === 'parent') {
                const pendingItems = (data.history || []).filter(h => h.status === 'pending');

                return (
                    <div className="min-h-screen bg-gray-50 flex">
                        <SyncIcon />
                        {/* Sidebar */}
                        <div className={`sidebar-transition fixed bottom-0 left-0 top-0 z-30 bg-white border-r border-gray-200 flex flex-col shadow-lg md:relative ${isSidebarCollapsed ? 'w-20' : 'w-64'}`}>
                            
                            {/* Collapse Toggle */}
                            <div className="p-4 flex justify-end">
                                <button 
                                    onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)}
                                    className="text-gray-400 hover:text-gray-600 transition"
                                >
                                    <i className={isSidebarCollapsed ? Icons.ChevronRight : Icons.ChevronLeft}></i>
                                </button>
                            </div>

                            <div className="flex-1 flex flex-col gap-2 p-3 overflow-y-auto">
                                {['approvals', 'tasks', 'rewards', 'children', 'settings'].map(tab => (
                                    <button 
                                        key={tab}
                                        onClick={() => setParentTab(tab)}
                                        className={`p-3 rounded-xl flex items-center transition relative ${parentTab === tab ? 'text-ios-indigo bg-ios-indigo/5' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'} ${isSidebarCollapsed ? 'justify-center' : 'justify-start gap-4'}`}
                                    >
                                        <i className={`text-xl w-8 text-center ${
                                            tab === 'approvals' ? Icons.Check :
                                            tab === 'tasks' ? Icons.Task :
                                            tab === 'rewards' ? Icons.Reward :
                                            tab === 'children' ? Icons.Child : Icons.Settings
                                        }`}></i>
                                        
                                        {!isSidebarCollapsed && (
                                            <span className="text-base font-medium capitalize">
                                                {tab === 'approvals' ? 'ÂæÖÂØ©Ê†∏' : 
                                                tab === 'tasks' ? '‰ªªÂãô' :
                                                tab === 'rewards' ? 'ÁçéÂãµ' :
                                                tab === 'children' ? 'Â∞èÂ≠©' : 'Ë®≠ÂÆö'}
                                            </span>
                                        )}
                                        
                                        {/* Notification Badge */}
                                        {tab === 'approvals' && pendingItems.length > 0 && (
                                            <span className={`bg-ios-red text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center absolute ${isSidebarCollapsed ? 'top-1 right-1' : 'top-1/2 right-3 -translate-y-1/2'}`}>
                                                {pendingItems.length}
                                            </span>
                                        )}
                                    </button>
                                ))}
                            </div>

                            <div className="p-3 border-t">
                                <button onClick={() => setMode('landing')} className={`flex items-center text-gray-400 hover:text-ios-red p-3 rounded-xl transition ${isSidebarCollapsed ? 'justify-center' : 'justify-start gap-4'}`}>
                                    <i className={`w-8 text-center ${Icons.Exit}`}></i>
                                    {!isSidebarCollapsed && <span className="font-medium">ÈÄÄÂá∫</span>}
                                </button>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="flex-1 p-6 pb-24 md:pb-6 overflow-y-auto h-screen ml-20 md:ml-0">
                            <h1 className="text-2xl font-bold text-gray-800 mb-6 capitalize">
                                {parentTab === 'approvals' ? 'ÂØ©Ê†∏Áî≥Ë´ã' : 
                                 parentTab === 'tasks' ? '‰ªªÂãôÁÆ°ÁêÜ' :
                                 parentTab === 'rewards' ? 'ÁçéÂãµÁÆ°ÁêÜ' :
                                 parentTab === 'children' ? 'Â∞èÂ≠©ÁÆ°ÁêÜ' : 'Á≥ªÁµ±Ë®≠ÂÆö'}
                            </h1>

                            {/* Approvals Tab */}
                            {parentTab === 'approvals' && (
                                <div className="space-y-4">
                                    {pendingItems.length === 0 && (
                                        <div className="text-center py-20 text-gray-400 bg-white rounded-3xl shadow-sm">
                                            <i className="fa-regular fa-face-smile text-4xl mb-4"></i>
                                            <p>Â§™Ê£í‰∫ÜÔºÅÁõÆÂâçÊ≤íÊúâÂæÖÂØ©Ê†∏È†ÖÁõÆ</p>
                                        </div>
                                    )}
                                    {pendingItems.map(item => {
                                        const child = (data.children || []).find(c => c.id === item.childId);
                                        return (
                                            <div key={item.id} className="bg-white p-6 rounded-2xl shadow-ios flex flex-col sm:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center gap-4">
                                                    <Avatar avatar={child?.avatar} />
                                                    <div>
                                                        <div className="font-bold text-gray-800">
                                                            {child?.name} ÊÉ≥{item.type === 'task_pending' ? 'È†òÂèñ‰ªªÂãôÁçéÂãµ' : 'ÂÖåÊèõÁçéÂìÅ'}
                                                        </div>
                                                        <div className="text-gray-500">
                                                            È†ÖÁõÆ: <span className="font-medium text-ios-indigo">{item.itemName}</span> ({item.points} Èªû)
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-3 w-full sm:w-auto">
                                                    <button onClick={() => handleAction('REJECT', item)} className="flex-1 sm:flex-none py-2 px-6 rounded-xl border border-gray-200 text-gray-500 hover:bg-gray-50 font-bold">ÈßÅÂõû</button>
                                                    <button onClick={() => handleAction('APPROVE', item)} className="flex-1 sm:flex-none py-2 px-6 rounded-xl bg-ios-indigo text-white shadow-lg hover:opacity-90 font-bold">ÊâπÂáÜ</button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                    
                                    <div className="mt-8 border-t pt-8">
                                        <h3 className="font-bold text-gray-700 mb-4">ÊâãÂãïÁçéÊá≤</h3>
                                        <button 
                                            onClick={() => setModalConfig({ open: true, type: 'manual_adjust' })}
                                            className="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 p-4 rounded-2xl hover:border-ios-indigo hover:text-ios-indigo transition font-bold"
                                        >
                                            + Êñ∞Â¢ûÁçéÊá≤Á¥ÄÈåÑ (Âä†Èªû/Êâ£Èªû)
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Children Tab */}
                            {parentTab === 'children' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {(data.children || []).map(child => (
                                        <div key={child.id} className="bg-white p-6 rounded-2xl shadow-ios flex items-center gap-4 relative">
                                            <Avatar avatar={child.avatar} size="lg" />
                                            <div>
                                                <div className="font-bold text-xl">{child.name}</div>
                                                <div className="text-ios-indigo font-bold">{child.points} Èªû</div>
                                            </div>
                                            <div className="absolute top-4 right-4 flex gap-2">
                                                <button 
                                                    onClick={() => setModalConfig({ open: true, type: 'edit_child', data: child })}
                                                    className="text-gray-300 hover:text-ios-blue"
                                                >
                                                    <i className={Icons.Edit}></i>
                                                </button>
                                                <button 
                                                    onClick={() => handleAction('DELETE_ITEM', { collection: 'children', id: child.id })}
                                                    className="text-gray-300 hover:text-ios-red"
                                                >
                                                    <i className={Icons.Trash}></i>
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                    <button 
                                        onClick={() => setModalConfig({ open: true, type: 'add_child' })}
                                        className="bg-gray-100 border-2 border-dashed border-gray-300 text-gray-400 p-6 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white hover:border-ios-blue hover:text-ios-blue transition min-h-[120px]"
                                    >
                                        <i className={`${Icons.Plus} text-2xl`}></i>
                                        <span className="font-bold">Êñ∞Â¢ûÂ∞èÂ≠©</span>
                                    </button>
                                </div>
                            )}

                            {/* Tasks / Rewards Tabs (Similar Structure) */}
                            {(parentTab === 'tasks' || parentTab === 'rewards') && (
                                <div>
                                    <button 
                                        onClick={() => setModalConfig({ open: true, type: parentTab === 'tasks' ? 'add_task' : 'add_reward' })}
                                        className="w-full bg-ios-indigo text-white p-4 rounded-2xl shadow-ios mb-6 font-bold flex items-center justify-center gap-2 hover:opacity-90 transition"
                                    >
                                        <i className={Icons.Plus}></i> Êñ∞Â¢û{parentTab === 'tasks' ? '‰ªªÂãô' : 'ÁçéÂãµ'}
                                    </button>
                                    <div className="space-y-4">
                                        {(data[parentTab] || []).map(item => (
                                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                                                <div>
                                                    <div className="font-bold text-gray-800">{item.title}</div>
                                                    <div className="text-sm text-gray-500">
                                                        <span className={`font-bold ${parentTab === 'tasks' ? 'text-ios-blue' : 'text-ios-pink'}`}>
                                                            {item.points} Èªû
                                                        </span>
                                                        <span className="mx-2">‚Ä¢</span>
                                                        ÈÅ©Áî®: {item.assignee === 'all' ? 'ÊâÄÊúâ‰∫∫' : (data.children || []).find(c => c.id === parseInt(item.assignee))?.name || 'Êú™Áü•'}
                                                    </div>
                                                </div>
                                                <div className="flex items-center">
                                                    <button 
                                                        onClick={() => setModalConfig({ 
                                                            open: true, 
                                                            type: parentTab === 'tasks' ? 'edit_task' : 'edit_reward',
                                                            data: item 
                                                        })}
                                                        className="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-ios-blue rounded-full hover:bg-gray-100 mr-2"
                                                    >
                                                        <i className={Icons.Edit}></i>
                                                    </button>
                                                    <button 
                                                        onClick={() => handleAction('DELETE_ITEM', { collection: parentTab, id: item.id })}
                                                        className="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-ios-red rounded-full hover:bg-gray-100"
                                                    >
                                                        <i className={Icons.Trash}></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Settings Tab */}
                            {parentTab === 'settings' && (
                                <div className="space-y-6 max-w-lg">
                                    {/* Password Block First */}
                                    <div className="bg-white p-6 rounded-2xl shadow-ios">
                                        <h3 className="font-bold text-gray-800 mb-4">ÂÆ∂Èï∑ÂØÜÁ¢ºË®≠ÂÆö</h3>
                                        <div className="space-y-2">
                                            <div className="relative">
                                                <input 
                                                    type={showParentPass ? "text" : "password"}
                                                    value={tempParentPass}
                                                    onChange={(e) => setTempParentPass(e.target.value)}
                                                    className="w-full bg-gray-100 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ios-indigo pr-10"
                                                    placeholder="Ëº∏ÂÖ•Êñ∞ÂØÜÁ¢º"
                                                />
                                                <button 
                                                    onClick={() => setShowParentPass(!showParentPass)}
                                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                                >
                                                    <i className={showParentPass ? Icons.EyeSlash : Icons.Eye}></i>
                                                </button>
                                            </div>
                                            <button 
                                                onClick={() => {
                                                    setParentPass(tempParentPass);
                                                    localStorage.setItem('parent_pass', tempParentPass);
                                                    showToast("ÂØÜÁ¢ºÂ∑≤Êõ¥Êñ∞");
                                                }}
                                                className="w-full bg-ios-indigo text-white p-3 rounded-xl font-bold"
                                            >
                                                ÂÑ≤Â≠òÊñ∞ÂØÜÁ¢º
                                            </button>
                                        </div>
                                    </div>

                                    {/* GitHub Block Second */}
                                    <div className="bg-white p-6 rounded-2xl shadow-ios">
                                        <h3 className="font-bold text-gray-800 mb-4">Github ÂêåÊ≠•Ë®≠ÂÆö</h3>
                                        <div className="space-y-2">
                                            <label className="text-sm text-gray-500">Personal Access Token</label>
                                            <div className="flex gap-2">
                                                <div className="flex-1 flex items-center bg-gray-100 rounded-xl px-3 border border-transparent focus-within:ring-2 focus-within:ring-ios-indigo relative">
                                                    <input 
                                                        type={showToken ? "text" : "password"} 
                                                        value={ghToken}
                                                        onChange={(e) => setGhToken(e.target.value)}
                                                        placeholder="Ëº∏ÂÖ• ghp_ ÂæåÁöÑ token ‰∫ÇÁ¢º"
                                                        className="flex-1 bg-transparent py-3 outline-none pr-16"
                                                    />
                                                    <div className="absolute right-2 flex items-center gap-1">
                                                        <button 
                                                            onClick={() => setShowToken(!showToken)}
                                                            className="p-2 text-gray-400 hover:text-gray-600"
                                                        >
                                                            <i className={showToken ? Icons.EyeSlash : Icons.Eye}></i>
                                                        </button>
                                                        {ghToken && (
                                                            <button onClick={() => { setGhToken(''); localStorage.removeItem('gh_token'); }} className="text-ios-red font-bold text-sm whitespace-nowrap px-2">Ê∏ÖÈô§</button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <p className="text-xs text-gray-400">
                                                Repository: <code>{REPO_OWNER}/{REPO_NAME}</code>
                                            </p>
                                            <button 
                                                onClick={async () => {
                                                    let trimmed = ghToken.trim();
                                                    if (!trimmed) {
                                                        showToast("Ë´ãËº∏ÂÖ• Token", 'error');
                                                        return;
                                                    }

                                                    // Ëá™ÂãïË£úÂÖ®ÂâçÁ∂¥
                                                    if (!trimmed.startsWith('ghp_') && !trimmed.startsWith('github_pat_')) {
                                                        trimmed = 'ghp_' + trimmed;
                                                    }
                                                    
                                                    // Êõ¥Êñ∞ state ‰ª•Á¢∫‰øù UI È°ØÁ§∫ÔºàÈÅ∏ÊìáÊÄßÔºâ‰∏¶ÂÑ≤Â≠ò
                                                    setGhToken(trimmed);
                                                    localStorage.setItem('gh_token', trimmed);
                                                    
                                                    // Test connection
                                                    setSyncStatus('syncing');
                                                    try {
                                                        const res = await githubApi.getData(trimmed);
                                                        setSyncStatus('success');
                                                        showToast("ÈÄ£Á∑öÊàêÂäüÔºÅ");
                                                        if (res) {
                                                            setData(res.content);
                                                            setSha(res.sha);
                                                        }
                                                    } catch (e) {
                                                        setSyncStatus('error');
                                                        if (e.message.includes('401')) {
                                                            showToast("Token ÁÑ°Êïà (401)", 'error');
                                                        } else {
                                                            showToast("ÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÊ™¢Êü•Ë®≠ÂÆö", 'error');
                                                        }
                                                    }
                                                }}
                                                className="w-full mt-2 bg-gray-800 text-white p-3 rounded-xl font-bold"
                                            >
                                                ÂÑ≤Â≠ò‰∏¶Ê∏¨Ë©¶ÈÄ£Á∑ö
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Modals for Parent Actions */}
                        
                        {/* Child Modal - Refactored Component */}
                        {(modalConfig.type === 'add_child' || modalConfig.type === 'edit_child') && (
                            <ChildModal 
                                isOpen={modalConfig.open} 
                                onClose={() => setModalConfig({ ...modalConfig, open: false })}
                                type={modalConfig.type}
                                data={modalConfig.data}
                                onSave={(payload) => {
                                    handleAction(modalConfig.type === 'edit_child' ? 'EDIT_CHILD' : 'ADD_CHILD', payload);
                                    setModalConfig({ ...modalConfig, open: false });
                                }}
                            />
                        )}

                        {/* Add/Edit Task/Reward Modal */}
                        {(() => {
                            const isTaskModal = modalConfig.type === 'add_task' || modalConfig.type === 'edit_task';
                            const isRewardModal = modalConfig.type === 'add_reward' || modalConfig.type === 'edit_reward';
                            const isEdit = modalConfig.type.startsWith('edit');
                            
                            return (
                                <Modal isOpen={modalConfig.open && (isTaskModal || isRewardModal)} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={isTaskModal ? (isEdit ? 'Á∑®ËºØ‰ªªÂãô' : 'Êñ∞Â¢û‰ªªÂãô') : (isEdit ? 'Á∑®ËºØÁçéÂãµ' : 'Êñ∞Â¢ûÁçéÂãµ')}>
                                    <form onSubmit={(e) => {
                                        e.preventDefault();
                                        const payload = {
                                            id: isEdit ? modalConfig.data.id : undefined,
                                            title: e.target.title.value,
                                            points: parseInt(e.target.points.value),
                                            assignee: e.target.assignee.value
                                        };
                                        
                                        let action = '';
                                        if (isTaskModal) action = isEdit ? 'EDIT_TASK' : 'ADD_TASK';
                                        else action = isEdit ? 'EDIT_REWARD' : 'ADD_REWARD';
                                        
                                        handleAction(action, payload);
                                        setModalConfig({ ...modalConfig, open: false });
                                    }} className="flex flex-col gap-4">
                                        <input name="title" placeholder="ÂêçÁ®± (‰æãÂ¶Ç: Âà∑Áâô)" defaultValue={isEdit ? modalConfig.data.title : ''} required className="bg-gray-100 p-3 rounded-xl" />
                                        <input type="number" name="points" placeholder="ÈªûÊï∏" defaultValue={isEdit ? modalConfig.data.points : ''} required className="bg-gray-100 p-3 rounded-xl" />
                                        <select name="assignee" defaultValue={isEdit ? modalConfig.data.assignee : 'all'} className="bg-gray-100 p-3 rounded-xl">
                                            <option value="all">ÊâÄÊúâÂ∞èÂ≠©</option>
                                            {(data.children || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                        <button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2">{isEdit ? 'ÂÑ≤Â≠ò‰øÆÊîπ' : 'Êñ∞Â¢û'}</button>
                                    </form>
                                </Modal>
                            );
                        })()}

                        {/* Manual Adjust Modal */}
                        <Modal isOpen={modalConfig.open && modalConfig.type === 'manual_adjust'} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="ÊâãÂãïÁçéÊá≤">
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const isDeduct = e.target.type.value === 'deduct';
                                const pts = parseInt(e.target.points.value);
                                handleAction('MANUAL_ADJUST', {
                                    childId: e.target.childId.value,
                                    points: isDeduct ? -pts : pts,
                                    reason: e.target.reason.value
                                });
                                setModalConfig({ ...modalConfig, open: false });
                            }} className="flex flex-col gap-4">
                                <select name="childId" className="bg-gray-100 p-3 rounded-xl" required>
                                    {(data.children || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                                <div className="flex gap-4">
                                    <label className="flex-1 flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer has-[:checked]:bg-ios-green/10 has-[:checked]:text-ios-green border border-transparent has-[:checked]:border-ios-green">
                                        <input type="radio" name="type" value="add" defaultChecked className="hidden" /> Âä†ÂàÜ
                                    </label>
                                    <label className="flex-1 flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer has-[:checked]:bg-ios-red/10 has-[:checked]:text-ios-red border border-transparent has-[:checked]:border-ios-red">
                                        <input type="radio" name="type" value="deduct" className="hidden" /> Êâ£ÂàÜ
                                    </label>
                                </div>
                                <input type="number" name="points" placeholder="ÈªûÊï∏" required className="bg-gray-100 p-3 rounded-xl" />
                                <input name="reason" placeholder="ÂéüÂõ† (‰æãÂ¶Ç: ÊâìÊû∂„ÄÅÂπ´ÂøôÂÅöÂÆ∂‰∫ã)" required className="bg-gray-100 p-3 rounded-xl" />
                                <button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2">Âü∑Ë°å</button>
                            </form>
                        </Modal>
                        
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
