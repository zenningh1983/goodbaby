<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â•ΩÂØ∂ÂØ∂ÈªûÊï∏Â≠òÊë∫</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#FFF9F2',      // Ê∫´ÊöñÂ•∂Ê≤πÁôΩ
                            card: '#FFFFFF',
                            blue: '#89CFF0',    // ÂØ∂ÂØ∂Ëóç
                            green: '#98FB98',   // ËñÑËç∑Á∂†
                            indigo: '#B39EB5',  // Ëñ∞Ë°£ËçâÁ¥´ (Âèñ‰ª£ÂéüÊú¨ÁöÑÊ∑±ÈùõËâ≤)
                            orange: '#FFD1A9',  // Â•∂Ê≤πÊùè
                            pink: '#FFB7B2',    // Ê´ªËä±Á≤â
                            purple: '#DDA0DD',  // Ê¢ÖÂ≠êÁ≤âÁ¥´
                            red: '#FF6961',     // ÊüîÂíåÁ¥Ö
                            teal: '#88D8C0',    // ÊπñÊ∞¥Á∂†
                            yellow: '#FDFD96',  // Ê™∏Ê™¨ÈªÉ
                            gray: '#A9A9A9',    // ÊüîÂíåÁÅ∞
                            gray2: '#D3D3D3',
                            gray3: '#E0E0E0',
                            gray4: '#F5F5F5',
                            gray5: '#FAFAFA',
                            gray6: '#FFFFFF',
                        }
                    },
                    boxShadow: {
                        'ios': '0 4px 12px rgba(137, 207, 240, 0.15)', // ËóçËâ≤Á≥ªÈô∞ÂΩ±
                        'ios-lg': '0 10px 25px rgba(179, 158, 181, 0.2)', // Á¥´Ëâ≤Á≥ªÈô∞ÂΩ±
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', "Noto Sans TC", 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #FFF9F2;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior: none;
            color: #555; /* È†êË®≠ÊñáÂ≠óÈ°èËâ≤ÊîπÁÇ∫Ê∑±ÁÅ∞ÔºåÊØîËºÉ‰∏çÂà∫Áúº */
        }
        
        /* iOS Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #98FB98;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #98FB98;
        }
        
        /* Custom Scrollbar */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .sidebar-transition {
            transition: width 0.3s ease-in-out;
        }

        /* Custom Select Arrow */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23B39EB5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Configuration ---
        const REPO_OWNER = "zenningh1983";
        const REPO_NAME = "goodbaby";
        const FILE_PATH = "data.json";

        // [ÈÄ≤ÈöéË®≠ÂÆö] È†êË®≠ Token (Ë´ãÂ°´ÂÖ• ghp_ ÂæåÈù¢ÁöÑÂ≠ó‰∏≤)
        // Ê≥®ÊÑèÔºöË´ãÂãøÁõ¥Êé•Â∞áÂÆåÊï¥ÁöÑ Token (ÂåÖÂê´ ghp_) Ë≤ºÂÖ•Ôºå‰ª•ÂÖç GitHub ÂÅµÊ∏¨Âà∞‰∏¶ÈòªÊìã Deploy
        // Ëã•ÊÇ®ÁöÑ Token ÊòØ "ghp_Abc123..."ÔºåË´ãÂú®‰∏ãÊñπÂºïËôüÂÖßÂ°´ÂÖ• "Abc123..."
        const DEFAULT_TOKEN_SUFFIX = "hfFz2uYiriKFcVZlrD3YU79KRTdBvf0yd7PA";

        // --- Icons ---
        const Icons = {
            Sync: "fa-solid fa-rotate",
            Check: "fa-solid fa-check",
            Xmark: "fa-solid fa-xmark",
            Child: "fa-solid fa-child-reaching",
            Parent: "fa-solid fa-user-shield",
            Task: "fa-solid fa-star",
            Reward: "fa-solid fa-gift",
            History: "fa-solid fa-clock-rotate-left",
            Settings: "fa-solid fa-gear",
            Plus: "fa-solid fa-plus",
            Minus: "fa-solid fa-minus",
            Trash: "fa-solid fa-trash-can",
            Lock: "fa-solid fa-lock",
            Edit: "fa-solid fa-pen",
            Coins: "fa-solid fa-coins",
            Eye: "fa-solid fa-eye",
            EyeSlash: "fa-solid fa-eye-slash",
            ChevronLeft: "fa-solid fa-chevron-left",
            ChevronRight: "fa-solid fa-chevron-right",
            Exit: "fa-solid fa-right-from-bracket",
            Image: "fa-regular fa-image",
            Face: "fa-regular fa-face-smile",
            Filter: "fa-solid fa-filter",
            Bars: "fa-solid fa-bars",
            Repeat: "fa-solid fa-repeat",
        };

        // --- Helper Functions ---
        const toBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
        const fromBase64 = (str) => decodeURIComponent(escape(atob(str)));

        // Initial Data Structure
        const INITIAL_DATA = {
            children: [], 
            categories: [
                { id: 'cat_default_task', name: 'Êó•Â∏∏', type: 'task', color: 'blue' },
                { id: 'cat_default_reward', name: 'ÈªûÂøÉ', type: 'reward', color: 'pink' }
            ],
            tasks: [],    // { id, title, points, assignee, categoryId }
            rewards: [],  // { id, title, points, assignee, categoryId, isRepeatable }
            history: [],  
        };

        // --- Github API ---
        const githubApi = {
            async getData(token) {
                if (!token) return null;
                try {
                    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        headers: { 
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        cache: 'no-store'
                    });
                    if (res.status === 404) return { content: JSON.parse(JSON.stringify(INITIAL_DATA)), sha: null };
                    if (res.status === 401) throw new Error('Token ÁÑ°Êïà (401)');
                    if (!res.ok) throw new Error('Fetch failed: ' + res.status);
                    
                    const data = await res.json();
                    let content;
                    try {
                        const decoded = fromBase64(data.content);
                        const parsed = JSON.parse(decoded);
                        content = { ...INITIAL_DATA, ...parsed }; // Merge to ensure structure
                        // Ensure categories exist
                        if (!content.categories) content.categories = INITIAL_DATA.categories;
                    } catch (err) {
                        content = JSON.parse(JSON.stringify(INITIAL_DATA));
                    }
                    return { content, sha: data.sha };
                } catch (e) {
                    console.error("Sync Error (Get):", e);
                    throw e;
                }
            },
            async saveData(token, content, sha) {
                if (!token) throw new Error("No Token");
                try {
                    const body = {
                        message: "Update GoodBaby Data",
                        content: toBase64(JSON.stringify(content, null, 2)),
                        sha: sha || undefined
                    };
                    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });
                    if (res.status === 401) throw new Error('Token ÁÑ°Êïà (401)');
                    if (!res.ok) throw new Error('Save failed: ' + res.status);
                    return await res.json();
                } catch (e) {
                    console.error("Sync Error (Save):", e);
                    throw e;
                }
            }
        };

        // --- Components ---

        // 1. Toast (Refined)
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 1000); // 1s auto close
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-ios-red/80' : (type === 'warning' ? 'bg-ios-orange/80' : 'bg-ios-green/80');

            return (
                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[60] animate-fade-in pointer-events-none">
                    <div className={`${bgClass} text-white px-6 py-3 rounded-2xl shadow-sm backdrop-blur-sm flex items-center gap-2 font-medium text-sm max-w-[80vw] truncate`}>
                        <i className={type === 'error' ? Icons.Xmark : (type === 'warning' ? Icons.Sync : Icons.Check)}></i>
                        {message}
                    </div>
                </div>
            );
        };

        // 2. Modal (Click outside to close)
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-ios-indigo/20 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="relative bg-white rounded-3xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto animate-slide-up hide-scrollbar border-4 border-white" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-ios-bg sticky top-0 z-10">
                            <h3 className="text-lg font-bold text-gray-700">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-ios-red w-8 h-8 flex items-center justify-center rounded-full hover:bg-white transition">
                                <i className={Icons.Xmark}></i>
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Avatar Component
        const Avatar = ({ avatar, size = "md", className = "" }) => {
            const isImage = avatar && avatar.startsWith('data:image');
            const sizeClasses = {
                sm: 'w-8 h-8 text-lg',
                md: 'w-12 h-12 text-2xl',
                lg: 'w-20 h-20 text-5xl',
                xl: 'w-32 h-32 text-7xl'
            };
            const sizeClass = sizeClasses[size] || sizeClasses.md;
            
            if (isImage) {
                return <img src={avatar} className={`rounded-full object-cover border-4 border-white shadow-sm ${sizeClass} ${className}`} alt="avatar" />;
            }
            return (
                <div className={`rounded-full bg-white flex items-center justify-center border-4 border-ios-blue/20 shadow-sm ${sizeClass} ${className}`}>
                    {avatar || 'üë∂'}
                </div>
            );
        };

        // 4. Gesture Image Cropper
        const GestureCropper = ({ onImageReady }) => {
            const [imageSrc, setImageSrc] = useState(null);
            const containerRef = useRef(null);
            const state = useRef({ x: 0, y: 0, scale: 1 });
            const [renderTrigger, setRenderTrigger] = useState(0); 

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const containerSize = 256; 
                            const scale = Math.max(containerSize / img.naturalWidth, containerSize / img.naturalHeight);
                            state.current = { x: 0, y: 0, scale: scale };
                            setImageSrc(e.target.result);
                        };
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };

            useEffect(() => {
                if (imageSrc) {
                    const capture = () => {
                        const size = 256;
                        const canvas = document.createElement('canvas');
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.src = imageSrc;
                        
                        img.onload = () => {
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, size, size);
                            ctx.translate(size / 2, size / 2);
                            ctx.translate(state.current.x, state.current.y);
                            ctx.scale(state.current.scale, state.current.scale);
                            ctx.drawImage(img, -img.naturalWidth / 2, -img.naturalHeight / 2);
                            onImageReady(canvas.toDataURL('image/jpeg', 0.6)); 
                        };
                    };
                    const t = setTimeout(capture, 100);
                    return () => clearTimeout(t);
                }
            }, [imageSrc, renderTrigger, onImageReady]);

            const handlePointerDown = (e) => {
                e.target.setPointerCapture(e.pointerId);
                const startX = e.clientX;
                const startY = e.clientY;
                const initialX = state.current.x;
                const initialY = state.current.y;

                const onPointerMove = (moveEvent) => {
                    state.current.x = initialX + (moveEvent.clientX - startX);
                    state.current.y = initialY + (moveEvent.clientY - startY);
                    setRenderTrigger(prev => prev + 1);
                };

                const onPointerUp = () => {
                    e.target.removeEventListener('pointermove', onPointerMove);
                    e.target.removeEventListener('pointerup', onPointerUp);
                };

                e.target.addEventListener('pointermove', onPointerMove);
                e.target.addEventListener('pointerup', onPointerUp);
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const scaleChange = e.deltaY * -0.001;
                state.current.scale = Math.min(Math.max(0.1, state.current.scale + scaleChange), 10);
                setRenderTrigger(prev => prev + 1);
            };

            if (!imageSrc) {
                return (
                    <label className="flex flex-col items-center justify-center w-64 h-64 border-4 border-dashed border-ios-blue/30 rounded-full cursor-pointer hover:bg-white hover:border-ios-blue transition mx-auto bg-ios-bg">
                        <div className="flex flex-col items-center justify-center text-ios-blue/50">
                            <i className={`${Icons.Image} text-3xl mb-2`}></i>
                            <p className="text-sm font-bold">ÈªûÊìä‰∏äÂÇ≥ÁÖßÁâá</p>
                        </div>
                        <input type="file" className="hidden" accept="image/*" onChange={handleFileChange} />
                    </label>
                );
            }

            return (
                <div className="relative w-64 h-64 bg-white rounded-full overflow-hidden touch-none mx-auto border-4 border-ios-blue" ref={containerRef}>
                    <div className="absolute inset-0 flex items-center justify-center cursor-move" onPointerDown={handlePointerDown} onWheel={handleWheel}>
                        <img 
                            src={imageSrc} 
                            style={{
                                transform: `translate(${state.current.x}px, ${state.current.y}px) scale(${state.current.scale})`, 
                                maxWidth: 'none', 
                                maxHeight: 'none', 
                                pointerEvents: 'none',
                                transformOrigin: 'center'
                            }} 
                        />
                    </div>
                    <div className="absolute inset-0 pointer-events-none rounded-full shadow-[inset_0_0_20px_rgba(0,0,0,0.1)]"></div>
                    <div className="absolute bottom-4 left-0 right-0 text-center text-[10px] text-white/80 drop-shadow-md pointer-events-none font-bold">ÊãñÊõ≥ ‚Ä¢ Á∏ÆÊîæ</div>
                </div>
            );
        };

        // 5. Category Manager Component
        const CategoryManager = ({ categories, type, onEdit, onDelete, onAdd }) => {
            const [editId, setEditId] = useState(null);
            const [tempName, setTempName] = useState("");

            const filtered = categories.filter(c => c.type === type);

            const startEdit = (c) => {
                setEditId(c.id);
                setTempName(c.name);
            };

            const saveEdit = () => {
                if (tempName.trim()) {
                    onEdit({ id: editId, name: tempName });
                    setEditId(null);
                }
            };

            return (
                <div className="flex flex-col gap-4">
                    <div className="space-y-2 max-h-60 overflow-y-auto">
                        {filtered.map(c => (
                            <div key={c.id} className="flex items-center justify-between bg-ios-bg p-3 rounded-xl border border-white">
                                {editId === c.id ? (
                                    <div className="flex items-center gap-2 flex-1">
                                        <input 
                                            className="bg-white border border-ios-blue rounded px-2 py-1 flex-1 text-sm outline-none text-gray-700"
                                            value={tempName}
                                            onChange={e => setTempName(e.target.value)}
                                            autoFocus
                                        />
                                        <button onClick={saveEdit} className="text-ios-green px-2"><i className={Icons.Check}></i></button>
                                        <button onClick={() => setEditId(null)} className="text-gray-400 px-2"><i className={Icons.Xmark}></i></button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex items-center gap-2">
                                            <div className={`w-3 h-3 rounded-full bg-${c.color}-500 shadow-sm`}></div>
                                            <span className="font-bold text-gray-700">{c.name}</span>
                                        </div>
                                        <div className="flex gap-1">
                                            <button onClick={() => startEdit(c)} className="text-ios-blue w-8 h-8 rounded-full hover:bg-white transition"><i className={Icons.Edit}></i></button>
                                            <button onClick={() => onDelete(c.id)} className="text-ios-red w-8 h-8 rounded-full hover:bg-white transition"><i className={Icons.Trash}></i></button>
                                        </div>
                                    </>
                                )}
                            </div>
                        ))}
                        {filtered.length === 0 && <div className="text-center text-gray-400 text-sm py-4">Â∞öÁÑ°ÂàÜÈ°û</div>}
                    </div>
                    <div className="border-t pt-4">
                        <h4 className="font-bold text-gray-600 mb-2 text-sm">Êñ∞Â¢ûÂàÜÈ°û</h4>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            if (e.target.name.value.trim()) {
                                onAdd({ name: e.target.name.value, type: type, color: 'blue' });
                                e.target.reset();
                            }
                        }} className="flex gap-2">
                            <input name="name" placeholder="ÂêçÁ®±" required className="bg-ios-bg p-2 rounded-lg flex-1 text-sm outline-none focus:ring-2 focus:ring-ios-blue" />
                            <button className="bg-ios-indigo text-white px-4 rounded-lg font-bold text-sm shadow-md active:scale-95 transition">Êñ∞Â¢û</button>
                        </form>
                    </div>
                </div>
            );
        };

        // 6. Child Form Modal
        const ChildModal = ({ isOpen, onClose, type, data, onSave }) => {
            const isEdit = type === 'edit_child';
            const [currentAvatar, setCurrentAvatar] = useState(isEdit ? data.avatar : 'üë∂');
            const [avatarType, setAvatarType] = useState(isEdit && data.avatar.startsWith('data:image') ? 'image' : 'emoji');
            
            const handleCropUpdate = useCallback((base64) => { setCurrentAvatar(base64); }, []);

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={isEdit ? "Á∑®ËºØÂ∞èÂ≠©" : "Êñ∞Â¢ûÂ∞èÂ≠©"}>
                    <form onSubmit={(e) => {
                        e.preventDefault();
                        onSave({ id: isEdit ? data.id : undefined, name: e.target.name.value, avatar: currentAvatar });
                    }} className="flex flex-col gap-4">
                        <input name="name" placeholder="ÂêçÂ≠ó" defaultValue={isEdit ? data.name : ''} required className="bg-ios-bg p-3 rounded-xl w-full text-gray-700 font-bold text-lg text-center focus:ring-2 focus:ring-ios-blue outline-none border border-white" />
                        <div className="bg-ios-bg p-4 rounded-xl border border-white">
                            <div className="flex gap-2 mb-4">
                                <button type="button" onClick={() => setAvatarType('emoji')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${avatarType === 'emoji' ? 'bg-white shadow text-ios-blue' : 'text-gray-400'}`}>Ë°®ÊÉÖ</button>
                                <button type="button" onClick={() => setAvatarType('image')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${avatarType === 'image' ? 'bg-white shadow text-ios-blue' : 'text-gray-400'}`}>ÁÖßÁâá</button>
                            </div>
                            {avatarType === 'emoji' ? (
                                <div className="grid grid-cols-5 gap-2">
                                    {['üë¶', 'üëß', 'üë∂', 'üßë‚ÄçüöÄ', 'ü¶Ñ', 'üê±', 'üê∂', 'ü¶ä', 'ü¶Å', 'üê∏'].map(emoji => (
                                        <div key={emoji} onClick={() => setCurrentAvatar(emoji)} className={`text-2xl p-2 rounded-lg text-center cursor-pointer transition ${currentAvatar === emoji ? 'bg-white shadow-md scale-110' : 'hover:bg-white/50'}`}>{emoji}</div>
                                    ))}
                                </div>
                            ) : (<GestureCropper onImageReady={handleCropUpdate} />)}
                        </div>
                        <button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition">{isEdit ? 'ÂÑ≤Â≠ò‰øÆÊîπ' : 'Êñ∞Â¢û'}</button>
                    </form>
                </Modal>
            );
        };

        // --- Main App ---
        const App = () => {
            const [mode, setMode] = useState('landing');
            const [data, setData] = useState(INITIAL_DATA);
            const [sha, setSha] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle');
            const [toast, setToast] = useState(null);
            // Default Token handling
            const [ghToken, setGhToken] = useState(() => {
                const stored = localStorage.getItem('gh_token');
                if (stored) return stored;
                return DEFAULT_TOKEN_SUFFIX ? 'ghp_' + DEFAULT_TOKEN_SUFFIX : '';
            });
            const [currentChild, setCurrentChild] = useState(null);
            
            // Parent State
            const [parentPass, setParentPass] = useState(localStorage.getItem('parent_pass') || '0000');
            const [tempParentPass, setTempParentPass] = useState(localStorage.getItem('parent_pass') || '0000');
            const [parentTab, setParentTab] = useState('approvals');
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [parentFilterCat, setParentFilterCat] = useState('all'); // Category Filter
            
            // Child State
            const [childTab, setChildTab] = useState('tasks');
            const [historyFilter, setHistoryFilter] = useState('week');
            const [childFilterCat, setChildFilterCat] = useState('all'); // Category Filter

            // UI State
            const [showParentPass, setShowParentPass] = useState(false);
            const [showToken, setShowToken] = useState(false);
            const [modalConfig, setModalConfig] = useState({ open: false, type: '', data: null });

            const showToast = (msg, type = 'success') => setToast({ message: msg, type });

            useEffect(() => { if (ghToken) fetchData(ghToken); }, []);

            const fetchData = async (token = ghToken) => {
                if (!token) return;
                setSyncStatus('syncing');
                try {
                    const result = await githubApi.getData(token);
                    if (result) {
                        setData(result.content);
                        setSha(result.sha);
                        setSyncStatus('success');
                    }
                } catch (e) {
                    setSyncStatus('error');
                    if (mode !== 'landing') {
                         e.message.includes('401') ? showToast("Token ÁÑ°Êïà", 'error') : showToast("Èõ¢Á∑öÊ®°Âºè", 'warning');
                    }
                }
            };

            const saveData = async (newData) => {
                setData(newData); // Optimistic
                if (!ghToken) return;
                setSyncStatus('syncing');
                try {
                    const fresh = await githubApi.getData(ghToken);
                    const res = await githubApi.saveData(ghToken, newData, fresh ? fresh.sha : null);
                    setSha(res.content.sha);
                    setSyncStatus('success');
                } catch (e) {
                    setSyncStatus('error');
                    showToast("ÂêåÊ≠•Â§±Êïó (Â∑≤Â≠òÊú¨Ê©ü)", 'warning');
                }
            };

            const handleModeChange = (newMode) => {
                if ((newMode === 'parent' || newMode === 'child_select') && ghToken) {
                    fetchData(ghToken);
                }
                setMode(newMode);
            };

            const handleAction = async (actionType, payload) => {
                let newData = JSON.parse(JSON.stringify(data));
                const timestamp = Date.now();
                newData.categories = newData.categories || INITIAL_DATA.categories;

                if (actionType === 'ADD_CHILD') {
                    newData.children.push({ id: timestamp, name: payload.name, points: 0, avatar: payload.avatar });
                    showToast("Êñ∞Â¢ûÊàêÂäü");
                } 
                else if (actionType === 'EDIT_CHILD') {
                    const idx = newData.children.findIndex(c => c.id === payload.id);
                    if (idx !== -1) newData.children[idx] = { ...newData.children[idx], ...payload };
                    showToast("‰øÆÊîπÊàêÂäü");
                }
                else if (actionType === 'ADD_CATEGORY') {
                    newData.categories.push({ id: `cat_${timestamp}`, ...payload });
                    showToast("ÂàÜÈ°ûÊñ∞Â¢ûÊàêÂäü");
                }
                else if (actionType === 'EDIT_CATEGORY') {
                    const idx = newData.categories.findIndex(c => c.id === payload.id);
                    if (idx !== -1) newData.categories[idx] = { ...newData.categories[idx], ...payload };
                    showToast("ÂàÜÈ°û‰øÆÊîπÊàêÂäü");
                }
                else if (actionType === 'DELETE_CATEGORY') {
                    newData.categories = newData.categories.filter(c => c.id !== payload.id);
                    // Optional: Reset categoryId in tasks/rewards using this category
                    newData.tasks.forEach(t => { if(t.categoryId === payload.id) t.categoryId = ''; });
                    newData.rewards.forEach(r => { if(r.categoryId === payload.id) r.categoryId = ''; });
                    showToast("ÂàÜÈ°ûÂà™Èô§ÊàêÂäü");
                }
                else if (actionType === 'ADD_TASK' || actionType === 'ADD_REWARD') {
                    const collection = actionType === 'ADD_TASK' ? 'tasks' : 'rewards';
                    const { id, ...itemData } = payload;
                    newData[collection].push({ id: timestamp, ...itemData });
                    showToast("Êñ∞Â¢ûÊàêÂäü");
                }
                else if (actionType === 'EDIT_TASK' || actionType === 'EDIT_REWARD') {
                    const collection = actionType === 'EDIT_TASK' ? 'tasks' : 'rewards';
                    const idx = newData[collection].findIndex(i => i.id === payload.id);
                    if (idx !== -1) newData[collection][idx] = { ...newData[collection][idx], ...payload };
                    showToast("‰øÆÊîπÊàêÂäü");
                }
                else if (actionType === 'DELETE_ITEM') {
                    if(newData[payload.collection]) {
                        newData[payload.collection] = newData[payload.collection].filter(i => i.id !== payload.id);
                        showToast("Âà™Èô§ÊàêÂäü");
                    }
                }
                else if (actionType === 'REQUEST_TASK') {
                    newData.history.unshift({
                        id: timestamp,
                        type: 'task_pending',
                        childId: currentChild.id,
                        itemId: payload.id,
                        itemName: payload.title,
                        points: payload.points,
                        timestamp: timestamp,
                        status: 'pending'
                    });
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    showToast("‰ªªÂãôÊèê‰∫§ÔºÅ");
                }
                else if (actionType === 'REQUEST_REDEEM') {
                    const totalPoints = payload.totalPoints;
                    if (currentChild.points < totalPoints) {
                        showToast("ÈªûÊï∏‰∏çÂ§†Âñî", 'error');
                        return;
                    }
                    const itemName = payload.quantity > 1 ? `${payload.title} x${payload.quantity}` : payload.title;
                    newData.history.unshift({
                        id: timestamp,
                        type: 'redeem_pending',
                        childId: currentChild.id,
                        itemId: payload.id,
                        itemName: itemName,
                        points: totalPoints,
                        timestamp: timestamp,
                        status: 'pending'
                    });
                    showToast("Áî≥Ë´ãÂ∑≤ÈÄÅÂá∫");
                }
                else if (actionType === 'APPROVE') {
                    const historyIdx = newData.history.findIndex(h => h.id === payload.id);
                    const item = newData.history[historyIdx];
                    const childIdx = newData.children.findIndex(c => c.id === item.childId);
                    
                    if (item.type === 'task_pending') {
                        newData.children[childIdx].points += parseInt(item.points);
                        item.status = 'approved';
                    } else {
                        if (newData.children[childIdx].points >= parseInt(item.points)) {
                            newData.children[childIdx].points -= parseInt(item.points);
                            item.status = 'approved';
                        } else {
                            showToast("ÈªûÊï∏‰∏çË∂≥", 'error');
                            return;
                        }
                    }
                    showToast("Â∑≤Ê†∏ÂáÜ");
                }
                else if (actionType === 'REJECT') {
                    const idx = newData.history.findIndex(h => h.id === payload.id);
                    newData.history[idx].status = 'rejected';
                    showToast("Â∑≤ÈßÅÂõû");
                }
                else if (actionType === 'MANUAL_ADJUST') {
                    const childIdx = newData.children.findIndex(c => c.id === parseInt(payload.childId));
                    const pts = parseInt(payload.points);
                    newData.children[childIdx].points += pts;
                    newData.history.unshift({
                        id: timestamp,
                        type: 'manual',
                        childId: parseInt(payload.childId),
                        itemName: payload.reason,
                        points: pts,
                        timestamp: timestamp,
                        status: 'approved'
                    });
                    showToast("Ë™øÊï¥ÊàêÂäü");
                }

                await saveData(newData);
            };

            const SyncIcon = () => (
                <div className="fixed top-4 right-4 z-50 flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-full glass flex items-center justify-center shadow-sm transition-all ${syncStatus === 'syncing' ? 'animate-spin text-ios-blue' : syncStatus === 'success' ? 'text-ios-green' : syncStatus === 'error' ? 'text-ios-red' : 'text-gray-400'}`}>
                        <i className={Icons.Sync}></i>
                    </div>
                </div>
            );

            const sortItems = (items) => {
                return items.sort((a, b) => {
                    if (a.categoryId !== b.categoryId) {
                        return (a.categoryId || '').localeCompare(b.categoryId || '');
                    }
                    return a.points - b.points;
                });
            };

            if (mode === 'landing') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden bg-ios-bg">
                        {/* Cute Background Elements */}
                        <div className="absolute top-20 right-10 text-6xl opacity-80 animate-float" style={{ animationDuration: '4s' }}>‚òÅÔ∏è</div>
                        <div className="absolute bottom-20 left-10 text-5xl opacity-60 animate-float" style={{ animationDuration: '6s', animationDelay: '1s' }}>üéà</div>
                        <div className="absolute top-40 left-20 text-4xl opacity-50 animate-bounce">‚ú®</div>
                        
                        <h1 className="text-4xl font-bold text-gray-700 mb-2 tracking-tight text-center">Â•ΩÂØ∂ÂØ∂ÈªûÊï∏Â≠òÊë∫</h1>
                        
                        <div className="flex justify-center gap-4 mt-2 mb-12 text-3xl">
                            <i className="fa-solid fa-star text-ios-yellow animate-spin-slow"></i>
                            <span className="animate-bounce">üß∏</span>
                            <i className="fa-solid fa-heart text-ios-pink animate-pulse"></i>
                        </div>

                        <div className="flex flex-col gap-4 w-full max-w-xs">
                            <button onClick={() => handleModeChange('child_select')} className="bg-ios-blue text-white py-4 px-6 rounded-2xl shadow-ios-lg text-lg font-bold flex items-center justify-center gap-3 active:scale-95 transition hover:shadow-xl"><i className={Icons.Child}></i> Â∞èÂ≠©Â∞àÂçÄ</button>
                            <button onClick={() => setModalConfig({ open: true, type: 'parent_login' })} className="bg-white text-ios-indigo py-4 px-6 rounded-2xl shadow-ios text-lg font-bold flex items-center justify-center gap-3 active:scale-95 transition hover:bg-ios-bg border border-white"><i className={Icons.Parent}></i> ÂÆ∂Èï∑Â∞àÂçÄ</button>
                        </div>
                        <Modal isOpen={modalConfig.open && modalConfig.type === 'parent_login'} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="ÂÆ∂Èï∑ÁôªÂÖ•">
                            <div className="flex flex-col gap-4">
                                <input type="password" id="p_pass" className="w-full p-4 bg-ios-bg rounded-xl text-center text-2xl tracking-widest outline-none border border-white focus:ring-2 focus:ring-ios-indigo" placeholder="‚óè‚óè‚óè‚óè" maxLength="8" onKeyDown={(e) => e.key === 'Enter' && document.getElementById('login_btn').click()} />
                                <button id="login_btn" onClick={() => {
                                    if (document.getElementById('p_pass').value === parentPass) {
                                        setModalConfig({ ...modalConfig, open: false });
                                        handleModeChange('parent');
                                    } else showToast("ÂØÜÁ¢ºÈåØË™§", 'error');
                                }} className="bg-ios-indigo text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition">ÁôªÂÖ•</button>
                            </div>
                        </Modal>
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            if (mode === 'child_select') {
                return (
                    <div className="min-h-screen p-6 flex flex-col items-center bg-ios-bg">
                        <button onClick={() => setMode('landing')} className="self-start mb-8 text-gray-500 hover:text-ios-blue transition"><i className={Icons.ChevronLeft}></i> ËøîÂõû</button>
                        <h2 className="text-3xl font-bold text-gray-700 mb-8">‰Ω†ÊòØË™∞Âë¢Ôºü</h2>
                        <div className="flex flex-wrap justify-center gap-6 w-full max-w-2xl px-4">
                            {data.children.map(child => (
                                <button key={child.id} onClick={() => { setCurrentChild(child); setMode('child_dashboard'); }} className="bg-white p-6 rounded-3xl shadow-ios flex flex-col items-center gap-4 hover:-translate-y-2 transition w-40 border border-white">
                                    <Avatar avatar={child.avatar} size="lg" />
                                    <span className="text-xl font-bold text-gray-700">{child.name}</span>
                                    <span className="bg-ios-yellow/30 text-ios-orange px-4 py-1 rounded-full text-sm font-bold shadow-sm">{child.points} Èªû</span>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (mode === 'child_dashboard' && currentChild) {
                const liveChild = data.children.find(c => c.id === currentChild.id) || currentChild;
                const activeCollection = childTab === 'tasks' ? data.tasks : data.rewards;
                const typeFilter = childTab === 'tasks' ? 'task' : 'reward';
                
                // Filter Items
                let items = activeCollection.filter(i => i.assignee === 'all' || parseInt(i.assignee) === liveChild.id);
                if (childFilterCat !== 'all') {
                    items = items.filter(i => i.categoryId === childFilterCat);
                }
                const filteredItems = sortItems(items);
                
                // History Filter Logic
                const now = new Date();
                const oneDay = 24*60*60*1000;
                let filteredHistory = data.history.filter(h => h.childId === liveChild.id);
                
                if (historyFilter === 'week') {
                    filteredHistory = filteredHistory.filter(h => (now - h.timestamp) < 7 * oneDay);
                } else if (historyFilter === 'prev_week') {
                    filteredHistory = filteredHistory.filter(h => (now - h.timestamp) >= 7 * oneDay && (now - h.timestamp) < 14 * oneDay);
                } else if (historyFilter === 'month') {
                    filteredHistory = filteredHistory.filter(h => (now - h.timestamp) < 30 * oneDay);
                }

                const availableCats = data.categories.filter(c => c.type === typeFilter);

                return (
                    <div className="min-h-screen bg-ios-bg pb-24">
                        <SyncIcon />
                        {/* Header */}
                        <div className="bg-white px-6 pt-8 pb-6 rounded-b-[40px] shadow-ios sticky top-0 z-20">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => setMode('child_select')} className="w-10 h-10 bg-ios-bg rounded-full text-gray-500 hover:text-ios-blue transition"><i className={Icons.ChevronLeft}></i></button>
                                <span className="font-bold text-lg text-gray-600">{liveChild.name}ÁöÑÈªûÊï∏Â≠òÊë∫</span>
                                <button onClick={() => setModalConfig({open: true, type: 'edit_child', data: liveChild})} className="w-10 h-10 bg-ios-bg rounded-full text-ios-blue hover:bg-ios-blue hover:text-white transition"><i className={Icons.Edit}></i></button>
                            </div>
                            <div className="flex flex-col items-center">
                                <Avatar avatar={liveChild.avatar} size="xl" className="mb-2" />
                                <div className="text-6xl font-black text-ios-blue tracking-tighter flex items-center gap-3 drop-shadow-sm"><i className={`${Icons.Coins} text-4xl text-ios-yellow`}></i>{liveChild.points}</div>
                            </div>
                            {/* Tabs */}
                            <div className="flex mt-6 bg-ios-bg p-1.5 rounded-2xl shadow-inner">
                                {[{id:'tasks', label:'Ë≥∫ÈªûÊï∏', icon:Icons.Task}, {id:'rewards', label:'ÊèõÁçéÂìÅ', icon:Icons.Reward}, {id:'history', label:'Á¥ÄÈåÑ', icon:Icons.History}].map(t => (
                                    <button key={t.id} onClick={() => {setChildTab(t.id); setChildFilterCat('all');}} className={`flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition ${childTab === t.id ? 'bg-white shadow text-gray-800' : 'text-gray-400 hover:text-gray-600'}`}>
                                        <i className={t.icon}></i> {t.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-6">
                            {(childTab === 'tasks' || childTab === 'rewards') && (
                                <>
                                    <div className="flex gap-2 overflow-x-auto hide-scrollbar mb-4 pb-2">
                                        <button onClick={() => setChildFilterCat('all')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${childFilterCat === 'all' ? 'bg-ios-indigo text-white' : 'bg-white text-gray-500 hover:bg-white/80'}`}>ÂÖ®ÈÉ®</button>
                                        {availableCats.map(c => (
                                            <button key={c.id} onClick={() => setChildFilterCat(c.id)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${childFilterCat === c.id ? `bg-${c.color}-500 text-white` : 'bg-white text-gray-500 hover:bg-white/80'}`}>
                                                {c.name}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                        {filteredItems.map(item => {
                                            const cat = data.categories.find(c => c.id === item.categoryId);
                                            const canAfford = childTab === 'rewards' ? liveChild.points >= item.points : true;
                                            
                                            return (
                                                <div 
                                                    key={item.id} 
                                                    onClick={() => {
                                                        if (childTab === 'tasks') {
                                                            if(confirm(`ÂÆåÊàê "${item.title}"?`)) handleAction('REQUEST_TASK', item);
                                                        } else {
                                                            if (canAfford) {
                                                                if (item.isRepeatable) {
                                                                    setModalConfig({ open: true, type: 'redeem_repeatable', data: item });
                                                                } else {
                                                                    setModalConfig({ open: true, type: 'redeem_confirm', data: item });
                                                                }
                                                            }
                                                        }
                                                    }} 
                                                    className={`bg-white p-4 rounded-3xl shadow-ios active:scale-95 transition cursor-pointer relative overflow-hidden flex flex-col items-center text-center gap-3 border-2 border-white hover:border-ios-blue/30 ${!canAfford ? 'opacity-60 grayscale' : ''}`}
                                                >
                                                    {cat && <div className={`absolute top-0 right-0 w-4 h-4 rounded-bl-xl bg-${cat.color}-500 shadow-sm`}></div>}
                                                    <span className="font-bold text-gray-700 text-lg leading-tight mt-2">{item.title}</span>
                                                    <span className={`px-4 py-1 rounded-full font-bold text-sm shadow-sm ${childTab === 'tasks' ? 'bg-ios-blue text-white' : 'bg-ios-pink text-white'}`}>
                                                        {childTab === 'tasks' ? '+' : '-'}{item.points}
                                                    </span>
                                                    {item.isRepeatable && childTab === 'rewards' && <span className="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full absolute top-2 right-2 border border-gray-200">ÂèØÁ¥ØË®à</span>}
                                                </div>
                                            )
                                        })}
                                        {filteredItems.length === 0 && (
                                            <div className="col-span-full text-center py-16 text-gray-400 flex flex-col items-center gap-2">
                                                <i className="fa-regular fa-folder-open text-4xl opacity-50"></i>
                                                <p>ÈÄôË£°Á©∫Á©∫ÁöÑÂñîÔºÅ</p>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}

                            {childTab === 'history' && (
                                <div>
                                    <div className="flex justify-end mb-4 overflow-x-auto hide-scrollbar">
                                        <div className="bg-white rounded-xl shadow-sm p-1.5 flex gap-1">
                                            {[{id:'week', l:'Êú¨ÈÄ±'}, {id:'prev_week', l:'‰∏äÈÄ±'}, {id:'month', l:'Ëøë30Â§©'}, {id:'all', l:'ÂÖ®ÈÉ®'}].map(f => (
                                                <button key={f.id} onClick={() => setHistoryFilter(f.id)} className={`px-3 py-1.5 text-xs rounded-lg whitespace-nowrap transition ${historyFilter === f.id ? 'bg-ios-bg font-bold text-ios-indigo' : 'text-gray-400 hover:text-gray-600'}`}>{f.l}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-3xl shadow-ios overflow-hidden border border-white">
                                        {filteredHistory.map((h, i) => (
                                            <div key={i} className="p-4 border-b border-gray-50 last:border-0 flex justify-between items-center hover:bg-gray-50 transition">
                                                <div>
                                                    <div className="font-bold text-gray-700 text-lg">{h.itemName}</div>
                                                    <div className="text-xs text-gray-400 mt-0.5">
                                                        {new Date(h.timestamp).toLocaleDateString()}
                                                        <span className={`ml-2 font-bold px-2 py-0.5 rounded text-[10px] ${h.status === 'pending' ? 'bg-ios-orange/10 text-ios-orange' : h.status === 'approved' ? 'bg-ios-green/10 text-ios-green' : 'bg-ios-red/10 text-ios-red'}`}>
                                                            {h.status === 'pending' ? 'ÂØ©Ê†∏‰∏≠' : h.status === 'approved' ? 'ÂÆåÊàê' : 'ÈÄÄÂõû'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className={`font-bold text-xl ${h.points > 0 ? 'text-ios-blue' : 'text-ios-pink'}`}>{h.points > 0 ? '+' : '-'}{Math.abs(h.points)}</div>
                                            </div>
                                        ))}
                                        {filteredHistory.length === 0 && (
                                            <div className="p-10 text-center text-gray-400 flex flex-col items-center gap-2">
                                                <i className="fa-regular fa-clock text-3xl opacity-50"></i>
                                                <p>Ê≤íÊúâÁ¥ÄÈåÑ</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {(modalConfig.type === 'edit_child') && <ChildModal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} type="edit_child" data={modalConfig.data} onSave={payload => { handleAction('EDIT_CHILD', payload); setModalConfig({ ...modalConfig, open: false }); }} />}
                        
                        {/* Redeem Confirm Modal (Single) */}
                        {modalConfig.type === 'redeem_confirm' && (
                            <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="Á¢∫Ë™çÂÖåÊèõ">
                                <div className="flex flex-col items-center gap-4 text-center p-2">
                                    <div className="text-5xl animate-bounce">üéÅ</div>
                                    <p className="text-gray-600 text-lg">Á¢∫ÂÆöË¶ÅÂÖåÊèõ <br/><span className="text-xl font-bold text-ios-indigo">{modalConfig.data.title}</span> ÂóéÔºü</p>
                                    <div className="bg-ios-pink/10 text-ios-pink px-4 py-2 rounded-xl font-bold text-2xl">-{modalConfig.data.points} Èªû</div>
                                    <div className="flex gap-3 w-full mt-4">
                                        <button onClick={() => setModalConfig({ ...modalConfig, open: false })} className="flex-1 py-3 rounded-xl border-2 border-gray-100 font-bold text-gray-500 hover:bg-gray-50">ÂÜçÊÉ≥ÊÉ≥</button>
                                        <button onClick={() => {
                                            handleAction('REQUEST_REDEEM', { ...modalConfig.data, quantity: 1, totalPoints: modalConfig.data.points });
                                            setModalConfig({ ...modalConfig, open: false });
                                        }} className="flex-1 py-3 rounded-xl bg-ios-pink text-white font-bold shadow-lg active:scale-95 transition">Á¢∫ÂÆöÂÖåÊèõ</button>
                                    </div>
                                </div>
                            </Modal>
                        )}

                        {/* Redeem Repeatable Modal */}
                        {modalConfig.type === 'redeem_repeatable' && (
                            <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="ÂÖåÊèõÊï∏Èáè">
                                {(() => {
                                    const [qty, setQty] = useState(1);
                                    const unitPoints = modalConfig.data.points;
                                    const totalPoints = qty * unitPoints;
                                    const maxQty = Math.floor(currentChild.points / unitPoints);

                                    return (
                                        <div className="flex flex-col gap-6 p-2">
                                            <div className="text-center">
                                                <div className="font-bold text-2xl text-gray-800">{modalConfig.data.title}</div>
                                                <div className="text-gray-400 font-medium">ÂñÆÂÉπ: {unitPoints} Èªû</div>
                                            </div>
                                            
                                            <div className="flex items-center justify-center gap-6 bg-ios-bg p-4 rounded-2xl">
                                                <button onClick={() => setQty(Math.max(1, qty - 1))} className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold transition ${qty <= 1 ? 'bg-gray-200 text-gray-400' : 'bg-white text-gray-600 shadow-sm'}`} disabled={qty <= 1}><i className={Icons.Minus}></i></button>
                                                <div className="text-4xl font-black w-16 text-center text-ios-indigo">{qty}</div>
                                                <button onClick={() => setQty(Math.min(maxQty, qty + 1))} className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold transition ${qty >= maxQty ? 'bg-gray-200 text-gray-400' : 'bg-white text-gray-600 shadow-sm'}`} disabled={qty >= maxQty}><i className={Icons.Plus}></i></button>
                                            </div>

                                            <div className="text-center">
                                                <div className="text-ios-pink font-bold text-3xl">-{totalPoints} Èªû</div>
                                                <div className="text-sm text-gray-400 mt-1 font-bold">ÊìÅÊúâ: {currentChild.points} Èªû</div>
                                            </div>

                                            <button onClick={() => {
                                                handleAction('REQUEST_REDEEM', { ...modalConfig.data, quantity: qty, totalPoints: totalPoints });
                                                setModalConfig({ ...modalConfig, open: false });
                                            }} className="w-full py-4 rounded-xl bg-ios-pink text-white font-bold shadow-lg text-lg active:scale-95 transition">Á¢∫Ë™çÂÖåÊèõ</button>
                                        </div>
                                    );
                                })()}
                            </Modal>
                        )}

                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            // Parent Dashboard
            if (mode === 'parent') {
                const pendingItems = data.history.filter(h => h.status === 'pending');
                const categories = data.categories || [];
                
                const activeCollection = parentTab === 'tasks' ? data.tasks : (parentTab === 'rewards' ? data.rewards : []);
                const typeFilter = parentTab === 'tasks' ? 'task' : 'reward';
                
                let filteredParentItems = activeCollection;
                if (parentFilterCat !== 'all') {
                    filteredParentItems = filteredParentItems.filter(i => i.categoryId === parentFilterCat);
                }
                const availableCats = categories.filter(c => c.type === typeFilter);

                return (
                    <div className="min-h-screen bg-gray-50 flex">
                        <SyncIcon />
                        {/* Sidebar */}
                        <div className={`sidebar-transition fixed bottom-0 left-0 top-0 z-30 bg-white border-r border-gray-200 flex flex-col shadow-lg md:relative ${isSidebarCollapsed ? 'w-20' : 'w-48'}`}>
                            <button onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)} className={`w-8 h-8 flex items-center justify-center bg-white text-gray-400 hover:text-gray-600 border border-gray-200 rounded-full shadow-sm transition-all z-50 ${isSidebarCollapsed ? 'mx-auto mt-6 mb-2' : 'absolute top-6 -right-4'}`}><i className={`text-xs ${isSidebarCollapsed ? Icons.ChevronRight : Icons.ChevronLeft}`}></i></button>
                            <div className="flex-1 flex flex-col gap-2 p-3 overflow-y-auto mt-2">
                                {['approvals', 'tasks', 'rewards', 'children', 'settings'].map(tab => (
                                    <button key={tab} onClick={() => {setParentTab(tab); setParentFilterCat('all');}} className={`p-3 rounded-xl flex items-center transition relative ${parentTab === tab ? 'text-ios-indigo bg-ios-indigo/10 font-bold' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'} ${isSidebarCollapsed ? 'justify-center' : 'justify-start gap-3'}`}>
                                        <i className={`text-xl w-6 text-center ${tab === 'approvals' ? Icons.Check : tab === 'tasks' ? Icons.Task : tab === 'rewards' ? Icons.Reward : tab === 'children' ? Icons.Child : Icons.Settings}`}></i>
                                        {!isSidebarCollapsed && <span className="text-base font-medium capitalize">{tab === 'approvals' ? 'ÂæÖÂØ©Ê†∏' : tab === 'tasks' ? '‰ªªÂãô' : tab === 'rewards' ? 'ÁçéÂãµ' : tab === 'children' ? 'Â∞èÂ≠©' : 'Ë®≠ÂÆö'}</span>}
                                        {tab === 'approvals' && pendingItems.length > 0 && <span className="bg-ios-red text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center absolute top-2 right-2 shadow-sm font-bold">{pendingItems.length}</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="p-3 border-t">
                                <button onClick={() => setMode('landing')} className={`flex items-center text-gray-400 hover:text-ios-red p-3 rounded-xl transition ${isSidebarCollapsed ? 'justify-center' : 'justify-start gap-4'}`}><i className={`w-6 text-center ${Icons.Exit}`}></i>{!isSidebarCollapsed && <span className="font-medium">ÈÄÄÂá∫</span>}</button>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="flex-1 p-6 pb-24 md:pb-6 overflow-y-auto h-screen ml-20 md:ml-0">
                            <h1 className="text-2xl font-bold text-gray-800 mb-6 capitalize">{parentTab === 'approvals' ? 'ÂØ©Ê†∏Áî≥Ë´ã' : parentTab === 'tasks' ? '‰ªªÂãôÁÆ°ÁêÜ' : parentTab === 'rewards' ? 'ÁçéÂãµÁÆ°ÁêÜ' : parentTab === 'children' ? 'Â∞èÂ≠©ÁÆ°ÁêÜ' : 'Á≥ªÁµ±Ë®≠ÂÆö'}</h1>
                            
                            {parentTab === 'approvals' && (
                                <div className="space-y-4">
                                    {pendingItems.map(item => {
                                        const child = data.children.find(c => c.id === item.childId);
                                        return (
                                            <div key={item.id} className="bg-white p-6 rounded-3xl shadow-ios flex flex-col sm:flex-row justify-between items-center gap-6 border border-white">
                                                <div className="flex items-center gap-6 w-full sm:w-auto">
                                                    <Avatar avatar={child?.avatar} size="lg" />
                                                    <div>
                                                        <div className="font-bold text-gray-800 text-xl">{child?.name} <span className="text-gray-400 font-normal text-base">Áî≥Ë´ã</span></div>
                                                        <div className="text-ios-indigo font-bold text-lg mt-1">{item.itemName} <span className="text-gray-500 text-base font-normal">({item.points} Èªû)</span></div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-3 w-full sm:w-auto">
                                                    <button onClick={() => handleAction('REJECT', item)} className="flex-1 py-3 px-8 rounded-xl border-2 border-gray-100 text-gray-500 font-bold hover:bg-gray-50">ÈßÅÂõû</button>
                                                    <button onClick={() => handleAction('APPROVE', item)} className="flex-1 py-3 px-8 rounded-xl bg-ios-indigo text-white font-bold shadow-lg hover:opacity-90">ÊâπÂáÜ</button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                    {pendingItems.length === 0 && (
                                        <div className="text-center py-32 text-gray-400 flex flex-col items-center gap-4">
                                            <i className="fa-regular fa-face-smile text-6xl opacity-30"></i>
                                            <p className="text-lg">ÁõÆÂâçÊ≤íÊúâÂæÖÂØ©Ê†∏È†ÖÁõÆÔºåÂ§™Ê£í‰∫ÜÔºÅ</p>
                                        </div>
                                    )}
                                    <div className="mt-8 border-t pt-8">
                                        <button onClick={() => setModalConfig({ open: true, type: 'manual_adjust' })} className="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 p-4 rounded-2xl font-bold hover:border-ios-indigo hover:text-ios-indigo hover:bg-ios-bg transition">+ ÊâãÂãïÁçéÊá≤ (Âä†/Êâ£Èªû)</button>
                                    </div>
                                </div>
                            )}

                            {(parentTab === 'tasks' || parentTab === 'rewards') && (
                                <div>
                                    <div className="flex flex-wrap gap-3 mb-6">
                                        <button onClick={() => setModalConfig({ open: true, type: parentTab === 'tasks' ? 'add_task' : 'add_reward' })} className="flex-1 bg-ios-indigo text-white p-4 rounded-2xl shadow-ios font-bold flex items-center justify-center gap-2 min-w-[150px] hover:opacity-90 transition"><i className={Icons.Plus}></i> Êñ∞Â¢û{parentTab === 'tasks' ? '‰ªªÂãô' : 'ÁçéÂãµ'}</button>
                                        <button onClick={() => setModalConfig({ open: true, type: 'manage_categories', categoryType: typeFilter })} className="px-6 bg-white text-gray-600 rounded-2xl shadow-sm border border-gray-200 font-bold hover:bg-gray-50"><i className={Icons.Filter}></i> ÁÆ°ÁêÜÂàÜÈ°û</button>
                                    </div>
                                    
                                    {/* Parent Category Filter */}
                                    <div className="flex gap-2 overflow-x-auto hide-scrollbar mb-6 pb-2">
                                        <button onClick={() => setParentFilterCat('all')} className={`px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${parentFilterCat === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-500 hover:bg-white/80'}`}>ÂÖ®ÈÉ®</button>
                                        {availableCats.map(c => (
                                            <button key={c.id} onClick={() => setParentFilterCat(c.id)} className={`px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${parentFilterCat === c.id ? `bg-${c.color}-500 text-white` : 'bg-white text-gray-500 hover:bg-white/80'}`}>
                                                {c.name}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {sortItems(filteredParentItems).map(item => {
                                            const cat = categories.find(c => c.id === item.categoryId);
                                            return (
                                                <div key={item.id} className="bg-white p-5 rounded-3xl shadow-sm relative group border border-gray-100 hover:shadow-md transition">
                                                    {cat && <span className={`absolute top-3 right-3 text-[10px] px-2 py-0.5 rounded-full text-white font-bold bg-${cat.color}-500`}>{cat.name}</span>}
                                                    <div className="font-bold text-gray-800 text-xl mb-1">{item.title}</div>
                                                    <div className="text-sm text-gray-500 flex items-center gap-2">
                                                        <span className={`font-bold px-2 py-0.5 rounded-md ${parentTab === 'tasks' ? 'bg-ios-blue/10 text-ios-blue' : 'bg-ios-pink/10 text-ios-pink'}`}>{item.points} Èªû</span>
                                                        {item.isRepeatable && <span className="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">ÂèØÁ¥ØË®à</span>}
                                                    </div>
                                                    <div className="mt-4 flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition pt-2 border-t border-gray-50">
                                                        <button onClick={() => setModalConfig({ open: true, type: parentTab === 'tasks' ? 'edit_task' : 'edit_reward', data: item })} className="text-gray-400 hover:text-ios-blue p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Edit}></i></button>
                                                        <button onClick={() => handleAction('DELETE_ITEM', { collection: parentTab, id: item.id })} className="text-gray-400 hover:text-ios-red p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Trash}></i></button>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                        {filteredParentItems.length === 0 && (
                                            <div className="col-span-full text-center py-20 text-gray-400 flex flex-col items-center gap-2">
                                                <i className="fa-regular fa-folder-open text-4xl opacity-50"></i>
                                                <p>Ê≠§ÂàÜÈ°ûÊ≤íÊúâÈ†ÖÁõÆ</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {parentTab === 'children' && (
                                <div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {data.children.map(child => (
                                            <div key={child.id} className="bg-white p-6 rounded-3xl shadow-ios flex items-center gap-6 relative border border-white hover:border-ios-blue/30 transition">
                                                <Avatar avatar={child.avatar} size="xl" />
                                                <div>
                                                    <div className="font-bold text-2xl text-gray-800">{child.name}</div>
                                                    <div className="text-ios-indigo font-bold text-lg mt-1">{child.points} Èªû</div>
                                                </div>
                                                <div className="absolute top-4 right-4 flex gap-1">
                                                    <button onClick={() => setModalConfig({ open: true, type: 'edit_child', data: child })} className="text-gray-300 hover:text-ios-blue p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Edit}></i></button>
                                                    <button onClick={() => handleAction('DELETE_ITEM', { collection: 'children', id: child.id })} className="text-gray-300 hover:text-ios-red p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Trash}></i></button>
                                                </div>
                                            </div>
                                        ))}
                                        <button onClick={() => setModalConfig({ open: true, type: 'add_child' })} className="bg-gray-50 border-2 border-dashed border-gray-300 text-gray-400 p-6 rounded-3xl flex flex-col items-center justify-center gap-2 hover:border-ios-blue hover:text-ios-blue hover:bg-white transition min-h-[140px] font-bold"><i className={`${Icons.Plus} text-3xl`}></i> Êñ∞Â¢ûÂ∞èÂ≠©</button>
                                    </div>
                                </div>
                            )}

                            {parentTab === 'settings' && (
                                <div className="space-y-8 max-w-lg">
                                    <div className="bg-white p-8 rounded-3xl shadow-ios border border-white">
                                        <h3 className="font-bold text-gray-800 mb-6 text-xl flex items-center gap-2"><i className="fa-solid fa-key text-ios-indigo"></i> ÂÆ∂Èï∑ÂØÜÁ¢º</h3>
                                        <div className="relative">
                                            <input type={showParentPass ? "text" : "password"} value={tempParentPass} onChange={(e) => setTempParentPass(e.target.value)} className="w-full bg-ios-bg p-4 rounded-xl outline-none border border-transparent focus:border-ios-indigo focus:bg-white transition font-mono text-lg tracking-widest" />
                                            <button onClick={() => setShowParentPass(!showParentPass)} className="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><i className={showParentPass ? Icons.EyeSlash : Icons.Eye}></i></button>
                                        </div>
                                        <button onClick={() => { localStorage.setItem('parent_pass', tempParentPass); showToast("ÂØÜÁ¢ºÂ∑≤Êõ¥Êñ∞"); }} className="w-full bg-ios-indigo text-white p-4 rounded-xl font-bold mt-4 shadow-lg hover:opacity-90 transition">ÂÑ≤Â≠òÊñ∞ÂØÜÁ¢º</button>
                                    </div>
                                    <div className="bg-white p-8 rounded-3xl shadow-ios border border-white">
                                        <h3 className="font-bold text-gray-800 mb-6 text-xl flex items-center gap-2"><i className="fa-brands fa-github text-gray-700"></i> Github Sync</h3>
                                        <p className="text-sm text-gray-500 mb-4">Ëº∏ÂÖ• Token ‰ª•ÂïüÁî®Èõ≤Á´ØÂÇô‰ªΩÂäüËÉΩ„ÄÇ</p>
                                        <div className="relative">
                                            <input type={showToken ? "text" : "password"} value={ghToken} onChange={(e) => setGhToken(e.target.value)} className="w-full bg-ios-bg p-4 rounded-xl outline-none border border-transparent focus:border-gray-800 focus:bg-white transition font-mono text-sm" placeholder="ghp_..." />
                                            <button onClick={() => setShowToken(!showToken)} className="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><i className={showToken ? Icons.EyeSlash : Icons.Eye}></i></button>
                                        </div>
                                        <button onClick={() => {
                                            let t = ghToken.trim();
                                            if (t && !t.startsWith('ghp_') && !t.startsWith('github_pat_')) t = 'ghp_' + t;
                                            setGhToken(t); localStorage.setItem('gh_token', t); fetchData(t);
                                        }} className="w-full bg-gray-800 text-white p-4 rounded-xl font-bold mt-4 shadow-lg hover:opacity-90 transition">ÂÑ≤Â≠ò‰∏¶Ê∏¨Ë©¶ÈÄ£Á∑ö</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Modals */}
                        {(modalConfig.type === 'add_child' || modalConfig.type === 'edit_child') && <ChildModal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} type={modalConfig.type} data={modalConfig.data} onSave={p => { handleAction(modalConfig.type === 'edit_child' ? 'EDIT_CHILD' : 'ADD_CHILD', p); setModalConfig({ ...modalConfig, open: false }); }} />}
                        
                        {(modalConfig.type.includes('task') || modalConfig.type.includes('reward')) && (
                            <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={modalConfig.type.includes('add') ? 'Êñ∞Â¢û' : 'Á∑®ËºØ'}>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const payload = {
                                        id: modalConfig.data?.id,
                                        title: e.target.title.value,
                                        points: parseInt(e.target.points.value),
                                        assignee: e.target.assignee.value,
                                        categoryId: e.target.categoryId.value,
                                        isRepeatable: e.target.isRepeatable?.checked
                                    };
                                    handleAction(modalConfig.type.includes('add') ? (modalConfig.type.includes('task') ? 'ADD_TASK' : 'ADD_REWARD') : (modalConfig.type.includes('task') ? 'EDIT_TASK' : 'EDIT_REWARD'), payload);
                                    setModalConfig({ ...modalConfig, open: false });
                                }} className="flex flex-col gap-4">
                                    <input name="title" placeholder="ÂêçÁ®±" defaultValue={modalConfig.data?.title} required className="bg-ios-bg p-3 rounded-xl outline-none focus:ring-2 focus:ring-ios-blue" />
                                    <div className="flex gap-2">
                                        <input type="number" name="points" placeholder="ÈªûÊï∏" defaultValue={modalConfig.data?.points} required className="bg-ios-bg p-3 rounded-xl flex-1 outline-none focus:ring-2 focus:ring-ios-blue" />
                                        <div className="relative flex-1">
                                            <select name="categoryId" defaultValue={modalConfig.data?.categoryId} className="w-full bg-ios-bg p-3 rounded-xl appearance-none custom-select outline-none focus:ring-2 focus:ring-ios-blue">
                                                <option value="">ÁÑ°ÂàÜÈ°û</option>
                                                {data.categories.filter(c => c.type === (modalConfig.type.includes('task') ? 'task' : 'reward')).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="relative">
                                        <select name="assignee" defaultValue={modalConfig.data?.assignee || 'all'} className="w-full bg-ios-bg p-3 rounded-xl appearance-none custom-select outline-none focus:ring-2 focus:ring-ios-blue">
                                            <option value="all">ÊâÄÊúâ‰∫∫</option>
                                            {data.children.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                    {modalConfig.type.includes('reward') && (
                                        <label className="flex items-center gap-3 p-3 bg-ios-bg rounded-xl cursor-pointer">
                                            <input type="checkbox" name="isRepeatable" defaultChecked={modalConfig.data?.isRepeatable} className="w-5 h-5 accent-ios-green rounded" />
                                            <span className="text-gray-600 font-bold text-sm">ÂèØÁ¥ØË®àÂÖåÊèõ</span>
                                        </label>
                                    )}
                                    <button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition">ÂÑ≤Â≠ò</button>
                                </form>
                            </Modal>
                        )}

                        {modalConfig.type === 'manual_adjust' && (
                            <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="ÊâãÂãïÁçéÊá≤">
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const pts = parseInt(e.target.points.value);
                                    handleAction('MANUAL_ADJUST', {
                                        childId: e.target.childId.value,
                                        points: e.target.type.value === 'deduct' ? -pts : pts,
                                        reason: e.target.reason.value
                                    });
                                    setModalConfig({ ...modalConfig, open: false });
                                }} className="flex flex-col gap-4">
                                    <select name="childId" className="bg-ios-bg p-3 rounded-xl custom-select outline-none focus:ring-2 focus:ring-ios-blue" required>{data.children.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                    <div className="flex gap-4">
                                        <label className="flex-1 flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer has-[:checked]:bg-ios-green/10 has-[:checked]:text-ios-green border border-transparent has-[:checked]:border-ios-green transition font-bold"><input type="radio" name="type" value="add" defaultChecked className="hidden" /> Âä†ÂàÜ</label>
                                        <label className="flex-1 flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer has-[:checked]:bg-ios-red/10 has-[:checked]:text-ios-red border border-transparent has-[:checked]:border-ios-red transition font-bold"><input type="radio" name="type" value="deduct" className="hidden" /> Êâ£ÂàÜ</label>
                                    </div>
                                    <input type="number" name="points" placeholder="ÈªûÊï∏" required className="bg-ios-bg p-3 rounded-xl outline-none focus:ring-2 focus:ring-ios-blue" />
                                    <input name="reason" placeholder="ÂéüÂõ†" required className="bg-ios-bg p-3 rounded-xl outline-none focus:ring-2 focus:ring-ios-blue" />
                                    <button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition">Âü∑Ë°å</button>
                                </form>
                            </Modal>
                        )}

                        {modalConfig.type === 'manage_categories' && (
                            <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={`ÁÆ°ÁêÜ${modalConfig.categoryType === 'task' ? '‰ªªÂãô' : 'ÁçéÂãµ'}ÂàÜÈ°û`}>
                                <CategoryManager 
                                    categories={data.categories}
                                    type={modalConfig.categoryType}
                                    onEdit={payload => handleAction('EDIT_CATEGORY', payload)}
                                    onDelete={id => handleAction('DELETE_CATEGORY', {id})}
                                    onAdd={payload => handleAction('ADD_CATEGORY', payload)}
                                />
                            </Modal>
                        )}
                        
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
