<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¥½å¯¶å¯¶é»æ•¸å­˜æ‘º</title>
    <!-- Fonts: Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#FFF9F2',      // æº«æš–å¥¶æ²¹ç™½
                            card: '#FFFFFF',
                            blue: '#89CFF0',    // å¯¶å¯¶è—
                            green: '#98FB98',   // è–„è·ç¶ 
                            indigo: '#B39EB5',  // è–°è¡£è‰ç´«
                            orange: '#FFD1A9',  // å¥¶æ²¹æ
                            pink: '#FFB7B2',    // æ«»èŠ±ç²‰
                            purple: '#DDA0DD',  // æ¢…å­ç²‰ç´«
                            red: '#FF6961',     // æŸ”å’Œç´…
                            teal: '#88D8C0',    // æ¹–æ°´ç¶ 
                            yellow: '#FDFD96',  // æª¸æª¬é»ƒ
                            gray: '#A9A9A9',    // æŸ”å’Œç°
                            gray2: '#D3D3D3',
                            gray3: '#E0E0E0',
                        }
                    },
                    boxShadow: {
                        'ios': '0 4px 12px rgba(137, 207, 240, 0.15)', 
                        'ios-lg': '0 10px 25px rgba(179, 158, 181, 0.2)',
                    },
                    fontFamily: {
                        // Apply Zen Maru Gothic as the default sans font
                        sans: ['"Zen Maru Gothic"', '-apple-system', 'BlinkMacSystemFont', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', "Noto Sans TC", 'sans-serif'],
                    },
                    screens: {
                        'xs': '375px', // Targeted for iPhone 8 and smaller
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #FFF9F2;
            -webkit-tap-highlight-color: transparent;
            font-family: "Zen Maru Gothic", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior: none;
            color: #555;
            font-weight: 500;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .sidebar-transition { transition: width 0.3s ease-in-out; }
        .custom-select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23B39EB5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        
        /* Mobile adjustments */
        @media (max-width: 640px) {
            .mobile-grid-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .mobile-grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        
        /* Sticky Header Background Blur fix for iOS */
        .sticky-header {
            background-color: rgba(255, 249, 242, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Sticky Tabs & Filter */
        .sticky-tabs {
            position: sticky;
            top: 0;
            z-index: 30;
            background-color: #FFF9F2; /* Match body bg */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const REPO_OWNER = "zenningh1983";
        const REPO_NAME = "goodbaby";
        const FILE_PATH = "data.json";
        const DEFAULT_TOKEN_SUFFIX = "hfFz2uYiriKFcVZlrD3YU79KRTdBvf0yd7PA";

        const Icons = {
            Sync: "fa-solid fa-rotate", Check: "fa-solid fa-check", Xmark: "fa-solid fa-xmark",
            Child: "fa-solid fa-child-reaching", Parent: "fa-solid fa-user-shield", Task: "fa-solid fa-star",
            Reward: "fa-solid fa-gift", History: "fa-solid fa-clock-rotate-left", Settings: "fa-solid fa-gear",
            Plus: "fa-solid fa-plus", Minus: "fa-solid fa-minus", Trash: "fa-solid fa-trash-can",
            Lock: "fa-solid fa-lock", Edit: "fa-solid fa-pen", Coins: "fa-solid fa-coins",
            Eye: "fa-solid fa-eye", EyeSlash: "fa-solid fa-eye-slash", ChevronLeft: "fa-solid fa-chevron-left",
            ChevronRight: "fa-solid fa-chevron-right", Exit: "fa-solid fa-right-from-bracket", Image: "fa-regular fa-image",
            Face: "fa-regular fa-face-smile", Filter: "fa-solid fa-filter", UserGroup: "fa-solid fa-user-group",
            Repeat: "fa-solid fa-repeat", Bolt: "fa-solid fa-bolt", Spinner: "fa-solid fa-circle-notch",
        };

        const QUOTES = [
            "ä»Šå¤©ä¹Ÿæ˜¯æ£’æ£’çš„ä¸€å¤©ï¼ğŸŒŸ", "ä½ æ˜¯æœ€æ£’çš„å°å¹«æ‰‹ï¼ğŸ’ª", "ç¹¼çºŒåŠ æ²¹ï¼Œä½ å¯ä»¥çš„ï¼âœ¨", "å¥½ç¿’æ…£è®“ä½ æ›´å¼·å¤§ï¼ğŸš€",
            "æ¯ä¸€å€‹é€²æ­¥éƒ½å€¼å¾—æ…¶ç¥ï¼ğŸ‰", "ä½ çš„åŠªåŠ›å¤§å®¶éƒ½çœ‹è¦‹äº†ï¼ğŸ‘€", "ä¿æŒå¾®ç¬‘ï¼Œå¿«æ¨‚å‡ºç™¼ï¼ğŸ˜Š",
            "ä»Šå¤©çš„ä½ æ¯”æ˜¨å¤©æ›´æ£’ï¼ğŸŒˆ", "å¤ªå²å®³äº†ï¼Œç¹¼çºŒä¿æŒï¼ğŸ‘", "ä½ çš„ç¬‘å®¹æ˜¯æœ€å¥½çš„ç¦®ç‰©ï¼ğŸ"
        ];

        const toBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
        const fromBase64 = (str) => decodeURIComponent(escape(atob(str)));

        const INITIAL_DATA = {
            children: [], 
            categories: [
                { id: 'cat_default_task', name: 'æ—¥å¸¸', type: 'task', color: 'blue' },
                { id: 'cat_default_reward', name: 'é»å¿ƒ', type: 'reward', color: 'pink' }
            ],
            tasks: [], rewards: [], history: [],  
        };

        // --- Github API ---
        const githubApi = {
            async getData(token) {
                if (!token) return null;
                try {
                    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }, cache: 'no-store'
                    });
                    if (res.status === 404) return { content: JSON.parse(JSON.stringify(INITIAL_DATA)), sha: null };
                    if (res.status === 401) throw new Error('Token ç„¡æ•ˆ (401)');
                    if (!res.ok) throw new Error('Fetch failed: ' + res.status);
                    const data = await res.json();
                    let content;
                    try {
                        const decoded = fromBase64(data.content);
                        content = { ...INITIAL_DATA, ...JSON.parse(decoded) };
                        if (!content.categories) content.categories = INITIAL_DATA.categories;
                    } catch (err) { content = JSON.parse(JSON.stringify(INITIAL_DATA)); }
                    return { content, sha: data.sha };
                } catch (e) { console.error("Sync Error (Get):", e); throw e; }
            },
            async saveData(token, content, sha) {
                if (!token) throw new Error("No Token");
                try {
                    const body = { message: "Update", content: toBase64(JSON.stringify(content, null, 2)), sha: sha || undefined };
                    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                        method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                    });
                    if (res.status === 401) throw new Error('Token ç„¡æ•ˆ (401)');
                    if (!res.ok) throw new Error('Save failed: ' + res.status);
                    return await res.json();
                } catch (e) { console.error("Sync Error (Save):", e); throw e; }
            }
        };

        // --- Components ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 1000); return () => clearTimeout(timer); }, [onClose]);
            const bgClass = type === 'error' ? 'bg-ios-red/80' : (type === 'warning' ? 'bg-ios-orange/80' : 'bg-ios-green/80');
            return (
                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[60] animate-fade-in pointer-events-none w-full max-w-xs flex justify-center px-4">
                    <div className={`${bgClass} text-white px-6 py-3 rounded-2xl shadow-sm backdrop-blur-sm flex items-center gap-2 font-medium text-sm truncate max-w-full`}>
                        <i className={type === 'error' ? Icons.Xmark : (type === 'warning' ? Icons.Sync : Icons.Check)}></i>{message}
                    </div>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-ios-indigo/20 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="relative bg-white rounded-3xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto animate-slide-up hide-scrollbar border-4 border-white" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-ios-bg sticky top-0 z-10">
                            <h3 className="text-lg font-bold text-gray-700">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-ios-red w-8 h-8 flex items-center justify-center rounded-full hover:bg-white transition"><i className={Icons.Xmark}></i></button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const Avatar = ({ avatar, size = "md", className = "" }) => {
            const isImage = avatar && avatar.startsWith('data:image');
            const sizeClasses = { sm: 'w-8 h-8 text-lg', md: 'w-12 h-12 text-2xl', lg: 'w-20 h-20 text-5xl', xl: 'w-32 h-32 text-7xl' };
            const sizeClass = sizeClasses[size] || sizeClasses.md;
            if (isImage) return <img src={avatar} className={`rounded-full object-cover border-4 border-white shadow-sm ${sizeClass} ${className}`} alt="avatar" />;
            return <div className={`rounded-full bg-white flex items-center justify-center border-4 border-ios-blue/20 shadow-sm ${sizeClass} ${className}`}>{avatar || 'ğŸ‘¶'}</div>;
        };

        const GestureCropper = ({ onImageReady }) => {
            const [imageSrc, setImageSrc] = useState(null);
            const containerRef = useRef(null);
            const state = useRef({ x: 0, y: 0, scale: 1 });
            const [renderTrigger, setRenderTrigger] = useState(0); 
            const handleFileChange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const containerSize = 256; 
                            const scale = Math.max(containerSize / img.naturalWidth, containerSize / img.naturalHeight);
                            state.current = { x: 0, y: 0, scale: scale };
                            setImageSrc(e.target.result);
                        };
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            useEffect(() => {
                if (imageSrc) {
                    const capture = () => {
                        const size = 256; const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size; const ctx = canvas.getContext('2d'); const img = new Image(); img.src = imageSrc;
                        img.onload = () => {
                            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, size, size); ctx.translate(size / 2, size / 2); ctx.translate(state.current.x, state.current.y); ctx.scale(state.current.scale, state.current.scale);
                            ctx.drawImage(img, -img.naturalWidth / 2, -img.naturalHeight / 2);
                            onImageReady(canvas.toDataURL('image/jpeg', 0.6)); 
                        };
                    };
                    const t = setTimeout(capture, 100); return () => clearTimeout(t);
                }
            }, [imageSrc, renderTrigger, onImageReady]);
            const handlePointerDown = (e) => {
                e.target.setPointerCapture(e.pointerId); const startX = e.clientX; const startY = e.clientY; const initialX = state.current.x; const initialY = state.current.y;
                const onPointerMove = (moveEvent) => { state.current.x = initialX + (moveEvent.clientX - startX); state.current.y = initialY + (moveEvent.clientY - startY); setRenderTrigger(prev => prev + 1); };
                const onPointerUp = () => { e.target.removeEventListener('pointermove', onPointerMove); e.target.removeEventListener('pointerup', onPointerUp); };
                e.target.addEventListener('pointermove', onPointerMove); e.target.addEventListener('pointerup', onPointerUp);
            };
            const handleWheel = (e) => { e.preventDefault(); const scaleChange = e.deltaY * -0.001; state.current.scale = Math.min(Math.max(0.1, state.current.scale + scaleChange), 10); setRenderTrigger(prev => prev + 1); };
            if (!imageSrc) return <label className="flex flex-col items-center justify-center w-64 h-64 border-4 border-dashed border-ios-blue/30 rounded-full cursor-pointer hover:bg-white hover:border-ios-blue transition mx-auto bg-ios-bg"><div className="flex flex-col items-center justify-center text-ios-blue/50"><i className={`${Icons.Image} text-3xl mb-2`}></i><p className="text-sm font-bold">é»æ“Šä¸Šå‚³ç…§ç‰‡</p></div><input type="file" className="hidden" accept="image/*" onChange={handleFileChange} /></label>;
            return <div className="relative w-64 h-64 bg-white rounded-full overflow-hidden touch-none mx-auto border-4 border-ios-blue" ref={containerRef}><div className="absolute inset-0 flex items-center justify-center cursor-move" onPointerDown={handlePointerDown} onWheel={handleWheel}><img src={imageSrc} style={{transform: `translate(${state.current.x}px, ${state.current.y}px) scale(${state.current.scale})`, maxWidth: 'none', maxHeight: 'none', pointerEvents: 'none', transformOrigin: 'center'}} /></div><div className="absolute inset-0 pointer-events-none rounded-full shadow-[inset_0_0_20px_rgba(0,0,0,0.1)]"></div><div className="absolute bottom-4 left-0 right-0 text-center text-[10px] text-white/80 drop-shadow-md pointer-events-none font-bold">æ‹–æ›³ â€¢ ç¸®æ”¾</div></div>;
        };

        // NEW: Pin Login Component
        const PinLoginView = ({ targetName, avatar, correctPassword, onSuccess }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const inputRef = useRef(null);

            useEffect(() => {
                if(inputRef.current) inputRef.current.focus();
            }, []);

            const handleSubmit = () => {
                if (password === correctPassword) {
                    onSuccess();
                } else {
                    setError('å¯†ç¢¼éŒ¯èª¤');
                    setPassword('');
                    if(inputRef.current) inputRef.current.focus();
                }
            };

            return (
                <div className="flex flex-col gap-6 items-center">
                    {avatar && <Avatar avatar={avatar} size="lg" />}
                    <div className="w-full">
                        <p className="text-gray-500 text-sm font-bold mb-2 text-center">è«‹è¼¸å…¥ 4 ä½æ•¸å¯†ç¢¼</p>
                        <input 
                            ref={inputRef}
                            type="password" 
                            value={password}
                            onChange={(e) => {
                                setPassword(e.target.value);
                                setError('');
                            }}
                            className={`w-full p-4 bg-ios-bg rounded-xl text-center text-2xl tracking-widest outline-none border transition ${error ? 'border-ios-red bg-ios-red/5' : 'border-white focus:ring-2 focus:ring-ios-indigo'}`}
                            placeholder="â—â—â—â—" 
                            maxLength="4" 
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') handleSubmit();
                            }}
                        />
                        <div className="h-6 mt-2 text-center">
                            {error && <span className="text-ios-red text-sm font-bold animate-fade-in">{error}</span>}
                        </div>
                    </div>
                    <button 
                        onClick={handleSubmit}
                        className="w-full bg-ios-indigo text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition"
                    >
                        é€²å…¥
                    </button>
                </div>
            );
        };

        const CategoryManager = ({ categories, type, onEdit, onDelete, onAdd }) => {
            const [editId, setEditId] = useState(null);
            const [tempName, setTempName] = useState("");
            const filtered = categories.filter(c => c.type === type);
            const saveEdit = () => { if (tempName.trim()) { onEdit({ id: editId, name: tempName }); setEditId(null); } };
            return (
                <div className="flex flex-col gap-4">
                    <div className="space-y-2 max-h-60 overflow-y-auto">
                        {filtered.map(c => (
                            <div key={c.id} className="flex items-center justify-between bg-ios-bg p-3 rounded-xl border border-white">
                                {editId === c.id ? (<div className="flex items-center gap-2 flex-1"><input className="bg-white border border-ios-blue rounded px-2 py-1 flex-1 text-sm outline-none text-gray-700" value={tempName} onChange={e => setTempName(e.target.value)} autoFocus /><button onClick={saveEdit} className="text-ios-green px-2"><i className={Icons.Check}></i></button><button onClick={() => setEditId(null)} className="text-gray-400 px-2"><i className={Icons.Xmark}></i></button></div>) : (<><div className="flex items-center gap-2"><div className={`w-3 h-3 rounded-full bg-${c.color}-500 shadow-sm`}></div><span className="font-bold text-gray-700">{c.name}</span></div><div className="flex gap-1"><button onClick={() => {setEditId(c.id); setTempName(c.name);}} className="text-ios-blue w-8 h-8 rounded-full hover:bg-white transition"><i className={Icons.Edit}></i></button><button onClick={() => onDelete(c.id)} className="text-ios-red w-8 h-8 rounded-full hover:bg-white transition"><i className={Icons.Trash}></i></button></div></>)}
                            </div>
                        ))}
                        {filtered.length === 0 && <div className="text-center text-gray-400 text-sm py-4">å°šç„¡åˆ†é¡</div>}
                    </div>
                    <div className="border-t pt-4"><h4 className="font-bold text-gray-600 mb-2 text-sm">æ–°å¢åˆ†é¡</h4><form onSubmit={(e) => { e.preventDefault(); if (e.target.name.value.trim()) { onAdd({ name: e.target.name.value, type: type, color: 'blue' }); e.target.reset(); } }} className="flex gap-2"><input name="name" placeholder="åç¨±" required className="bg-ios-bg p-2 rounded-lg flex-1 text-sm outline-none focus:ring-2 focus:ring-ios-blue" /><button className="bg-ios-indigo text-white px-4 rounded-lg font-bold text-sm shadow-md active:scale-95 transition">æ–°å¢</button></form></div>
                </div>
            );
        };

        const ChildModal = ({ isOpen, onClose, type, data, onSave }) => {
            const isEdit = type === 'edit_child';
            const [currentAvatar, setCurrentAvatar] = useState(isEdit ? data.avatar : 'ğŸ‘¶');
            const [avatarType, setAvatarType] = useState(isEdit && data.avatar.startsWith('data:image') ? 'image' : 'emoji');
            
            // Default password is '0000' for new children, or existing password for edit
            const initialPassword = isEdit && data.password ? data.password : '0000';
            const [password, setPassword] = useState(initialPassword);

            const handleCropUpdate = useCallback((base64) => { setCurrentAvatar(base64); }, []);
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={isEdit ? "ç·¨è¼¯å°å­©" : "æ–°å¢å°å­©"}>
                    <form onSubmit={(e) => { e.preventDefault(); onSave({ id: isEdit ? data.id : undefined, name: e.target.name.value, avatar: currentAvatar, password: password }); }} className="flex flex-col gap-4">
                        <input name="name" placeholder="åå­—" defaultValue={isEdit ? data.name : ''} required className="bg-ios-bg p-3 rounded-xl w-full text-gray-700 font-bold text-lg text-center focus:ring-2 focus:ring-ios-blue outline-none border border-white" />
                        
                        <div className="flex items-center gap-2 bg-ios-bg p-3 rounded-xl border border-white">
                            <span className="text-gray-500 text-sm font-bold w-20">è¨­å®šå¯†ç¢¼</span>
                            <input 
                                type="text" 
                                value={password} 
                                onChange={(e) => setPassword(e.target.value)} 
                                maxLength="4"
                                className="bg-transparent flex-1 outline-none text-gray-700 font-mono tracking-widest text-center" 
                            />
                        </div>

                        <div className="bg-ios-bg p-4 rounded-xl border border-white">
                            <div className="flex gap-2 mb-4"><button type="button" onClick={() => setAvatarType('emoji')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${avatarType === 'emoji' ? 'bg-white shadow text-ios-blue' : 'text-gray-400'}`}>è¡¨æƒ…</button><button type="button" onClick={() => setAvatarType('image')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${avatarType === 'image' ? 'bg-white shadow text-ios-blue' : 'text-gray-400'}`}>ç…§ç‰‡</button></div>
                            {avatarType === 'emoji' ? (<div className="grid grid-cols-5 gap-2">{['ğŸ‘¦', 'ğŸ‘§', 'ğŸ‘¶', 'ğŸ§‘â€ğŸš€', 'ğŸ¦„', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¸'].map(emoji => (<div key={emoji} onClick={() => setCurrentAvatar(emoji)} className={`text-2xl p-2 rounded-lg text-center cursor-pointer transition ${currentAvatar === emoji ? 'bg-white shadow-md scale-110' : 'hover:bg-white/50'}`}>{emoji}</div>))}</div>) : (<GestureCropper onImageReady={handleCropUpdate} />)}
                        </div>
                        <button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition">{isEdit ? 'å„²å­˜ä¿®æ”¹' : 'æ–°å¢'}</button>
                    </form>
                </Modal>
            );
        };

        const RedeemQuantityModal = ({ isOpen, onClose, data, userPoints, onConfirm, processing }) => {
            const [qty, setQty] = useState(1);
            const unitPoints = data.points;
            const totalPoints = qty * unitPoints;
            const maxQty = Math.floor(userPoints / unitPoints);

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="å…Œæ›æ•¸é‡">
                    <div className="flex flex-col gap-6 p-2">
                        <div className="text-center">
                            <div className="font-bold text-2xl text-gray-800">{data.title}</div>
                            <div className="text-gray-400 font-medium">å–®åƒ¹: {unitPoints.toLocaleString()} é»</div>
                        </div>
                        
                        <div className="flex items-center justify-center gap-6 bg-ios-bg p-4 rounded-2xl">
                            <button onClick={() => setQty(Math.max(1, qty - 1))} className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold transition ${qty <= 1 ? 'bg-gray-200 text-gray-400' : 'bg-white text-gray-600 shadow-sm'}`} disabled={qty <= 1}><i className={Icons.Minus}></i></button>
                            <div className="text-4xl font-black w-16 text-center text-ios-indigo">{qty}</div>
                            <button onClick={() => setQty(Math.min(maxQty, qty + 1))} className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold transition ${qty >= maxQty ? 'bg-gray-200 text-gray-400' : 'bg-white text-gray-600 shadow-sm'}`} disabled={qty >= maxQty}><i className={Icons.Plus}></i></button>
                        </div>

                        <div className="text-center">
                            <div className="text-ios-pink font-bold text-3xl">-{totalPoints.toLocaleString()} é»</div>
                            <div className="text-sm text-gray-400 mt-1 font-bold">æ“æœ‰: {userPoints.toLocaleString()} é»</div>
                        </div>

                        <button onClick={() => onConfirm(qty, totalPoints)} className="w-full py-4 rounded-xl bg-ios-pink text-white font-bold shadow-lg text-lg active:scale-95 transition disabled:opacity-50" disabled={processing}>
                            {processing ? <i className={`${Icons.Spinner} animate-spin`}></i> : 'ç¢ºèªå…Œæ›'}
                        </button>
                    </div>
                </Modal>
            );
        };

        const SyncIcon = ({ className = "" }) => (
            <div className={`w-8 h-8 rounded-full glass flex items-center justify-center shadow-sm transition-all ${className} text-ios-blue`}>
                <i className={Icons.Sync}></i>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [mode, setMode] = useState('landing');
            const [data, setData] = useState(INITIAL_DATA);
            const [sha, setSha] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle');
            const [toast, setToast] = useState(null);
            // Default Token handling
            const [ghToken, setGhToken] = useState(() => { const stored = localStorage.getItem('gh_token'); if (stored) return stored; return DEFAULT_TOKEN_SUFFIX ? 'ghp_' + DEFAULT_TOKEN_SUFFIX : ''; });
            const [currentChild, setCurrentChild] = useState(null);
            
            const [parentPass, setParentPass] = useState(localStorage.getItem('parent_pass') || '0000');
            const [tempParentPass, setTempParentPass] = useState(localStorage.getItem('parent_pass') || '0000');
            const [parentTab, setParentTab] = useState('approvals');
            const [parentApprovalTab, setParentApprovalTab] = useState('tasks'); 
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [parentFilterCat, setParentFilterCat] = useState('all'); 
            
            const [childTab, setChildTab] = useState('tasks');
            const [historyFilter, setHistoryFilter] = useState('week');
            const [childFilterCat, setChildFilterCat] = useState('all'); 
            const [childLastViewedHistory, setChildLastViewedHistory] = useState(parseInt(localStorage.getItem('child_last_viewed_history') || '0'));

            const [showParentPass, setShowParentPass] = useState(false);
            const [showToken, setShowToken] = useState(false);
            const [modalConfig, setModalConfig] = useState({ open: false, type: '', data: null });
            const [isSubmitting, setIsSubmitting] = useState(false); // For debounce
            const [processingItems, setProcessingItems] = useState(new Set());

            const showToast = (msg, type = 'success') => setToast({ message: msg, type });

            // Generate random quote when entering child dashboard
            const dailyQuote = useMemo(() => {
                return QUOTES[Math.floor(Math.random() * QUOTES.length)];
            }, [mode]);

            useEffect(() => { if (ghToken) fetchData(ghToken); }, []);

            const fetchData = async (token = ghToken) => {
                if (!token) return;
                setSyncStatus('syncing');
                try {
                    const result = await githubApi.getData(token);
                    if (result) { setData(result.content); setSha(result.sha); setSyncStatus('success'); }
                } catch (e) {
                    setSyncStatus('error');
                    if (mode !== 'landing') e.message.includes('401') ? showToast("Token ç„¡æ•ˆ", 'error') : showToast("é›¢ç·šæ¨¡å¼", 'warning');
                }
            };

            const saveData = async (newData) => {
                setData(newData); 
                if (!ghToken) return;
                setSyncStatus('syncing');
                try {
                    const fresh = await githubApi.getData(ghToken);
                    const res = await githubApi.saveData(ghToken, newData, fresh ? fresh.sha : null);
                    setSha(res.content.sha); setSyncStatus('success');
                } catch (e) { setSyncStatus('error'); showToast("åŒæ­¥å¤±æ•— (å·²å­˜æœ¬æ©Ÿ)", 'warning'); }
            };

            const handleModeChange = (newMode) => {
                if ((newMode === 'parent' || newMode === 'child_select') && ghToken) fetchData(ghToken);
                setMode(newMode);
            };

            const updateChildHistoryView = () => {
                const now = Date.now();
                setChildLastViewedHistory(now);
                localStorage.setItem('child_last_viewed_history', now.toString());
            };

            const handleAction = async (actionType, payload) => {
                if (actionType.includes('REQUEST')) {
                    const itemId = payload.id;
                    if (processingItems.has(itemId)) return;
                    setProcessingItems(prev => new Set(prev).add(itemId));
                }

                let newData = JSON.parse(JSON.stringify(data));
                const timestamp = Date.now();
                newData.categories = newData.categories || INITIAL_DATA.categories;

                if (actionType === 'ADD_CHILD') {
                    // Include password in new child data
                    newData.children.push({ 
                        id: timestamp, 
                        name: payload.name, 
                        points: 0, 
                        avatar: payload.avatar,
                        password: payload.password || '0000' 
                    });
                    showToast("æ–°å¢æˆåŠŸ");
                } 
                else if (actionType === 'EDIT_CHILD') {
                    const idx = newData.children.findIndex(c => c.id === payload.id);
                    if (idx !== -1) {
                         newData.children[idx] = { 
                             ...newData.children[idx], 
                             ...payload 
                         };
                    }
                    showToast("ä¿®æ”¹æˆåŠŸ");
                }
                // ... (rest of handleAction remains the same)
                else if (actionType === 'ADD_CATEGORY') { newData.categories.push({ id: `cat_${timestamp}`, ...payload }); showToast("åˆ†é¡æ–°å¢æˆåŠŸ"); }
                else if (actionType === 'EDIT_CATEGORY') { const idx = newData.categories.findIndex(c => c.id === payload.id); if (idx !== -1) newData.categories[idx] = { ...newData.categories[idx], ...payload }; showToast("åˆ†é¡ä¿®æ”¹æˆåŠŸ"); }
                else if (actionType === 'DELETE_CATEGORY') { newData.categories = newData.categories.filter(c => c.id !== payload.id); newData.tasks.forEach(t => { if(t.categoryId === payload.id) t.categoryId = ''; }); newData.rewards.forEach(r => { if(r.categoryId === payload.id) r.categoryId = ''; }); showToast("åˆ†é¡åˆªé™¤æˆåŠŸ"); }
                else if (actionType === 'ADD_TASK' || actionType === 'ADD_REWARD') { const collection = actionType === 'ADD_TASK' ? 'tasks' : 'rewards'; const { id, ...itemData } = payload; newData[collection].push({ id: timestamp, ...itemData }); showToast("æ–°å¢æˆåŠŸ"); }
                else if (actionType === 'EDIT_TASK' || actionType === 'EDIT_REWARD') { const collection = actionType === 'EDIT_TASK' ? 'tasks' : 'rewards'; const idx = newData[collection].findIndex(i => i.id === payload.id); if (idx !== -1) newData[collection][idx] = { ...newData[collection][idx], ...payload }; showToast("ä¿®æ”¹æˆåŠŸ"); }
                else if (actionType === 'DELETE_ITEM') { if(newData[payload.collection]) { newData[payload.collection] = newData[payload.collection].filter(i => i.id !== payload.id); showToast("åˆªé™¤æˆåŠŸ"); } }
                else if (actionType === 'REQUEST_TASK') { newData.history.unshift({ id: timestamp, type: 'task_pending', childId: currentChild.id, itemId: payload.id, itemName: payload.title, points: payload.points, timestamp: timestamp, status: 'pending' }); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); showToast("ç”³è«‹å·²é€å‡º"); }
                else if (actionType === 'REQUEST_REDEEM') {
                    if (currentChild.points < payload.totalPoints) { showToast("é»æ•¸ä¸å¤ å–”", 'error'); setProcessingItems(prev => { const n = new Set(prev); n.delete(payload.id); return n; }); return; }
                    const itemName = payload.quantity > 1 ? `${payload.title} x${payload.quantity}` : payload.title;
                    newData.history.unshift({ id: timestamp, type: 'redeem_pending', childId: currentChild.id, itemId: payload.id, itemName: itemName, points: payload.totalPoints, timestamp: timestamp, status: 'pending' }); showToast("ç”³è«‹å·²é€å‡º");
                }
                else if (actionType === 'APPROVE') {
                    const historyIdx = newData.history.findIndex(h => h.id === payload.id); const item = newData.history[historyIdx]; const childIdx = newData.children.findIndex(c => c.id === item.childId);
                    if (item.type === 'task_pending') { newData.children[childIdx].points += parseInt(item.points); item.status = 'approved'; showToast("å·²æ ¸å‡† (åŠ é»)"); }
                    else { if (newData.children[childIdx].points >= parseInt(item.points)) { newData.children[childIdx].points -= parseInt(item.points); item.status = 'approved'; showToast("å·²æ ¸å‡† (æ‰£é»)"); } else { showToast("é»æ•¸ä¸è¶³ï¼Œç„¡æ³•æ ¸å‡†", 'error'); return; } }
                }
                else if (actionType === 'APPROVE_ALL') {
                    const itemsToApprove = payload.items; let successCount = 0;
                    itemsToApprove.forEach(item => {
                        const historyIdx = newData.history.findIndex(h => h.id === item.id); if (historyIdx === -1 || newData.history[historyIdx].status !== 'pending') return;
                        const historyItem = newData.history[historyIdx]; const childIdx = newData.children.findIndex(c => c.id === historyItem.childId); if (childIdx === -1) return;
                        if (historyItem.type === 'task_pending') { newData.children[childIdx].points += parseInt(historyItem.points); newData.history[historyIdx].status = 'approved'; successCount++; }
                        else if (historyItem.type === 'redeem_pending') { if (newData.children[childIdx].points >= parseInt(historyItem.points)) { newData.children[childIdx].points -= parseInt(historyItem.points); newData.history[historyIdx].status = 'approved'; successCount++; } }
                    });
                    showToast(`å·²æ‰¹å‡† ${successCount} é …ç›®`);
                }
                else if (actionType === 'REJECT') { const idx = newData.history.findIndex(h => h.id === payload.id); newData.history[idx].status = 'rejected'; showToast("å·²é§å›"); }
                else if (actionType === 'REJECT_ALL') { const itemsToReject = payload.items; itemsToReject.forEach(item => { const historyIdx = newData.history.findIndex(h => h.id === item.id); if (historyIdx !== -1) newData.history[historyIdx].status = 'rejected'; }); showToast(`å·²é§å› ${itemsToReject.length} é …ç›®`); }
                else if (actionType === 'MANUAL_ADJUST') { const childIdx = newData.children.findIndex(c => c.id === parseInt(payload.childId)); const pts = parseInt(payload.points); newData.children[childIdx].points += pts; newData.history.unshift({ id: timestamp, type: 'manual', childId: parseInt(payload.childId), itemName: payload.reason, points: pts, timestamp: timestamp, status: 'approved' }); showToast("èª¿æ•´æˆåŠŸ"); }

                await saveData(newData);
                
                if (actionType.includes('REQUEST')) { setTimeout(() => { setProcessingItems(prev => { const n = new Set(prev); n.delete(payload.id); return n; }); }, 1000); }
            };

            const sortItems = (items) => { return items.sort((a, b) => { const diff = b.points - a.points; if (diff !== 0) return diff; return (a.categoryId || '').localeCompare(b.categoryId || ''); }); };

            const SyncIcon = () => (
                <div className="fixed top-4 right-4 z-50 flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-full glass flex items-center justify-center shadow-sm transition-all ${syncStatus === 'syncing' ? 'animate-spin text-ios-blue' : syncStatus === 'success' ? 'text-ios-green' : syncStatus === 'error' ? 'text-ios-red' : 'text-gray-400'}`}>
                        <i className={Icons.Sync}></i>
                    </div>
                </div>
            );

            // -- Landing --
            if (mode === 'landing') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden bg-ios-bg">
                        <div className="absolute top-4 right-4"><SyncIcon /></div>
                        <div className="absolute top-20 right-10 text-6xl opacity-80 animate-float" style={{ animationDuration: '4s' }}>â˜ï¸</div>
                        <div className="absolute bottom-20 left-10 text-5xl opacity-60 animate-float" style={{ animationDuration: '6s', animationDelay: '1s' }}>ğŸˆ</div>
                        <div className="absolute top-40 left-20 text-4xl opacity-50 animate-bounce">âœ¨</div>
                        <h1 className="text-4xl font-bold text-gray-700 mb-2 tracking-tight text-center">å¥½å¯¶å¯¶é»æ•¸å­˜æ‘º</h1>
                        <div className="flex justify-center gap-4 mt-2 mb-12 text-3xl"><i className="fa-solid fa-star text-ios-yellow animate-spin-slow"></i><span className="animate-bounce">ğŸ§¸</span><i className="fa-solid fa-heart text-ios-pink animate-pulse"></i></div>
                        <div className="flex flex-col gap-4 w-full max-w-xs">
                            <button onClick={() => handleModeChange('child_select')} className="bg-ios-blue text-white py-4 px-6 rounded-2xl shadow-ios-lg text-lg font-bold flex items-center justify-center gap-3 active:scale-95 transition hover:shadow-xl"><i className={Icons.Child}></i> å°å­©å°ˆå€</button>
                            <button onClick={() => setModalConfig({ open: true, type: 'parent_login' })} className="bg-white text-ios-indigo py-4 px-6 rounded-2xl shadow-ios text-lg font-bold flex items-center justify-center gap-3 active:scale-95 transition hover:bg-ios-bg border border-white"><i className={Icons.Parent}></i> å®¶é•·å°ˆå€</button>
                        </div>
                        {modalConfig.type === 'parent_login' && (
                            <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="å®¶é•·ç™»å…¥">
                                <PinLoginView correctPassword={parentPass} onSuccess={() => { setModalConfig({ ...modalConfig, open: false }); handleModeChange('parent'); }} />
                            </Modal>
                        )}
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            // -- Child Select --
            if (mode === 'child_select') {
                return (
                    <div className="min-h-screen p-6 flex flex-col items-center bg-ios-bg">
                         <div className="absolute top-4 right-4"><SyncIcon /></div>
                        <button onClick={() => setMode('landing')} className="self-start mb-8 text-gray-500 hover:text-ios-blue transition"><i className={Icons.ChevronLeft}></i> è¿”å›</button>
                        <div className="flex flex-wrap justify-center gap-6 w-full max-w-2xl px-4">
                            {data.children.map(child => (
                                <button key={child.id} onClick={() => setModalConfig({ open: true, type: 'child_login', data: child })} className="bg-white p-6 rounded-3xl shadow-ios flex flex-col items-center gap-4 hover:-translate-y-2 transition w-full sm:w-40 border border-white">
                                    <Avatar avatar={child.avatar} size="lg" />
                                    <span className="text-xl font-bold text-gray-700">{child.name}</span>
                                    <span className="bg-ios-yellow/30 text-ios-orange px-4 py-1 rounded-full text-sm font-bold shadow-sm">{child.points.toLocaleString()} é»</span>
                                </button>
                            ))}
                        </div>
                        {modalConfig.type === 'child_login' && (
                            <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={`å“ˆå›‰ ${modalConfig.data.name}`}>
                                <PinLoginView avatar={modalConfig.data.avatar} correctPassword={modalConfig.data.password || '0000'} onSuccess={() => { setCurrentChild(modalConfig.data); setMode('child_dashboard'); setModalConfig({ ...modalConfig, open: false }); }} />
                            </Modal>
                        )}
                    </div>
                );
            }

            // -- Child Dashboard --
            if (mode === 'child_dashboard' && currentChild) {
                const liveChild = data.children.find(c => c.id === currentChild.id) || currentChild;
                const activeCollection = childTab === 'tasks' ? data.tasks : data.rewards;
                const typeFilter = childTab === 'tasks' ? 'task' : 'reward';
                
                let items = activeCollection.filter(i => i.assignee === 'all' || parseInt(i.assignee) === liveChild.id);
                if (childFilterCat !== 'all') items = items.filter(i => i.categoryId === childFilterCat);
                const filteredItems = sortItems(items);
                
                const now = new Date(); const oneDay = 24*60*60*1000;
                let filteredHistory = data.history.filter(h => h.childId === liveChild.id);
                if (childTab === 'history_task') filteredHistory = filteredHistory.filter(h => h.type === 'task_pending');
                else if (childTab === 'history_reward') filteredHistory = filteredHistory.filter(h => h.type === 'redeem_pending');
                else if (childTab === 'history_other') filteredHistory = filteredHistory.filter(h => h.type === 'manual');
                if (historyFilter === 'week') filteredHistory = filteredHistory.filter(h => (now - h.timestamp) < 7 * oneDay);
                else if (historyFilter === 'prev_week') filteredHistory = filteredHistory.filter(h => (now - h.timestamp) >= 7 * oneDay && (now - h.timestamp) < 14 * oneDay);
                else if (historyFilter === 'month') filteredHistory = filteredHistory.filter(h => (now - h.timestamp) < 30 * oneDay);
                const availableCats = data.categories.filter(c => c.type === typeFilter);
                const canRedeemAny = data.rewards.some(r => (r.assignee === 'all' || parseInt(r.assignee) === liveChild.id) && liveChild.points >= r.points);
                const hasUnreadHistory = data.history.some(h => h.childId === liveChild.id && h.status !== 'pending' && h.timestamp > childLastViewedHistory);

                const renderHistoryTab = (subTab, label) => ( <button key={subTab} onClick={() => setChildTab(subTab)} className={`flex-1 py-2 text-xs rounded-lg font-bold transition ${childTab === subTab ? 'bg-ios-indigo text-white' : 'bg-gray-100 text-gray-500'}`}>{label}</button> );

                return (
                    <div className="min-h-screen bg-ios-bg pb-24">
                        {/* Header */}
                        <div className="bg-white px-6 pt-8 pb-6 rounded-b-[40px] shadow-ios sticky top-0 z-20 sticky-header">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => setMode('child_select')} className="w-10 h-10 bg-ios-bg rounded-full text-gray-500 hover:text-ios-blue transition"><i className={Icons.ChevronLeft}></i></button>
                                <span className="font-bold text-lg text-gray-600">Hello~ {liveChild.name}</span>
                                <div className="flex items-center gap-2">
                                    <SyncIcon className="w-8 h-8" />
                                    <div onClick={() => setModalConfig({open: true, type: 'edit_child', data: liveChild})} className="cursor-pointer"><Avatar avatar={liveChild.avatar} size="md" /></div>
                                </div>
                            </div>
                            <div className="flex flex-col items-center mb-6">
                                <div className="flex items-center justify-center gap-4 mb-3">
                                     <div className="flex flex-col items-center">
                                         <div className="text-4xl xs:text-5xl md:text-6xl font-black text-ios-blue tracking-tighter flex items-center gap-3 leading-none">
                                            <i className={`${Icons.Coins} text-2xl xs:text-3xl text-yellow-400`}></i>
                                            {liveChild.points.toLocaleString()}
                                         </div>
                                         <div className="text-xs text-gray-400 font-bold mt-1">ç´¯ç©é»æ•¸</div>
                                     </div>
                                </div>
                                <div className="bg-white/50 px-6 py-2 rounded-full text-ios-indigo font-bold text-xs xs:text-sm shadow-sm animate-fade-in text-center max-w-[90%]">{dailyQuote}</div>
                            </div>
                            {/* Main Tabs - Sticky Container */}
                            <div className="sticky-tabs">
                                <div className="flex bg-ios-bg p-1.5 rounded-2xl shadow-inner relative">
                                    <button onClick={() => {setChildTab('tasks'); setChildFilterCat('all');}} className={`flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition ${childTab === 'tasks' ? 'bg-white shadow text-gray-800' : 'text-gray-400 hover:text-gray-600'}`}><i className={Icons.Task}></i> è³ºé»æ•¸</button>
                                    <button onClick={() => {setChildTab('rewards'); setChildFilterCat('all');}} className={`flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition relative ${childTab === 'rewards' ? 'bg-white shadow text-gray-800' : 'text-gray-400 hover:text-gray-600'}`}><i className={Icons.Reward}></i> æ›çå“{canRedeemAny && <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-ios-red rounded-full animate-pulse"></span>}</button>
                                    <button onClick={() => {setChildTab('history'); updateChildHistoryView();}} className={`flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition relative ${childTab.includes('history') ? 'bg-white shadow text-gray-800' : 'text-gray-400 hover:text-gray-600'}`}><i className={Icons.History}></i> ç´€éŒ„{hasUnreadHistory && !childTab.includes('history') && <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-ios-red rounded-full"></span>}</button>
                                </div>
                                
                                {['tasks', 'rewards'].includes(childTab) && (
                                    <div className="flex gap-2 overflow-x-auto hide-scrollbar mt-4 pb-2">
                                        <button onClick={() => setChildFilterCat('all')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${childFilterCat === 'all' ? 'bg-ios-indigo text-white' : 'bg-white text-gray-500 hover:bg-white/80'}`}>å…¨éƒ¨</button>
                                        {availableCats.map(c => (<button key={c.id} onClick={() => setChildFilterCat(c.id)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${childFilterCat === c.id ? `bg-${c.color}-500 text-white` : 'bg-white text-gray-500 hover:bg-white/80'}`}>{c.name}</button>))}
                                    </div>
                                )}
                                {childTab.includes('history') && (
                                    <div className="flex justify-end mt-4 overflow-x-auto hide-scrollbar">
                                        <div className="bg-white rounded-xl shadow-sm p-1.5 flex gap-1">
                                            {[{id:'week', l:'æœ¬é€±'}, {id:'prev_week', l:'ä¸Šé€±'}, {id:'month', l:'è¿‘30å¤©'}, {id:'all', l:'å…¨éƒ¨'}].map(f => (<button key={f.id} onClick={() => setHistoryFilter(f.id)} className={`px-3 py-1.5 text-xs rounded-lg whitespace-nowrap transition ${historyFilter === f.id ? 'bg-ios-bg font-bold text-ios-indigo' : 'text-gray-400 hover:text-gray-600'}`}>{f.l}</button>))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="p-4 md:p-6">
                            {(childTab === 'tasks' || childTab === 'rewards') && (
                                <div className="grid mobile-grid-1 sm:mobile-grid-2 md:grid-cols-3 gap-4">
                                    {filteredItems.map(item => {
                                        const cat = data.categories.find(c => c.id === item.categoryId);
                                        const canAfford = childTab === 'rewards' ? liveChild.points >= item.points : true;
                                        const isProcessing = processingItems.has(item.id);
                                        const isTask = childTab === 'tasks';
                                        const borderColor = isTask ? 'border-ios-blue' : 'border-ios-pink';
                                        const pointColor = isTask ? 'bg-ios-blue/10 text-ios-blue' : 'bg-ios-pink/10 text-ios-pink';
                                        const sign = isTask ? '+' : '-';

                                        return (
                                            <div key={item.id} onClick={() => { if (isProcessing) return; if (childTab === 'tasks') { handleAction('REQUEST_TASK', item); } else { if (canAfford) { if (item.isRepeatable) { setModalConfig({ open: true, type: 'redeem_repeatable', data: item }); } else { handleAction('REQUEST_REDEEM', { ...item, quantity: 1, totalPoints: item.points }); } } } }} className={`bg-white p-4 rounded-3xl shadow-ios active:scale-95 transition cursor-pointer relative overflow-hidden flex justify-between items-center border-l-4 ${borderColor} ${!canAfford ? 'opacity-60 grayscale' : ''} ${isProcessing ? 'pointer-events-none' : ''}`}>
                                                <div className="flex items-center gap-3 overflow-hidden">
                                                    {cat && <div className={`w-2 h-2 rounded-full bg-${cat.color}-500 flex-shrink-0`}></div>}
                                                    <div className="flex flex-wrap items-baseline gap-2">
                                                        <span className="font-bold text-gray-700 text-lg leading-tight truncate">{item.title}</span>
                                                        {!isTask && item.isRepeatable && (<span className="text-[10px] text-gray-400 bg-gray-50 px-2 py-0.5 rounded-md border border-gray-100 flex-shrink-0">å¯ç´¯è¨ˆ</span>)}
                                                    </div>
                                                </div>
                                                <span className={`${pointColor} px-4 py-1 rounded-full font-bold text-sm shadow-sm whitespace-nowrap ml-2`}>{sign}{item.points.toLocaleString()}</span>
                                            </div>
                                        )
                                    })}
                                    {filteredItems.length === 0 && <div className="col-span-full text-center py-16 text-gray-400 flex flex-col items-center gap-2"><i className="fa-regular fa-folder-open text-4xl opacity-50"></i><p>é€™è£¡ç©ºç©ºçš„å–”ï¼</p></div>}
                                </div>
                            )}

                            {childTab.includes('history') && (
                                <div>
                                    <div className="flex gap-2 mb-4 bg-white p-2 rounded-xl shadow-sm overflow-x-auto hide-scrollbar sticky top-[130px] z-20">
                                        {renderHistoryTab('history', 'å…¨éƒ¨')} {renderHistoryTab('history_task', 'ä»»å‹™')} {renderHistoryTab('history_reward', 'å…Œæ›')} {renderHistoryTab('history_other', 'å…¶ä»–')}
                                    </div>
                                    <div className="bg-white rounded-3xl shadow-ios overflow-hidden border border-white">
                                        {filteredHistory.map((h, i) => (
                                            <div key={i} className="p-4 border-b border-gray-50 last:border-0 flex justify-between items-center hover:bg-gray-50 transition">
                                                <div><div className="font-bold text-gray-700 text-lg">{h.itemName}</div><div className="text-xs text-gray-400 mt-0.5">{new Date(h.timestamp).toLocaleDateString()}</div></div>
                                                <div className="flex items-center gap-2">
                                                    <span className={`font-bold px-2 py-0.5 rounded text-[10px] ${h.status === 'pending' ? 'bg-ios-orange/10 text-ios-orange' : h.status === 'approved' ? 'bg-ios-green/10 text-ios-green' : 'bg-ios-red/10 text-ios-red'}`}>{h.status === 'pending' ? 'å¯©æ ¸ä¸­' : h.status === 'approved' ? 'æ ¸å‡†' : 'é€€å›'}</span>
                                                    {h.status !== 'rejected' && (<div className={`font-bold text-xl ${h.type.includes('task') || (h.type === 'manual' && h.points > 0) ? 'text-ios-blue' : 'text-ios-pink'}`}>{h.type.includes('task') || (h.type === 'manual' && h.points > 0) ? '+' : '-'}{Math.abs(h.points).toLocaleString()}</div>)}
                                                </div>
                                            </div>
                                        ))}
                                        {filteredHistory.length === 0 && <div className="p-10 text-center text-gray-400 flex flex-col items-center gap-2"><i className="fa-regular fa-clock text-3xl opacity-50"></i><p>æ²’æœ‰ç´€éŒ„</p></div>}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {(modalConfig.type === 'edit_child') && <ChildModal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} type="edit_child" data={modalConfig.data} onSave={payload => { handleAction('EDIT_CHILD', payload); setModalConfig({ ...modalConfig, open: false }); }} key={modalConfig.open ? 'open' : 'closed'} />}
                        {modalConfig.type === 'redeem_repeatable' && <RedeemQuantityModal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} data={modalConfig.data} userPoints={currentChild.points} onConfirm={(qty, totalPoints) => { if (!processingItems.has(modalConfig.data.id)) { handleAction('REQUEST_REDEEM', { ...modalConfig.data, quantity: qty, totalPoints: totalPoints }); setModalConfig({ ...modalConfig, open: false }); } }} processing={processingItems.has(modalConfig.data.id)} />}
                        {modalConfig.type === 'redeem_confirm' && <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="ç¢ºèªå…Œæ›"><div className="flex flex-col items-center gap-4 text-center p-2"><div className="text-5xl animate-bounce">ğŸ</div><p className="text-gray-600 text-lg">ç¢ºå®šè¦å…Œæ› <br/><span className="text-xl font-bold text-ios-indigo">{modalConfig.data.title}</span> å—ï¼Ÿ</p><div className="bg-ios-pink/10 text-ios-pink px-4 py-2 rounded-xl font-bold text-2xl">-{modalConfig.data.points.toLocaleString()} é»</div><div className="flex gap-3 w-full mt-4"><button onClick={() => setModalConfig({ ...modalConfig, open: false })} className="flex-1 py-3 rounded-xl border-2 border-gray-100 font-bold text-gray-500 hover:bg-gray-50">å†æƒ³æƒ³</button><button onClick={() => { if (!isSubmitting) { handleAction('REQUEST_REDEEM', { ...modalConfig.data, quantity: 1, totalPoints: modalConfig.data.points }); setModalConfig({ ...modalConfig, open: false }); } }} className="flex-1 py-3 rounded-xl bg-ios-pink text-white font-bold shadow-lg active:scale-95 transition" disabled={isSubmitting}>ç¢ºå®šå…Œæ›</button></div></div></Modal>}
                        {modalConfig.type === 'confirm_delete' && <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={modalConfig.data.title}><div className="flex flex-col gap-4"><p className="text-gray-600 text-lg">{modalConfig.data.message}</p><div className="flex gap-3"><button onClick={() => setModalConfig({ ...modalConfig, open: false })} className="flex-1 py-3 rounded-xl border-2 border-gray-100 font-bold text-gray-500 hover:bg-gray-50">å–æ¶ˆ</button><button onClick={() => { modalConfig.data.onConfirm(); setModalConfig({ ...modalConfig, open: false }); }} className="flex-1 py-3 rounded-xl bg-ios-red text-white font-bold shadow-lg active:scale-95 transition">åˆªé™¤</button></div></div></Modal>}

                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            // Parent Dashboard
            if (mode === 'parent') {
                const pendingItems = data.history.filter(h => h.status === 'pending');
                const pendingTasks = pendingItems.filter(h => h.type === 'task_pending');
                const pendingRewards = pendingItems.filter(h => h.type === 'redeem_pending');
                
                const activePendingList = parentApprovalTab === 'tasks' ? pendingTasks : pendingRewards;
                const categories = data.categories || [];
                
                const activeCollection = parentTab === 'tasks' ? data.tasks : (parentTab === 'rewards' ? data.rewards : []);
                const typeFilter = parentTab === 'tasks' ? 'task' : 'reward';
                
                let filteredParentItems = activeCollection;
                if (parentFilterCat !== 'all') {
                    filteredParentItems = filteredParentItems.filter(i => i.categoryId === parentFilterCat);
                }
                const availableCats = categories.filter(c => c.type === typeFilter);

                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row pb-20 md:pb-0">
                        <div className="hidden md:block fixed top-4 right-4 z-50"><SyncIcon /></div>
                        {/* Sidebar */}
                        <div className={`hidden md:flex sidebar-transition fixed bottom-0 left-0 top-0 z-30 bg-white border-r border-gray-200 flex-col shadow-lg relative ${isSidebarCollapsed ? 'w-20' : 'w-48'}`}>
                            <button onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)} className={`w-8 h-8 flex items-center justify-center bg-white text-gray-400 hover:text-gray-600 border border-gray-200 rounded-full shadow-sm transition-all z-50 ${isSidebarCollapsed ? 'mx-auto mt-6 mb-2' : 'absolute top-1/2 -translate-y-1/2 -right-4'}`}><i className={`text-xs ${isSidebarCollapsed ? Icons.ChevronRight : Icons.ChevronLeft}`}></i></button>
                            <div className="flex-1 flex flex-col gap-2 p-3 overflow-y-auto mt-2">
                                {['approvals', 'tasks', 'rewards', 'children', 'settings'].map(tab => (
                                    <button key={tab} onClick={() => {setParentTab(tab); setParentFilterCat('all');}} className={`p-3 rounded-xl flex items-center transition relative ${parentTab === tab ? 'text-ios-indigo bg-ios-indigo/10 font-bold' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'} ${isSidebarCollapsed ? 'justify-center' : 'justify-start gap-3'}`}>
                                        <i className={`text-xl w-6 text-center ${tab === 'approvals' ? Icons.Check : tab === 'tasks' ? Icons.Task : tab === 'rewards' ? Icons.Reward : tab === 'children' ? Icons.Child : Icons.Settings}`}></i>
                                        {!isSidebarCollapsed && <span className="text-base font-medium capitalize">{tab === 'approvals' ? 'å¾…å¯©æ ¸' : tab === 'tasks' ? 'ä»»å‹™' : tab === 'rewards' ? 'çå‹µ' : tab === 'children' ? 'å°å­©' : 'è¨­å®š'}</span>}
                                        {tab === 'approvals' && pendingItems.length > 0 && <span className={`bg-ios-red text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center absolute shadow-sm font-bold ${isSidebarCollapsed ? 'top-1 right-1' : 'top-1/2 -translate-y-1/2 right-4'}`}>{pendingItems.length}</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="p-3 border-t">
                                <button onClick={() => setMode('landing')} className={`flex items-center text-gray-400 hover:text-ios-red p-3 rounded-xl transition ${isSidebarCollapsed ? 'justify-center' : 'justify-start gap-4'}`}><i className={`w-6 text-center ${Icons.Exit}`}></i>{!isSidebarCollapsed && <span className="font-medium">é€€å‡º</span>}</button>
                            </div>
                        </div>

                         {/* Mobile Bottom Floating Nav */}
                        <div className="md:hidden fixed bottom-6 left-4 right-4 bg-white/90 backdrop-blur-md border border-gray-100 rounded-2xl shadow-xl z-40 flex justify-between items-center p-2 px-4">
                            {['approvals', 'tasks', 'rewards', 'children', 'settings'].map(tab => (
                                <button key={tab} onClick={() => {setParentTab(tab); setParentFilterCat('all');}} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition relative flex-1 ${parentTab === tab ? 'text-ios-indigo' : 'text-gray-400'}`}>
                                    <i className={`text-xl ${tab === 'approvals' ? Icons.Check : tab === 'tasks' ? Icons.Task : tab === 'rewards' ? Icons.Reward : tab === 'children' ? Icons.Child : Icons.Settings}`}></i>
                                    <span className="text-[10px] font-bold">{tab === 'approvals' ? 'å¾…å¯©æ ¸' : tab === 'tasks' ? 'ä»»å‹™' : tab === 'rewards' ? 'çå‹µ' : tab === 'children' ? 'å°å­©' : 'è¨­å®š'}</span>
                                    {tab === 'approvals' && pendingItems.length > 0 && <span className="absolute top-2 right-1/4 w-2 h-2 bg-ios-red rounded-full"></span>}
                                </button>
                            ))}
                            <button onClick={() => setMode('landing')} className="flex flex-col items-center gap-1 p-2 rounded-xl text-gray-400 flex-1">
                                <i className={`text-xl ${Icons.Exit}`}></i>
                                <span className="text-[10px] font-bold">é€€å‡º</span>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 p-4 md:p-6 overflow-y-auto h-screen">
                            <div className="flex justify-between items-center mb-4 md:mb-6">
                                <h1 className="text-2xl md:text-3xl font-bold text-gray-800 capitalize">{parentTab === 'approvals' ? 'å¯©æ ¸ç”³è«‹' : parentTab === 'tasks' ? 'ä»»å‹™ç®¡ç†' : parentTab === 'rewards' ? 'çå‹µç®¡ç†' : parentTab === 'children' ? 'å°å­©ç®¡ç†' : 'ç³»çµ±è¨­å®š'}</h1>
                                <div className="md:hidden"><SyncIcon /></div>
                            </div>
                            
                            {parentTab === 'approvals' && (
                                <div className="space-y-4">
                                    <div className="flex gap-4 mb-4">
                                        <button onClick={() => setParentApprovalTab('tasks')} className={`flex-1 py-3 rounded-xl font-bold relative ${parentApprovalTab === 'tasks' ? 'bg-white shadow text-ios-blue' : 'text-gray-400 hover:bg-white/50'}`}>
                                            ä»»å‹™ ({pendingTasks.length})
                                            {pendingTasks.length > 0 && <span className="absolute top-1/2 -translate-y-1/2 right-4 w-5 h-5 bg-ios-red text-white text-[10px] rounded-full flex items-center justify-center">{pendingTasks.length}</span>}
                                        </button>
                                        <button onClick={() => setParentApprovalTab('rewards')} className={`flex-1 py-3 rounded-xl font-bold relative ${parentApprovalTab === 'rewards' ? 'bg-white shadow text-ios-pink' : 'text-gray-400 hover:bg-white/50'}`}>
                                            å…Œæ› ({pendingRewards.length})
                                            {pendingRewards.length > 0 && <span className="absolute top-1/2 -translate-y-1/2 right-4 w-5 h-5 bg-ios-red text-white text-[10px] rounded-full flex items-center justify-center">{pendingRewards.length}</span>}
                                        </button>
                                    </div>
                                    
                                    {/* Bulk Actions */}
                                    {activePendingList.length > 0 && (
                                        <div className="flex gap-3 mb-4">
                                            <button onClick={() => handleAction('REJECT_ALL', { items: activePendingList })} className="flex-1 py-2 rounded-xl border-2 border-gray-200 text-gray-500 font-bold hover:bg-gray-50 transition">å…¨éƒ¨é§å›</button>
                                            <button onClick={() => handleAction('APPROVE_ALL', { items: activePendingList })} className="flex-1 py-2 rounded-xl bg-ios-indigo text-white font-bold shadow-md hover:opacity-90 transition">å…¨éƒ¨æ‰¹å‡†</button>
                                        </div>
                                    )}

                                    {activePendingList.map(item => {
                                        const child = data.children.find(c => c.id === item.childId);
                                        return (
                                            <div key={item.id} className="bg-white p-4 md:p-6 rounded-3xl shadow-ios flex flex-col md:flex-row justify-between items-center gap-4 md:gap-6 border border-white">
                                                <div className="flex items-center gap-4 w-full md:w-auto">
                                                    <Avatar avatar={child?.avatar} size="lg" />
                                                    <div>
                                                        <div className="font-bold text-gray-800 text-xl">{child?.name} <span className="text-gray-400 font-normal text-base">ç”³è«‹</span></div>
                                                        <div className={`font-bold text-lg mt-1 ${item.type === 'task_pending' ? 'text-ios-blue' : 'text-ios-pink'}`}>{item.itemName} <span className="text-gray-500 text-base font-normal">({item.points.toLocaleString()} é»)</span></div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-3 w-full md:w-auto">
                                                    <button onClick={() => handleAction('REJECT', item)} className="flex-1 py-3 px-6 md:px-8 rounded-xl border-2 border-gray-100 text-gray-500 font-bold hover:bg-gray-50">é§å›</button>
                                                    <button onClick={() => handleAction('APPROVE', item)} className={`flex-1 py-3 px-6 md:px-8 rounded-xl text-white font-bold shadow-lg hover:opacity-90 ${item.type === 'task_pending' ? 'bg-ios-blue' : 'bg-ios-pink'}`}>æ‰¹å‡†</button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                    {activePendingList.length === 0 && (
                                        <div className="text-center py-20 md:py-32 text-gray-400 flex flex-col items-center gap-4">
                                            <i className="fa-regular fa-face-smile text-6xl opacity-30"></i>
                                            <p className="text-lg">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸é …ç›®ï¼Œå¤ªæ£’äº†ï¼</p>
                                        </div>
                                    )}
                                    <div className="mt-8 border-t pt-8">
                                        <button onClick={() => setModalConfig({ open: true, type: 'manual_adjust' })} className="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 p-4 rounded-2xl font-bold hover:border-ios-indigo hover:text-ios-indigo hover:bg-ios-bg transition">+ æ‰‹å‹•çæ‡² (åŠ /æ‰£é»)</button>
                                    </div>
                                </div>
                            )}

                            {/* ... (Existing Task/Reward/Children/Settings Sections) ... */}
                            {(parentTab === 'tasks' || parentTab === 'rewards') && (
                                <div>
                                    <div className="flex flex-wrap gap-3 mb-6">
                                        <button onClick={() => setModalConfig({ open: true, type: parentTab === 'tasks' ? 'add_task' : 'add_reward' })} className="flex-1 bg-ios-indigo text-white p-4 rounded-2xl shadow-ios font-bold flex items-center justify-center gap-2 min-w-[120px] md:min-w-[150px] hover:opacity-90 transition"><i className={Icons.Plus}></i> æ–°å¢{parentTab === 'tasks' ? 'ä»»å‹™' : 'çå‹µ'}</button>
                                        <button onClick={() => setModalConfig({ open: true, type: 'manage_categories', categoryType: typeFilter })} className="px-4 md:px-6 bg-white text-gray-600 rounded-2xl shadow-sm border border-gray-200 font-bold hover:bg-gray-50"><i className={Icons.Filter}></i> ç®¡ç†åˆ†é¡</button>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto hide-scrollbar mb-6 pb-2">
                                        <button onClick={() => setParentFilterCat('all')} className={`px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${parentFilterCat === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-500 hover:bg-white/80'}`}>å…¨éƒ¨</button>
                                        {availableCats.map(c => (
                                            <button key={c.id} onClick={() => setParentFilterCat(c.id)} className={`px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm ${parentFilterCat === c.id ? `bg-${c.color}-500 text-white` : 'bg-white text-gray-500 hover:bg-white/80'}`}>
                                                {c.name}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="grid mobile-grid-1 sm:mobile-grid-2 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                                        {sortItems(filteredParentItems).map(item => {
                                            const cat = categories.find(c => c.id === item.categoryId);
                                            const assigneeName = item.assignee === 'all' ? 'æ‰€æœ‰äºº' : (data.children.find(c => c.id == item.assignee)?.name || 'æœªçŸ¥');
                                            return (
                                                <div key={item.id} className="bg-white p-4 md:p-5 rounded-3xl shadow-sm relative group border border-gray-100 hover:shadow-md transition">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="font-bold text-gray-800 text-lg md:text-xl flex items-center gap-2 flex-wrap">
                                                            {item.title}
                                                        </div>
                                                        {cat && <span className={`text-[10px] px-2 py-0.5 rounded-full text-white font-bold bg-${cat.color}-500`}>{cat.name}</span>}
                                                    </div>
                                                    
                                                    <div className="flex justify-between items-center">
                                                        <div className="text-sm text-gray-500 flex flex-wrap items-center gap-2">
                                                            <span className={`font-bold px-2 py-0.5 rounded-md ${parentTab === 'tasks' ? 'bg-ios-blue/10 text-ios-blue' : 'bg-ios-pink/10 text-ios-pink'}`}>{item.points.toLocaleString()} é»</span>
                                                            <span className="text-[10px] text-gray-500 bg-gray-50 px-2 py-0.5 rounded-full border border-gray-200 flex items-center gap-1"><i className="fa-solid fa-user-group text-xs"></i> {assigneeName}</span>
                                                            {item.isRepeatable && <span className="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">å¯ç´¯è¨ˆ</span>}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setModalConfig({ open: true, type: parentTab === 'tasks' ? 'edit_task' : 'edit_reward', data: item })} className="text-gray-400 hover:text-ios-blue p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Edit}></i></button>
                                                            <button onClick={() => {
                                                                setModalConfig({ 
                                                                    open: true, 
                                                                    type: 'confirm_delete', 
                                                                    data: { 
                                                                        title: 'åˆªé™¤é …ç›®', 
                                                                        message: `ç¢ºå®šè¦åˆªé™¤ "${item.title}" å—ï¼Ÿ`, 
                                                                        onConfirm: () => handleAction('DELETE_ITEM', { collection: parentTab, id: item.id }) 
                                                                    } 
                                                                });
                                                            }} className="text-gray-400 hover:text-ios-red p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Trash}></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                        {filteredParentItems.length === 0 && <div className="col-span-full text-center py-20 text-gray-400 flex flex-col items-center gap-2"><i className="fa-regular fa-folder-open text-4xl opacity-50"></i><p>æ­¤åˆ†é¡æ²’æœ‰é …ç›®</p></div>}
                                    </div>
                                </div>
                            )}

                            {parentTab === 'children' && (
                                <div>
                                    <div className="grid mobile-grid-1 sm:mobile-grid-2 md:grid-cols-2 gap-6">
                                        {data.children.map(child => (
                                            <div key={child.id} className="bg-white p-6 rounded-3xl shadow-ios flex items-center gap-6 relative border border-white hover:border-ios-blue/30 transition">
                                                <Avatar avatar={child.avatar} size="xl" />
                                                <div>
                                                    <div className="font-bold text-2xl text-gray-800">{child.name}</div>
                                                    <div className="text-ios-indigo font-bold text-lg mt-1">{child.points.toLocaleString()} é»</div>
                                                </div>
                                                <div className="absolute top-4 right-4 flex gap-1">
                                                    <button onClick={() => setModalConfig({ open: true, type: 'edit_child', data: child })} className="text-gray-300 hover:text-ios-blue p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Edit}></i></button>
                                                    <button onClick={() => {
                                                        setModalConfig({ 
                                                            open: true, 
                                                            type: 'confirm_delete', 
                                                            data: { 
                                                                title: 'åˆªé™¤å°å­©', 
                                                                message: `ç¢ºå®šè¦åˆªé™¤ ${child.name} å—ï¼Ÿè³‡æ–™å°‡ç„¡æ³•å¾©åŸã€‚`, 
                                                                onConfirm: () => handleAction('DELETE_ITEM', { collection: 'children', id: child.id }) 
                                                            } 
                                                        });
                                                    }} className="text-gray-300 hover:text-ios-red p-2 rounded-full hover:bg-gray-50 transition"><i className={Icons.Trash}></i></button>
                                                </div>
                                            </div>
                                        ))}
                                        <button onClick={() => setModalConfig({ open: true, type: 'add_child' })} className="bg-gray-50 border-2 border-dashed border-gray-300 text-gray-400 p-6 rounded-3xl flex flex-col items-center justify-center gap-2 hover:border-ios-blue hover:text-ios-blue hover:bg-white transition min-h-[140px] font-bold"><i className={`${Icons.Plus} text-3xl`}></i> æ–°å¢å°å­©</button>
                                    </div>
                                </div>
                            )}

                            {parentTab === 'settings' && (
                                <div className="space-y-8 max-w-lg mx-auto md:mx-0">
                                    <div className="bg-white p-8 rounded-3xl shadow-ios border border-white">
                                        <h3 className="font-bold text-gray-800 mb-6 text-xl flex items-center gap-2"><i className="fa-solid fa-key text-ios-indigo"></i> å®¶é•·å¯†ç¢¼</h3>
                                        <div className="relative">
                                            <input type={showParentPass ? "text" : "password"} value={tempParentPass} onChange={(e) => setTempParentPass(e.target.value)} className="w-full bg-ios-bg p-4 rounded-xl outline-none border border-transparent focus:border-ios-indigo focus:bg-white transition font-mono text-lg tracking-widest" maxLength="4" />
                                            <button onClick={() => setShowParentPass(!showParentPass)} className="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><i className={showParentPass ? Icons.EyeSlash : Icons.Eye}></i></button>
                                        </div>
                                        <button onClick={() => { localStorage.setItem('parent_pass', tempParentPass); setParentPass(tempParentPass); showToast("å¯†ç¢¼å·²æ›´æ–°"); }} className="w-full bg-ios-indigo text-white p-4 rounded-xl font-bold mt-4 shadow-lg hover:opacity-90 transition">å„²å­˜æ–°å¯†ç¢¼</button>
                                    </div>
                                    <div className="bg-white p-8 rounded-3xl shadow-ios border border-white">
                                        <h3 className="font-bold text-gray-800 mb-6 text-xl flex items-center gap-2"><i className="fa-brands fa-github text-gray-700"></i> Github Sync</h3>
                                        <p className="text-sm text-gray-500 mb-4">è¼¸å…¥ Token ä»¥å•Ÿç”¨é›²ç«¯å‚™ä»½åŠŸèƒ½ã€‚</p>
                                        <div className="relative">
                                            <input type={showToken ? "text" : "password"} value={ghToken} onChange={(e) => setGhToken(e.target.value)} className="w-full bg-ios-bg p-4 rounded-xl outline-none border border-transparent focus:border-gray-800 focus:bg-white transition font-mono text-sm" placeholder="ghp_..." />
                                            <button onClick={() => setShowToken(!showToken)} className="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><i className={showToken ? Icons.EyeSlash : Icons.Eye}></i></button>
                                        </div>
                                        <button onClick={() => { let t = ghToken.trim(); if (t && !t.startsWith('ghp_') && !t.startsWith('github_pat_')) t = 'ghp_' + t; setGhToken(t); localStorage.setItem('gh_token', t); fetchData(t); }} className="w-full bg-gray-800 text-white p-4 rounded-xl font-bold mt-4 shadow-lg hover:opacity-90 transition">å„²å­˜ä¸¦æ¸¬è©¦é€£ç·š</button>
                                    </div>
                                </div>
                            )}

                        </div>

                        {(modalConfig.type === 'add_child' || modalConfig.type === 'edit_child') && <ChildModal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} type={modalConfig.type} data={modalConfig.data} onSave={p => { handleAction(modalConfig.type === 'edit_child' ? 'EDIT_CHILD' : 'ADD_CHILD', p); setModalConfig({ ...modalConfig, open: false }); }} key={modalConfig.open ? 'open' : 'closed'} />}
                        {modalConfig.type.includes('task') || modalConfig.type.includes('reward') ? <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={modalConfig.type.includes('add') ? 'æ–°å¢' : 'ç·¨è¼¯'}><form onSubmit={(e) => { e.preventDefault(); const payload = { id: modalConfig.data?.id, title: e.target.title.value, points: parseInt(e.target.points.value), assignee: e.target.assignee.value, categoryId: e.target.categoryId.value, isRepeatable: e.target.isRepeatable?.checked }; handleAction(modalConfig.type.includes('add') ? (modalConfig.type.includes('task') ? 'ADD_TASK' : 'ADD_REWARD') : (modalConfig.type.includes('task') ? 'EDIT_TASK' : 'EDIT_REWARD'), payload); setModalConfig({ ...modalConfig, open: false }); }} className="flex flex-col gap-4"><input name="title" placeholder="åç¨±" defaultValue={modalConfig.data?.title} required className="bg-ios-bg p-3 rounded-xl outline-none focus:ring-2 focus:ring-ios-blue" /><div className="flex gap-2"><input type="number" name="points" placeholder="é»æ•¸" defaultValue={modalConfig.data?.points} required className="bg-ios-bg p-3 rounded-xl flex-1 outline-none focus:ring-2 focus:ring-ios-blue" /><div className="relative flex-1"><select name="categoryId" defaultValue={modalConfig.data?.categoryId} className="w-full bg-ios-bg p-3 rounded-xl appearance-none custom-select outline-none focus:ring-2 focus:ring-ios-blue"><option value="">ç„¡åˆ†é¡</option>{data.categories.filter(c => c.type === (modalConfig.type.includes('task') ? 'task' : 'reward')).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div></div><div className="relative"><select name="assignee" defaultValue={modalConfig.data?.assignee || 'all'} className="w-full bg-ios-bg p-3 rounded-xl appearance-none custom-select outline-none focus:ring-2 focus:ring-ios-blue"><option value="all">æ‰€æœ‰äºº</option>{data.children.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>{modalConfig.type.includes('reward') && <label className="flex items-center gap-3 p-3 bg-ios-bg rounded-xl cursor-pointer"><input type="checkbox" name="isRepeatable" defaultChecked={modalConfig.data?.isRepeatable} className="w-5 h-5 accent-ios-green rounded" /><span className="text-gray-600 font-bold text-sm">å¯ç´¯è¨ˆå…Œæ›</span></label>}<button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition">å„²å­˜</button></form></Modal> : null}
                        {modalConfig.type === 'manual_adjust' && <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="æ‰‹å‹•çæ‡²"><form onSubmit={(e) => { e.preventDefault(); const pts = parseInt(e.target.points.value); handleAction('MANUAL_ADJUST', { childId: e.target.childId.value, points: e.target.type.value === 'deduct' ? -pts : pts, reason: e.target.reason.value }); setModalConfig({ ...modalConfig, open: false }); }} className="flex flex-col gap-4"><select name="childId" className="bg-ios-bg p-3 rounded-xl custom-select outline-none focus:ring-2 focus:ring-ios-blue" required>{data.children.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select><div className="flex gap-4"><label className="flex-1 flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer has-[:checked]:bg-ios-green/10 has-[:checked]:text-ios-green border border-transparent has-[:checked]:border-ios-green transition font-bold"><input type="radio" name="type" value="add" defaultChecked className="hidden" /> åŠ åˆ†</label><label className="flex-1 flex items-center justify-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer has-[:checked]:bg-ios-red/10 has-[:checked]:text-ios-red border border-transparent has-[:checked]:border-ios-red transition font-bold"><input type="radio" name="type" value="deduct" className="hidden" /> æ‰£åˆ†</label></div><input type="number" name="points" placeholder="é»æ•¸" required className="bg-ios-bg p-3 rounded-xl outline-none focus:ring-2 focus:ring-ios-blue" /><input name="reason" placeholder="åŸå› " required className="bg-ios-bg p-3 rounded-xl outline-none focus:ring-2 focus:ring-ios-blue" /><button className="bg-ios-indigo text-white p-3 rounded-xl font-bold mt-2 shadow-lg active:scale-95 transition">åŸ·è¡Œ</button></form></Modal>}
                        {modalConfig.type === 'manage_categories' && <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={`ç®¡ç†${modalConfig.categoryType === 'task' ? 'ä»»å‹™' : 'çå‹µ'}åˆ†é¡`}><CategoryManager categories={data.categories} type={modalConfig.categoryType} onEdit={payload => handleAction('EDIT_CATEGORY', payload)} onDelete={id => { setModalConfig({ open: true, type: 'confirm_delete', data: { title: 'åˆªé™¤åˆ†é¡', message: `ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡å—ï¼Ÿèˆ‡æ­¤åˆ†é¡é—œè¯çš„é …ç›®å°‡è®Šç‚ºã€Œç„¡åˆ†é¡ã€ã€‚`, onConfirm: () => handleAction('DELETE_CATEGORY', { id }) } }); }} onAdd={payload => handleAction('ADD_CATEGORY', payload)} /></Modal>}
                        {modalConfig.type === 'redeem_repeatable' && <RedeemQuantityModal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} data={modalConfig.data} userPoints={currentChild.points} onConfirm={(qty, totalPoints) => { if (!processingItems.has(modalConfig.data.id)) { handleAction('REQUEST_REDEEM', { ...modalConfig.data, quantity: qty, totalPoints: totalPoints }); setModalConfig({ ...modalConfig, open: false }); } }} processing={processingItems.has(modalConfig.data.id)} />}
                        {modalConfig.type === 'redeem_confirm' && <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title="ç¢ºèªå…Œæ›"><div className="flex flex-col items-center gap-4 text-center p-2"><div className="text-5xl animate-bounce">ğŸ</div><p className="text-gray-600 text-lg">ç¢ºå®šè¦å…Œæ› <br/><span className="text-xl font-bold text-ios-indigo">{modalConfig.data.title}</span> å—ï¼Ÿ</p><div className="bg-ios-pink/10 text-ios-pink px-4 py-2 rounded-xl font-bold text-2xl">-{modalConfig.data.points.toLocaleString()} é»</div><div className="flex gap-3 w-full mt-4"><button onClick={() => setModalConfig({ ...modalConfig, open: false })} className="flex-1 py-3 rounded-xl border-2 border-gray-100 font-bold text-gray-500 hover:bg-gray-50">å†æƒ³æƒ³</button><button onClick={() => { if (!isSubmitting) { handleAction('REQUEST_REDEEM', { ...modalConfig.data, quantity: 1, totalPoints: modalConfig.data.points }); setModalConfig({ ...modalConfig, open: false }); } }} className="flex-1 py-3 rounded-xl bg-ios-pink text-white font-bold shadow-lg active:scale-95 transition" disabled={isSubmitting}>ç¢ºå®šå…Œæ›</button></div></div></Modal>}
                        {modalConfig.type === 'confirm_delete' && <Modal isOpen={modalConfig.open} onClose={() => setModalConfig({ ...modalConfig, open: false })} title={modalConfig.data.title}><div className="flex flex-col gap-4"><p className="text-gray-600 text-lg">{modalConfig.data.message}</p><div className="flex gap-3"><button onClick={() => setModalConfig({ ...modalConfig, open: false })} className="flex-1 py-3 rounded-xl border-2 border-gray-100 font-bold text-gray-500 hover:bg-gray-50">å–æ¶ˆ</button><button onClick={() => { modalConfig.data.onConfirm(); setModalConfig({ ...modalConfig, open: false }); }} className="flex-1 py-3 rounded-xl bg-ios-red text-white font-bold shadow-lg active:scale-95 transition">åˆªé™¤</button></div></div></Modal>}

                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
