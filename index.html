<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>好寶寶集點卡</title>
    <!-- React Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #FFDEE9 0%, #B5FFFC 100%);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        .glass { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .glass-dark { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.8); }
        .glass-card { background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); transition: transform 0.1s ease, box-shadow 0.2s ease; }
        .glass-card:active { transform: scale(0.95); }
        
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; border: 2px dashed #6366f1; }
        .sortable-drag { cursor: grabbing; }
        .drag-handle { cursor: grab; touch-action: none; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-[100dvh] w-screen overflow-hidden text-slate-800 selection:bg-pink-200">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef, useCallback } = React;

        // =============== ☁️ GitHub 設定區 ===============
        const GITHUB_CONFIG = {
            TOKEN_PART: "uGYqNrODupI2hp9QjKSZCVtSygLzwB1jY42B", 
            REPO: "zenningh1983/goodbaby", 
            PATH: "data.json" 
        };
        // ================================================

        const isGithubConfigValid = () => {
            const { TOKEN_PART, REPO } = GITHUB_CONFIG;
            if (!TOKEN_PART || !REPO) return false;
            if (/[^\x00-\x7F]/.test(TOKEN_PART)) return false;
            return true;
        };

        const getRealToken = () => {
            if (!GITHUB_CONFIG.TOKEN_PART) return "";
            return "ghp_" + GITHUB_CONFIG.TOKEN_PART;
        };

        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Icons = {
            Trophy: (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>,
            Gift: (p) => <IconBase {...p}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            User: (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
            Trash: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>,
            FileDown: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            FileUp: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            ShieldCheck: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>,
            Star: (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>,
            Edit: (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Cloud: (p) => <IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>,
            CloudCheck: (p) => <IconBase {...p}><path d="M12 21a9 9 0 0 0 9-9 9 9 0 0 0-9-9 9 9 0 0 0-9 9"/><path d="M9 12l2 2 4-4"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconBase>,
            Github: (p) => <IconBase {...p}><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></IconBase>,
            ThumbsUp: (p) => <IconBase {...p}><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></IconBase>,
            ThumbsDown: (p) => <IconBase {...p}><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></IconBase>,
            GripVertical: (p) => <IconBase {...p}><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></IconBase>,
            Tag: (p) => <IconBase {...p}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></IconBase>,
            Folder: (p) => <IconBase {...p}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></IconBase>,
            FolderOpen: (p) => <IconBase {...p}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></IconBase>
        };

        const { Trophy, Gift, Settings, User, Users, Check, X, Plus, Trash, Upload, FileDown, FileUp, Clock, ShieldCheck, LogOut, Star, Edit, Heart, Lock, AlertTriangle, Cloud, CloudCheck, RefreshCw, Github, ThumbsUp, ThumbsDown, GripVertical, Tag, Folder, FolderOpen } = Icons;

        const DEFAULT_PASSWORD = "0000";
        const DEFAULT_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234F46E5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E";

        const INITIAL_DATA = {
            kids: [
                { id: "k1", name: "蕃茄", balance: 0, avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234F46E5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E" },
                { id: "k1764842571109", name: "茹茹", balance: 0, avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234F46E5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E" }
            ],
            taskCategories: [
                { id: 'tc1', name: '生活習慣' },
                { id: 'tc2', name: '家事打掃' },
                { id: 'tc3', name: '學科' }
            ],
            rewardCategories: [
                { id: 'rc1', name: '休閒娛樂' },
                { id: 'rc2', name: '實質獎勵' }
            ],
            tasks: [
                { id: "t1", title: "整理書桌", points: 3000, categoryId: 'tc1', assignedTo: ["k1"] },
                { id: "t2", title: "洗便當洗水壺", points: 3000, categoryId: 'tc2', assignedTo: ["k1"] },
                { id: "t3", title: "準時睡覺 (22:00)", points: 8000, categoryId: 'tc1', assignedTo: ["k1"] },
                { id: "t1764842844312", title: "準時起床 (06:30)", points: 8000, categoryId: 'tc1', assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764842872007", title: "做家事", points: 5000, categoryId: 'tc2', assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764842930203", title: "打掃", points: 10000, categoryId: 'tc2', assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764842976525", title: "主動拿出聯絡簿", points: 2500, categoryId: 'tc1', assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764843506878", title: "大考 100 分", points: 50000, categoryId: 'tc3', assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764843524965", title: "大考 90 分以上", points: 30000, categoryId: 'tc3', assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764843549090", title: "大考 80 分以上", points: 10000, assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764843702178", title: "大考平均 90 以上", points: 50000, assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764843718325", title: "大考平均 80 以上", points: 30000, assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764843871614", title: "看完一本文字書（有心得）", points: 30000, assignedTo: ["k1", "k1764842571109"] },
                { id: "t1764844777928", title: "test", points: 1, assignedTo: ["k1", "k1764842571109"] }
            ],
            rewards: [
                { id: "r1", title: "看電視 30 分鐘", cost: 20000, categoryId: 'rc1' },
                { id: "r3", title: "久大文具 $100", cost: 25000, categoryId: 'rc2' },
                { id: "r1764842755781", title: "玩 3C 15 分鐘", cost: 20000, categoryId: 'rc1', assignedTo: ["k1", "k1764842571109"] },
                { id: "r1764842788062", title: "住婆婆家", cost: 50000, categoryId: 'rc1', assignedTo: ["k1", "k1764842571109"] },
                { id: "r1764842804595", title: "同學住我們家", cost: 50000, categoryId: 'rc1', assignedTo: ["k1", "k1764842571109"] },
                { id: "r1764843590291", title: "小時候彈珠 $100", cost: 25000, categoryId: 'rc1', assignedTo: ["k1", "k1764842571109"] },
                { id: "r1764843641021", title: "零用錢 $200", cost: 50000, categoryId: 'rc2', assignedTo: ["k1", "k1764842571109"] },
                { id: "r1764843744900", title: "喝手搖飲", cost: 20000, categoryId: 'rc1', assignedTo: ["k1", "k1764842571109"] }
            ],
            requests: [],
            settings: {
                password: "1007"
            }
        };

        // UI Components
        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const base = "px-4 py-3 rounded-2xl font-bold transition-all active:scale-95 flex items-center justify-center gap-2 shadow-sm whitespace-nowrap";
            const variants = {
                primary: "bg-blue-500 text-white shadow-blue-200 hover:bg-blue-600",
                success: "bg-green-500 text-white shadow-green-200 hover:bg-green-600",
                danger: "bg-red-400 text-white shadow-red-200 hover:bg-red-500",
                glass: "glass text-slate-700 hover:bg-white/80",
                ghost: "bg-transparent text-slate-500 hover:bg-slate-100",
                outline: "border-2 border-slate-300 text-slate-500 hover:border-slate-400"
            };
            return <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} {...props}>{children}</button>;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-sm p-4 animate-pop">
                    <div className="glass-dark w-full max-w-md rounded-3xl p-6 shadow-2xl flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center mb-4 shrink-0">
                            <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100/50 text-slate-500"><X size={24} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 2500); return () => clearTimeout(timer); }, [onClose]);
            const colors = { success: 'bg-green-500 text-white', error: 'bg-red-500 text-white', info: 'bg-blue-500 text-white' };
            return (
                <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-xl flex items-center gap-3 animate-pop ${colors[type] || colors.info}`}>
                    {type === 'success' ? <Check size={20} /> : <ShieldCheck size={20} />}
                    <span className="font-bold">{message}</span>
                </div>
            );
        };

        // Views
        const KidView = ({ kid, tasks, rewards, requests, taskCategories, rewardCategories, onRequest }) => {
            const [tab, setTab] = useState('earn');
            const [hType, setHType] = useState('earn');
            const [hStatus, setHStatus] = useState('all');
            const [selectedTaskCategory, setSelectedTaskCategory] = useState('all');
            const [selectedRewardCategory, setSelectedRewardCategory] = useState(null); // null means showing categories, otherwise catId

            const pendingCount = requests.filter(r => r.kidId === kid.id && r.status === 'pending').length;
            const STATUS_LABELS = { 'all': '全部', 'approved': '已通過', 'pending': '審核中', 'rejected': '已拒絕' };

            const filteredTasks = tasks.filter(t => selectedTaskCategory === 'all' || t.categoryId === selectedTaskCategory);
            
            // Rewards filtering
            // If selectedRewardCategory is 'uncategorized', filter items with no categoryId
            const filteredRewards = rewards.filter(r => {
                if (selectedRewardCategory === 'uncategorized') return !r.categoryId;
                return r.categoryId === selectedRewardCategory;
            });

            // Get categories that have rewards
            const availableRewardCats = (rewardCategories || []).filter(c => rewards.some(r => r.categoryId === c.id));
            const hasUncategorizedRewards = rewards.some(r => !r.categoryId);

            return (
                <div className="space-y-6">
                    <div className="flex p-1 bg-white/30 rounded-2xl mx-2">
                        <button onClick={() => setTab('earn')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${tab === 'earn' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>賺點數</button>
                        <button onClick={() => { setTab('spend'); setSelectedRewardCategory(null); }} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${tab === 'spend' ? 'bg-white shadow-sm text-pink-500' : 'text-slate-500'}`}>換禮物</button>
                        <button onClick={() => setTab('history')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${tab === 'history' ? 'bg-white shadow-sm text-indigo-500' : 'text-slate-500'} relative`}>紀錄 {pendingCount > 0 && <span className="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full"></span>}</button>
                    </div>
                    
                    <div className="pb-24 px-2">
                        {tab === 'earn' && (
                            <>
                                <div className="flex items-center gap-2 mb-3 overflow-x-auto no-scrollbar pb-1">
                                    <button onClick={() => setSelectedTaskCategory('all')} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all ${selectedTaskCategory === 'all' ? 'bg-slate-700 text-white' : 'bg-white text-slate-500'}`}>全部</button>
                                    {(taskCategories || []).map(c => (
                                        <button key={c.id} onClick={() => setSelectedTaskCategory(c.id)} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all ${selectedTaskCategory === c.id ? 'bg-blue-500 text-white' : 'bg-white text-slate-500'}`}>{c.name}</button>
                                    ))}
                                </div>
                                {filteredTasks.length === 0 ? <p className="text-center text-slate-400 py-10">此分類沒有任務喔！</p> : 
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    {filteredTasks.map(task => (
                                        <button key={task.id} onClick={() => onRequest('earn', task, task.points)} className="glass-card p-4 rounded-3xl flex flex-col items-center justify-center gap-3 transition-all active:scale-95 hover:bg-white/60 group relative overflow-hidden">
                                            {task.categoryId && <div className="absolute top-0 right-0 bg-blue-100 text-blue-600 text-[10px] px-2 py-0.5 rounded-bl-xl font-bold">{(taskCategories || []).find(c=>c.id===task.categoryId)?.name}</div>}
                                            <div className="w-14 h-14 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                                <Trophy size={28} />
                                            </div>
                                            <div className="text-center mt-1">
                                                <div className="font-bold text-slate-800 leading-tight mb-1">{task.title}</div>
                                                <div className="text-sm font-extrabold text-blue-500">+{task.points}</div>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                                }
                            </>
                        )}
                        {tab === 'spend' && (
                            <>
                                <h2 className="text-lg font-bold text-slate-700 px-2 flex items-center gap-2 mb-3"><Gift className="text-pink-500" /> 選擇獎勵</h2>
                                
                                {/* Category Level */}
                                {!selectedRewardCategory && (
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {availableRewardCats.map(c => (
                                            <button key={c.id} onClick={() => setSelectedRewardCategory(c.id)} className="glass-card p-4 rounded-3xl flex flex-col items-center justify-center gap-3 transition-all active:scale-95 hover:bg-white/60 group">
                                                <div className="w-16 h-16 rounded-2xl bg-amber-100 text-amber-600 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                                    <Folder size={32} />
                                                </div>
                                                <div className="font-bold text-slate-800 text-lg">{c.name}</div>
                                                <div className="text-xs text-slate-400 font-bold">{rewards.filter(r => r.categoryId === c.id).length} 個項目</div>
                                            </button>
                                        ))}
                                        {hasUncategorizedRewards && (
                                            <button onClick={() => setSelectedRewardCategory('uncategorized')} className="glass-card p-4 rounded-3xl flex flex-col items-center justify-center gap-3 transition-all active:scale-95 hover:bg-white/60 group">
                                                <div className="w-16 h-16 rounded-2xl bg-slate-100 text-slate-500 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                                    <FolderOpen size={32} />
                                                </div>
                                                <div className="font-bold text-slate-800 text-lg">未分類</div>
                                                <div className="text-xs text-slate-400 font-bold">{rewards.filter(r => !r.categoryId).length} 個項目</div>
                                            </button>
                                        )}
                                        {availableRewardCats.length === 0 && !hasUncategorizedRewards && <p className="text-center text-slate-400 w-full col-span-full py-10">目前沒有獎勵喔！</p>}
                                    </div>
                                )}

                                {/* Items Level */}
                                {selectedRewardCategory && (
                                    <div>
                                        <button onClick={() => setSelectedRewardCategory(null)} className="mb-4 flex items-center gap-1 text-slate-500 hover:text-slate-800 font-bold text-sm px-2">
                                            <ArrowLeft size={16}/> 返回分類
                                        </button>
                                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                            {filteredRewards.map(reward => {
                                                const canAfford = kid.balance >= reward.cost;
                                                return (
                                                    <button 
                                                        key={reward.id} 
                                                        onClick={() => canAfford ? onRequest('spend', reward, reward.cost) : null} 
                                                        disabled={!canAfford}
                                                        className={`glass-card p-4 rounded-3xl flex flex-col items-center justify-center gap-3 transition-all ${!canAfford ? 'opacity-50 grayscale cursor-not-allowed' : 'active:scale-95 hover:bg-white/60 group'}`}
                                                    >
                                                        <div className={`w-14 h-14 rounded-full flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform ${canAfford ? 'bg-pink-100 text-pink-500' : 'bg-slate-200 text-slate-400'}`}>
                                                            <Gift size={28} />
                                                        </div>
                                                        <div className="text-center">
                                                            <div className="font-bold text-slate-800 leading-tight mb-1">{reward.title}</div>
                                                            <div className={`text-sm font-extrabold ${canAfford ? 'text-pink-500' : 'text-slate-400'}`}>
                                                                -{reward.cost}
                                                            </div>
                                                        </div>
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                        {/* History tab remains unchanged */}
                        {tab === 'history' && (
                            <>
                                <h2 className="text-lg font-bold text-slate-700 px-2 flex items-center gap-2 mb-3"><Clock className="text-indigo-500" /> 申請紀錄</h2>
                                
                                <div className="flex p-1 bg-white/40 rounded-xl mb-3">
                                    <button onClick={() => setHType('earn')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${hType==='earn' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:bg-white/50'}`}>加點紀錄</button>
                                    <button onClick={() => setHType('spend')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${hType==='spend' ? 'bg-white shadow text-pink-500' : 'text-slate-500 hover:bg-white/50'}`}>兌換紀錄</button>
                                </div>

                                <div className="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1">
                                    {['all', 'approved', 'pending', 'rejected'].map(s => (
                                        <button 
                                            key={s} 
                                            onClick={() => setHStatus(s)} 
                                            className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap border transition-all 
                                                ${hStatus === s 
                                                    ? (s==='all'?'bg-slate-600 text-white border-slate-600' : s==='approved'?'bg-green-500 text-white border-green-500' : s==='pending'?'bg-yellow-500 text-white border-yellow-500' : 'bg-red-500 text-white border-red-500')
                                                    : 'bg-white border-slate-200 text-slate-500'
                                                }`}
                                        >
                                            {STATUS_LABELS[s]}
                                        </button>
                                    ))}
                                </div>

                                <div className="space-y-3">
                                {requests
                                    .filter(r => r.kidId === kid.id)
                                    .filter(r => r.type === hType)
                                    .filter(r => hStatus === 'all' ? true : r.status === hStatus)
                                    .length === 0 ? 
                                    <p className="text-center text-slate-400 py-10">沒有符合的紀錄喔！</p> : 
                                    requests
                                    .filter(r => r.kidId === kid.id)
                                    .filter(r => r.type === hType)
                                    .filter(r => hStatus === 'all' ? true : r.status === hStatus)
                                    .slice(0, 20)
                                    .map(req => (
                                        <div key={req.id} className="bg-white/40 p-3 rounded-xl flex items-center justify-between">
                                            <div className="flex items-center gap-3"><div className={`p-2 rounded-full ${req.type === 'earn' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-500'}`}>{req.type === 'earn' ? <Trophy size={16}/> : <Gift size={16}/>}</div><div><div className="font-bold text-sm text-slate-700">{req.itemName}</div><div className="text-xs text-slate-500">{new Date(req.timestamp).toLocaleDateString()}</div></div></div>
                                            <div className="text-right"><div className={`font-bold ${req.type === 'earn' ? 'text-blue-600' : 'text-pink-500'}`}>{req.type === 'earn' ? '+' : '-'}{req.points}</div><div className={`text-xs font-bold px-2 py-0.5 rounded-full inline-block mt-1 ${req.status === 'pending' ? 'bg-yellow-100 text-yellow-600' : req.status === 'approved' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{req.status === 'pending' ? '審核中' : req.status === 'approved' ? '已通過' : '已拒絕'}</div></div>
                                        </div>
                                    ))
                                }
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const ParentLogin = ({ password, onLogin }) => {
            const [input, setInput] = useState("");
            const [error, setError] = useState(false);
            const handleNum = (num) => { if (input.length < 4) { const next = input + num; setInput(next); setError(false); if (next.length === 4) { if (next === password) onLogin(); else { setTimeout(() => { setError(true); setInput(""); }, 200); } } } };
            return (
                <div className="flex flex-col items-center justify-center h-full pb-20 animate-slide-up">
                    <div className="mb-8 text-center"><div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><ShieldCheck size={32} /></div><h2 className="text-2xl font-bold text-slate-800">家長驗證</h2><p className="text-slate-500">請輸入 4 位數密碼 (預設 0000)</p></div>
                    <div className="flex gap-4 mb-8">{[0, 1, 2, 3].map(i => (<div key={i} className={`w-4 h-4 rounded-full transition-all ${input.length > i ? 'bg-indigo-500' : 'bg-slate-200'} ${error ? 'bg-red-500 animate-pulse' : ''}`}></div>))}</div>
                    <div className="grid grid-cols-3 gap-4 w-64">{[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (<button key={n} onClick={() => handleNum(n.toString())} className="h-16 rounded-full glass font-bold text-xl active:bg-indigo-100 transition-colors">{n}</button>))}<div className="col-start-2"><button onClick={() => handleNum("0")} className="w-full h-16 rounded-full glass font-bold text-xl active:bg-indigo-100 transition-colors">0</button></div><div className="col-start-3 flex justify-center items-center"><button onClick={() => setInput(input.slice(0, -1))} className="p-4 text-slate-500 active:text-slate-800"><X size={24} /></button></div></div>
                </div>
            );
        };

        const ParentView = ({ data, setData, onProcessRequest, onProcessAll, showToast }) => {
            const [view, setView] = useState('requests');
            const [itemTab, setItemTab] = useState('tasks');
            const [requestType, setRequestType] = useState('earn'); 
            const [newItem, setNewItem] = useState({ title: '', value: '', categoryId: '' });
            const [editingType, setEditingType] = useState(null);
            const [editingItemId, setEditingItemId] = useState(null);
            const [newKidName, setNewKidName] = useState('');
            const [editingKid, setEditingKid] = useState(null);
            const [givingPointsTo, setGivingPointsTo] = useState(null);
            const [giftPoints, setGiftPoints] = useState('');
            const [giftReason, setGiftReason] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [showResetModal, setShowResetModal] = useState(false);
            const [showDangerZone, setShowDangerZone] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [showCatManager, setShowCatManager] = useState(false);
            const [newCatName, setNewCatName] = useState('');
            const gridRef = useRef(null);
            const sortableInstance = useRef(null);
            
            // GitHub Config State
            const [ghConfig, setGhConfig] = useState(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('kids_reward_gh_config'));
                    const isDefaultToken = /[^\x00-\x7F]/.test(GITHUB_CONFIG.TOKEN_PART);
                    if (saved && saved.token) return saved;
                    if (!isDefaultToken && GITHUB_CONFIG.TOKEN_PART) {
                        return { token: getRealToken(), repo: GITHUB_CONFIG.REPO, path: GITHUB_CONFIG.PATH };
                    }
                    return { token: '', repo: '', path: 'data.json' };
                } catch { return { token: '', repo: '', path: 'data.json' }; }
            });
            const [showGhConfig, setShowGhConfig] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);

            useEffect(() => { localStorage.setItem('kids_reward_gh_config', JSON.stringify(ghConfig)); }, [ghConfig]);

            useEffect(() => {
                const el = gridRef.current;
                if (el && (view === 'items' || view === 'members')) {
                    if (sortableInstance.current) { try { sortableInstance.current.destroy(); } catch(e) {} sortableInstance.current = null; }
                    sortableInstance.current = new Sortable(el, { animation: 150, handle: '.drag-handle', delay: 100, delayOnTouchOnly: true, onEnd: (evt) => {
                        if (evt.oldIndex === evt.newIndex) return;
                        let listKey = view === 'members' ? 'kids' : itemTab;
                        setData(prev => { const newList = [...prev[listKey]]; const [moved] = newList.splice(evt.oldIndex, 1); newList.splice(evt.newIndex, 0, moved); return { ...prev, [listKey]: newList }; });
                    }});
                }
                return () => { if (sortableInstance.current) { try { sortableInstance.current.destroy(); } catch (e) {} sortableInstance.current = null; } };
            }, [view, itemTab]);

            const pendingRequests = data.requests.filter(r => r.status === 'pending' && r.type === requestType);
            const totalPendingCount = data.requests.filter(r => r.status === 'pending').length;

            const saveItem = (type) => { 
                if (!newItem.title || !newItem.value) return; 
                if (editingItemId) { 
                    setData(prev => ({ ...prev, [type]: prev[type].map(item => item.id === editingItemId ? { ...item, title: newItem.title, [type === 'tasks' ? 'points' : 'cost']: parseInt(newItem.value), categoryId: newItem.categoryId } : item) })); 
                    setEditingItemId(null); 
                } else { 
                    const item = { id: type === 'tasks' ? `t${Date.now()}` : `r${Date.now()}`, title: newItem.title, [type === 'tasks' ? 'points' : 'cost']: parseInt(newItem.value), categoryId: newItem.categoryId, assignedTo: data.kids.map(k => k.id) }; 
                    setData(prev => ({ ...prev, [type]: [...prev[type], item] })); 
                } 
                setNewItem({ title: '', value: '', categoryId: '' }); 
                setEditingType(null); 
            };
            const startEditItem = (type, item) => { setNewItem({ title: item.title, value: item.points || item.cost, categoryId: item.categoryId || '' }); setEditingType(type); setEditingItemId(item.id); };
            const cancelEditItem = () => { setNewItem({ title: '', value: '' }); setEditingType(null); setEditingItemId(null); };
            
            const confirmDelete = (type, id) => { setItemToDelete({ type, id }); };
            const executeDelete = () => {
                if (!itemToDelete) return;
                const { type, id } = itemToDelete;
                setData(prev => {
                    const newState = { ...prev };
                    if (type === 'kids') {
                        newState.kids = prev.kids.filter(k => k.id !== id);
                        newState.requests = prev.requests.filter(r => r.kidId !== id);
                    } else {
                        newState[type] = prev[type].filter(i => i.id !== id);
                    }
                    return newState;
                });
                setItemToDelete(null);
                showToast('刪除成功', 'success');
            };

            const addKid = () => { if(!newKidName.trim()) return; const newKid = { id: 'k' + Date.now(), name: newKidName, balance: 0, avatar: DEFAULT_AVATAR }; setData(prev => ({ ...prev, kids: [...prev.kids, newKid] })); setNewKidName(''); };
            const confirmDeleteKid = (id) => {
                if(data.kids.length <= 1) { alert('至少要保留一位小孩喔！'); return; }
                setItemToDelete({ type: 'kids', id });
            };
            const handleDirectGive = (e) => { e.preventDefault(); const points = parseInt(giftPoints); if (!giftReason || isNaN(points)) return; setData(prev => { const newKids = prev.kids.map(k => k.id === givingPointsTo.id ? { ...k, balance: k.balance + points } : k); const newRequest = { id: Date.now().toString(), type: points >= 0 ? 'earn' : 'spend', kidId: givingPointsTo.id, itemId: 'manual', itemName: giftReason, points: Math.abs(points), status: 'approved', timestamp: new Date().toISOString() }; return { ...prev, kids: newKids, requests: [newRequest, ...prev.requests] }; }); setGivingPointsTo(null); setGiftPoints(''); setGiftReason(''); showToast('發送成功！', 'success'); };
            const handleSaveToGitHub = async () => { if (!isGithubConfigValid()) { alert('請先設定 GitHub 資料'); setShowGhConfig(true); return; } setIsSyncing(true); try { const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`; const getRes = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } }); let sha = null; if (getRes.status === 200) { const json = await getRes.json(); sha = json.sha; } const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))); const putRes = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Update from App ${new Date().toISOString()}`, content: content, sha: sha }) }); if (putRes.ok) { showToast('備份至 GitHub 成功！', 'success'); } else { const err = await putRes.json(); alert('上傳失敗: ' + (err.message || 'Unknown error')); } } catch (e) { alert('連線錯誤: ' + e.message); } finally { setIsSyncing(false); } };
            const handleLoadFromGitHub = async () => { if (!isGithubConfigValid()) { alert('請先設定 GitHub 資料'); setShowGhConfig(true); return; } if (!confirm('確定要從 GitHub 下載並覆蓋目前資料嗎？')) return; setIsSyncing(true); try { const getUrl = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`; const res = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } }); if (res.ok) { const json = await res.json(); const content = decodeURIComponent(escape(window.atob(json.content))); const newData = JSON.parse(content); if (newData.kids) { setData(newData); showToast('從 GitHub 還原成功！', 'success'); } else { alert('GitHub 上的檔案格式不正確'); } } else { alert('下載失敗 (404 或權限不足)'); } } catch (e) { alert('連線錯誤: ' + e.message); } finally { setIsSyncing(false); } };
            const handlePasswordChange = (e) => { const val = e.target.value; if (/^\d*$/.test(val)) setNewPassword(val.slice(0, 4)); };
            
            // Category Management
            const addCategory = () => { if(!newCatName.trim()) return; const newCat = { id: `rc${Date.now()}`, name: newCatName }; 
                const catKey = itemTab === 'tasks' ? 'taskCategories' : 'rewardCategories';
                setData(prev => ({ ...prev, [catKey]: [...(prev[catKey] || []), newCat] })); setNewCatName(''); 
            };
            const deleteCategory = (id) => { 
                if(!confirm('確定刪除此分類？')) return; 
                const catKey = itemTab === 'tasks' ? 'taskCategories' : 'rewardCategories';
                setData(prev => ({ ...prev, [catKey]: prev[catKey].filter(c => c.id !== id) })); 
            };

            return (
                <div className="space-y-6 pb-20 pt-safe">
                    <div className="flex gap-2 px-2 overflow-x-auto no-scrollbar">
                        {[{ id: 'requests', label: '待審核', icon: Check, count: totalPendingCount }, { id: 'items', label: '任務獎勵', icon: Settings }, { id: 'members', label: '成員', icon: Users }, { id: 'settings', label: '設定', icon: ShieldCheck }].map(tab => (
                            <button key={tab.id} onClick={() => setView(tab.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full whitespace-nowrap transition-all ${view === tab.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-white/50 text-slate-600'}`}><tab.icon size={16} /> <span className="font-bold text-sm">{tab.label}</span> {tab.count > 0 && <span className="bg-red-500 text-white text-[10px] px-1.5 rounded-full">{tab.count}</span>}</button>
                        ))}
                    </div>

                    {view === 'requests' && (
                        <div className="space-y-4 px-2">
                             <div className="flex p-1 bg-white/30 rounded-2xl mb-4">
                                <button onClick={() => setRequestType('earn')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${requestType === 'earn' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>加點申請</button>
                                <button onClick={() => setRequestType('spend')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${requestType === 'spend' ? 'bg-white shadow-sm text-pink-500' : 'text-slate-500'}`}>兌換申請</button>
                            </div>
                            {pendingRequests.length > 0 && (
                                <div className="flex gap-3 mb-2">
                                    <button onClick={() => onProcessAll('approve', pendingRequests.map(r => r.id))} className="flex-1 py-3 rounded-xl bg-green-100 text-green-700 font-bold flex items-center justify-center gap-2 shadow-sm hover:bg-green-200 transition-colors border border-green-200"><ThumbsUp size={20} /> 全部同意</button>
                                    <button onClick={() => onProcessAll('reject', pendingRequests.map(r => r.id))} className="flex-1 py-3 rounded-xl bg-red-100 text-red-700 font-bold flex items-center justify-center gap-2 shadow-sm hover:bg-red-200 transition-colors border border-red-200"><ThumbsDown size={20} /> 全部拒絕</button>
                                </div>
                            )}
                            {pendingRequests.length === 0 ? <div className="text-center py-12 text-slate-400"><div className="bg-white/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3"><Check size={32} /></div><p>目前沒有{requestType==='earn'?'加點':'兌換'}申請</p></div> : 
                                <div className="space-y-3">
                                    {pendingRequests.map(req => { const kid = data.kids.find(k => k.id === req.kidId); return (
                                            <div key={req.id} className="glass-card p-4 rounded-2xl flex flex-col sm:flex-row sm:items-center justify-between gap-4 border-2 border-white/40 shadow-sm">
                                                <div className="flex items-center gap-4"><img src={kid?.avatar} className="w-12 h-12 rounded-full bg-slate-200 object-cover border-2 border-white" /><div><div className="flex items-center gap-2"><span className="font-bold text-slate-800 text-lg">{kid?.name}</span><span className={`text-xs px-2 py-0.5 rounded-full font-bold ${req.type === 'earn' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'}`}>{req.type === 'earn' ? '申請獲得' : '申請兌換'}</span></div><div className="text-sm text-slate-600 font-medium">{req.itemName}</div><div className="text-xs text-slate-400 mt-1">{new Date(req.timestamp).toLocaleString()}</div></div></div>
                                                <div className="flex flex-col sm:items-end gap-3 w-full sm:w-auto"><div className={`font-extrabold text-xl text-right ${req.type==='earn'?'text-blue-500':'text-pink-500'}`}>{req.type==='earn'?'+':'-'}{req.points}</div><div className="flex gap-2 w-full sm:w-auto"><Button variant="danger" className="flex-1 sm:flex-none py-2 px-4 text-sm rounded-xl" onClick={() => onProcessRequest(req.id, 'reject')}>拒絕</Button><Button variant="success" className="flex-1 sm:flex-none py-2 px-4 text-sm rounded-xl" onClick={() => onProcessRequest(req.id, 'approve')}>批准</Button></div></div>
                                            </div>
                                    );})}
                                </div>
                            }
                        </div>
                    )}
                    
                    {view === 'items' && (
                        <div className="space-y-4 px-2">
                             <div className="flex p-1 bg-white/30 rounded-2xl mb-4">
                                <button onClick={() => setItemTab('tasks')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${itemTab === 'tasks' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>任務管理</button>
                                <button onClick={() => setItemTab('rewards')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${itemTab === 'rewards' ? 'bg-white shadow-sm text-pink-500' : 'text-slate-500'}`}>獎勵管理</button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setEditingType(itemTab)} className="flex-1 py-3 rounded-2xl bg-indigo-100 text-indigo-600 font-bold flex items-center justify-center gap-2 border-2 border-dashed border-indigo-200 hover:bg-indigo-200 transition-colors"><Plus size={20} /> 新增{itemTab === 'tasks' ? '任務' : '獎勵'}</button>
                                <button onClick={() => setShowCatManager(true)} className="px-4 rounded-2xl bg-white text-slate-500 border border-slate-200 hover:bg-slate-50 font-bold text-sm flex items-center gap-1"><Tag size={16}/> 管理分類</button>
                            </div>
                            <div ref={gridRef} className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {data[itemTab].map(item => (
                                    <div key={item.id} className="glass-card p-4 rounded-3xl flex flex-col items-center justify-between gap-3 relative group">
                                        <div className="absolute top-2 right-2 text-slate-300 hover:text-slate-600 cursor-grab drag-handle"><GripVertical size={20}/></div>
                                        {item.categoryId && <div className="absolute top-2 left-2 bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold">{(itemTab === 'tasks' ? data.taskCategories : data.rewardCategories)?.find(c=>c.id===item.categoryId)?.name}</div>}
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center mt-4 ${itemTab === 'tasks' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-500'}`}>{itemTab === 'tasks' ? <Trophy size={24} /> : <Gift size={24} />}</div>
                                        <div className="text-center w-full mt-2"><div className="font-bold text-slate-800 leading-tight mb-1 text-sm line-clamp-2 h-10 flex items-center justify-center">{item.title}</div><div className={`text-sm font-extrabold ${itemTab === 'tasks' ? 'text-blue-500' : 'text-pink-500'}`}>{itemTab === 'tasks' ? '+' : '-'}{item.points || item.cost}</div></div>
                                        <div className="flex gap-2 w-full pt-2 border-t border-slate-100 mt-1"><button onClick={() => startEditItem(itemTab, item)} className="flex-1 py-1 rounded-lg bg-slate-100 text-slate-500 hover:bg-blue-100 hover:text-blue-600 flex justify-center"><Edit size={16}/></button><button onClick={(e) => { e.stopPropagation(); confirmDelete(itemTab, item.id); }} className="flex-1 py-1 rounded-lg bg-slate-100 text-slate-500 hover:bg-red-100 hover:text-red-600 flex justify-center"><Trash size={16}/></button></div>
                                    </div>
                                ))}
                            </div>
                            {editingType && (
                                <Modal isOpen={true} onClose={() => {setEditingType(null); setEditingItemId(null); setNewItem({title:'', value:'', categoryId: ''});}} title={`${editingItemId ? '編輯' : '新增'}${editingType === 'tasks' ? '任務' : '獎勵'}`}>
                                    <div className="space-y-4">
                                        <div><label className="block text-slate-500 text-sm font-bold mb-2">名稱</label><input className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-indigo-300 outline-none" placeholder="例如: 幫忙洗碗" value={newItem.title} onChange={e => setNewItem({...newItem, title: e.target.value})} autoFocus /></div>
                                        <div><label className="block text-slate-500 text-sm font-bold mb-2">點數</label><input type="number" className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-indigo-300 outline-none font-mono text-lg" placeholder="100" value={newItem.value} onChange={e => setNewItem({...newItem, value: e.target.value})} /></div>
                                        <div>
                                            <label className="block text-slate-500 text-sm font-bold mb-2">分類</label>
                                            <select className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-indigo-300 outline-none" value={newItem.categoryId} onChange={e => setNewItem({...newItem, categoryId: e.target.value})}>
                                                <option value="">無分類</option>
                                                {(itemTab === 'tasks' ? data.taskCategories : data.rewardCategories)?.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        </div>
                                        <Button className="w-full" onClick={() => saveItem(editingType)}>儲存</Button>
                                    </div>
                                </Modal>
                            )}
                            <Modal isOpen={showCatManager} onClose={() => setShowCatManager(false)} title={`管理${itemTab === 'tasks' ? '任務' : '獎勵'}分類`}>
                                <div className="space-y-4">
                                    <div className="flex gap-2"><input value={newCatName} onChange={e => setNewCatName(e.target.value)} placeholder="輸入新分類名稱" className="flex-1 p-2 rounded-xl bg-slate-50 border" /><Button size="sm" onClick={addCategory}>新增</Button></div>
                                    <div className="space-y-2">
                                        {(itemTab === 'tasks' ? data.taskCategories : data.rewardCategories)?.map(c => (
                                            <div key={c.id} className="flex justify-between items-center p-3 bg-white border rounded-xl">
                                                <span>{c.name}</span>
                                                <button onClick={() => deleteCategory(c.id)} className="text-red-400 hover:text-red-600"><Trash size={16}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </Modal>
                        </div>
                    )}

                    {view === 'members' && (<div className="space-y-4 px-2">
                        <button onClick={addKid} className="w-full py-4 rounded-2xl bg-blue-50 border-2 border-dashed border-blue-200 text-blue-600 font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition-colors"><Plus size={24} /> 新增家庭成員</button>
                        <div className="bg-white/40 p-4 rounded-2xl flex gap-2 mb-4"><input value={newKidName} onChange={(e) => setNewKidName(e.target.value)} placeholder="輸入名字後按新增" className="flex-1 p-3 rounded-xl bg-white border-none focus:ring-2 ring-blue-300 text-sm" /><Button onClick={addKid}>新增</Button></div>
                        <div ref={gridRef} className="grid grid-cols-2 md:grid-cols-3 gap-4">
                            {data.kids.map((kid, index) => (
                                <div key={kid.id} className="glass-card p-4 rounded-3xl flex flex-col items-center justify-between gap-4 relative group">
                                    <div className="absolute top-2 right-2 text-slate-300 hover:text-slate-600 cursor-grab drag-handle"><GripVertical size={20}/></div>
                                    <img src={kid.avatar} className="w-20 h-20 rounded-full bg-slate-200 object-cover border-4 border-white shadow-sm mt-4"/>
                                    <div className="text-center">
                                        <div className="font-bold text-lg text-slate-800">{kid.name}</div>
                                        <div className="text-sm font-bold text-yellow-600 bg-yellow-100 px-3 py-1 rounded-full mt-1">{kid.balance} 點</div>
                                    </div>
                                    <div className="flex gap-2 w-full pt-3 border-t border-slate-100">
                                        <button onClick={() => setGivingPointsTo(kid)} className="flex-1 py-2 rounded-xl bg-pink-50 text-pink-500 hover:bg-pink-100 flex justify-center"><Heart size={20}/></button>
                                        <button onClick={() => setEditingKid(kid)} className="flex-1 py-2 rounded-xl bg-blue-50 text-blue-500 hover:bg-blue-100 flex justify-center"><Edit size={20}/></button>
                                        <button onClick={() => confirmDeleteKid(kid.id)} className="flex-1 py-2 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 flex justify-center"><Trash size={20}/></button>
                                    </div>
                                </div>
                            ))}
                        </div></div>)}
                    
                    {view === 'settings' && (
                        <div className="space-y-4 px-2">
                            <div className="bg-white/40 rounded-2xl p-4">
                                <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Lock size={18} className="text-slate-500"/> 修改家長密碼</h3>
                                <div className="flex gap-2"><input type="text" inputMode="numeric" maxLength="4" value={newPassword} onChange={handlePasswordChange} placeholder="輸入新的 4 位數密碼" className="flex-1 p-3 rounded-xl bg-white/60 border-none focus:ring-2 ring-indigo-300 text-sm font-mono tracking-widest text-center"/><Button onClick={() => { if(newPassword.length !== 4) { alert('請輸入 4 位數字'); return; } setData(prev => ({...prev, settings: {...prev.settings, password: newPassword}})); setNewPassword(''); showToast('密碼修改成功！', 'success'); }}>更新</Button></div>
                            </div>
                            <div className="text-center pt-4 pb-2">
                                <button onClick={() => setShowDangerZone(!showDangerZone)} className="text-xs text-slate-400 underline hover:text-slate-600 transition-colors">
                                    {showDangerZone ? '隱藏進階設定' : '顯示進階設定 (重置資料)'}
                                </button>
                            </div>
                            {showDangerZone && (
                                <div className="bg-red-50/50 rounded-2xl p-4 border border-red-100 animate-slide-up">
                                    <h3 className="font-bold text-red-800 mb-4 flex items-center gap-2"><AlertTriangle size={18}/> 危險區域</h3>
                                    <div className="space-y-2"><Button variant="ghost" className="w-full justify-start bg-white/50 text-red-500 hover:bg-red-100" onClick={() => setShowResetModal(true)}><Trash size={18} /> 重置所有資料</Button></div>
                                </div>
                            )}
                        </div>
                    )}

                    <Modal isOpen={!!editingKid} onClose={() => setEditingKid(null)} title="修改成員名稱"><form onSubmit={(e) => { e.preventDefault(); const newName = e.target.name.value; if(newName.trim()) { setData(prev => ({ ...prev, kids: prev.kids.map(k => k.id === editingKid.id ? { ...k, name: newName } : k) })); setEditingKid(null); } }}><div className="mb-4"><label className="block text-slate-500 text-sm font-bold mb-2">新的名字</label><input name="name" defaultValue={editingKid?.name} className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-blue-300 outline-none" autoFocus /></div><Button type="submit" className="w-full">儲存</Button></form></Modal>
                    <Modal isOpen={!!givingPointsTo} onClose={() => setGivingPointsTo(null)} title={`送點數給 ${givingPointsTo?.name || ''}`}><form onSubmit={handleDirectGive}><div className="mb-4 space-y-4"><div><label className="block text-slate-500 text-sm font-bold mb-2">原因</label><input value={giftReason} onChange={e => setGiftReason(e.target.value)} className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-pink-300 outline-none" placeholder="例如：幫忙阿嬤..." autoFocus /></div><div><label className="block text-slate-500 text-sm font-bold mb-2">點數</label><input type="number" value={giftPoints} onChange={e => setGiftPoints(e.target.value)} className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-pink-300 outline-none font-mono text-lg" placeholder="輸入點數" /></div></div><Button type="submit" variant="primary" className="w-full bg-pink-500 hover:bg-pink-600 shadow-pink-200"><Heart size={18} className="fill-white" /> 發送點數</Button></form></Modal>
                    
                    {/* Data Reset Modal */}
                    <Modal isOpen={showResetModal} onClose={() => setShowResetModal(false)} title="危險操作確認"><div className="flex flex-col items-center text-center p-2 space-y-4"><div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-500 mb-2"><AlertTriangle size={36} /></div><h4 className="text-lg font-bold text-slate-800">您確定要重置所有資料嗎？</h4><p className="text-slate-500 text-sm">此動作將會刪除所有資料且無法復原。</p><div className="flex gap-3 w-full mt-4"><Button variant="ghost" className="flex-1" onClick={() => setShowResetModal(false)}>取消</Button><Button variant="danger" className="flex-1" onClick={() => { setData(INITIAL_DATA); setShowResetModal(false); showToast('資料已重置', 'success'); }}>確認重置</Button></div></div></Modal>

                    {/* Item Deletion Modal */}
                    <Modal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} title="刪除確認">
                        <div className="flex flex-col items-center text-center p-2 space-y-4">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-500 mb-2"><Trash size={32} /></div>
                            <h4 className="text-lg font-bold text-slate-800">確定要刪除這個項目嗎？</h4>
                            <p className="text-slate-500 text-sm">刪除後將無法復原。</p>
                            <div className="flex gap-3 w-full mt-4">
                                <Button variant="ghost" className="flex-1" onClick={() => setItemToDelete(null)}>取消</Button>
                                <Button variant="danger" className="flex-1" onClick={executeDelete}>確認刪除</Button>
                            </div>
                        </div>
                    </Modal>

                    {/* GitHub Config Modal */}
                    <Modal isOpen={showGhConfig} onClose={() => setShowGhConfig(false)} title="GitHub 設定">
                        <div className="space-y-4">
                            <div><label className="block text-slate-500 text-sm font-bold mb-1">Personal Access Token (PAT)</label><input value={ghConfig.token} onChange={e => setGhConfig({...ghConfig, token: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-indigo-300 outline-none text-sm" type="password" placeholder="ghp_..." /><p className="text-[10px] text-slate-400 mt-1">需有 repo 權限的 token</p></div>
                            <div><label className="block text-slate-500 text-sm font-bold mb-1">Repository (擁有者/倉庫名)</label><input value={ghConfig.repo} onChange={e => setGhConfig({...ghConfig, repo: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-indigo-300 outline-none text-sm" placeholder="例如: yourname/my-app" /></div>
                            <div><label className="block text-slate-500 text-sm font-bold mb-1">檔案路徑</label><input value={ghConfig.path} onChange={e => setGhConfig({...ghConfig, path: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 border focus:ring-2 ring-indigo-300 outline-none text-sm" placeholder="例如: data.json" /></div>
                            <Button onClick={() => setShowGhConfig(false)} className="w-full mt-2">儲存設定</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        function App() {
            const [data, setData] = useState(() => { try { const saved = localStorage.getItem('kids_reward_app_v1'); return saved ? JSON.parse(saved) : INITIAL_DATA; } catch(e) { return INITIAL_DATA; } });
            const [currentTab, setCurrentTab] = useState('kid'); 
            const [activeKidId, setActiveKidId] = useState(data.kids[0]?.id || null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [showProfileMenu, setShowProfileMenu] = useState(false);
            const [modalContent, setModalContent] = useState(null); 
            const [toast, setToast] = useState(null);
            
            const [syncStatus, setSyncStatus] = useState('idle'); 
            const isFirstLoad = useRef(true);
            const isRemoteUpdate = useRef(false);

            const [ghConfig, setGhConfig] = useState(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('kids_reward_gh_config'));
                    const isDefaultToken = /[^\x00-\x7F]/.test(GITHUB_CONFIG.TOKEN_PART);
                    if (saved && saved.token) return saved;
                    if (!isDefaultToken && GITHUB_CONFIG.TOKEN_PART) {
                        return { token: getRealToken(), repo: GITHUB_CONFIG.REPO, path: GITHUB_CONFIG.PATH };
                    }
                    return { token: '', repo: '', path: 'data.json' };
                } catch { return { token: '', repo: '', path: 'data.json' }; }
            });

            // 1. Initial Load from GitHub
            useEffect(() => {
                const loadFromCloud = async () => {
                    if (!ghConfig.token || !ghConfig.repo || /[^\x00-\x7F]/.test(ghConfig.token)) return;
                    setSyncStatus('syncing');
                    try {
                        const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;
                        const res = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } });
                        if (res.ok) {
                            const json = await res.json();
                            const content = decodeURIComponent(escape(window.atob(json.content)));
                            const cloudData = JSON.parse(content);
                            if (cloudData.kids) {
                                isRemoteUpdate.current = true;
                                setData(cloudData);
                                setSyncStatus('success');
                                setTimeout(() => setSyncStatus('idle'), 3000);
                            }
                        } else if(res.status === 404) {
                            setSyncStatus('idle');
                        } else { setSyncStatus('error'); }
                    } catch (e) { console.error(e); setSyncStatus('error'); }
                };
                loadFromCloud();
            }, []);

            // 2. Save to LocalStorage
            useEffect(() => { localStorage.setItem('kids_reward_app_v1', JSON.stringify(data)); }, [data]);

            // 3. Auto-Save to GitHub (Debounced)
            useEffect(() => {
                if (isFirstLoad.current) { isFirstLoad.current = false; return; }
                if (isRemoteUpdate.current) { isRemoteUpdate.current = false; return; }
                if (!ghConfig.token || !ghConfig.repo || /[^\x00-\x7F]/.test(ghConfig.token)) return;

                const timer = setTimeout(async () => {
                    setSyncStatus('syncing');
                    try {
                        const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;
                        const getRes = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } });
                        let sha = null;
                        if (getRes.ok) { const json = await getRes.json(); sha = json.sha; }
                        
                        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                        const putRes = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: `Auto-save ${new Date().toISOString()}`, content: content, sha: sha })
                        });
                        if (putRes.ok) { setSyncStatus('success'); setTimeout(() => setSyncStatus('idle'), 3000); } else { setSyncStatus('error'); }
                    } catch (e) { setSyncStatus('error'); }
                }, 2000);
                return () => clearTimeout(timer);
            }, [data, ghConfig]);

            useEffect(() => { const kidExists = data.kids.find(k => k.id === activeKidId); if (!kidExists && data.kids.length > 0) { setActiveKidId(data.kids[0].id); } else if (data.kids.length === 0) { setActiveKidId(null); } }, [data.kids, activeKidId]);

            const showToast = (message, type = 'info') => { setToast({ message, type }); };
            const addRequest = (type, item, points) => { const activeKid = data.kids.find(k => k.id === activeKidId); if (!activeKid) return; if (type === 'spend' && activeKid.balance < points) { showToast('點數不足喔！再加油一下！', 'error'); return; } const newRequest = { id: Date.now().toString(), type, kidId: activeKidId, itemId: item.id, itemName: item.title, points, status: 'pending', timestamp: new Date().toISOString() }; setData(prev => ({ ...prev, requests: [newRequest, ...prev.requests] })); showToast(type === 'earn' ? '任務申請已送出！' : '兌換申請已送出！', 'success'); };
            
            // Process Single Request
            const processRequest = (reqId, action) => { 
                setData(prev => { 
                    const req = prev.requests.find(r => r.id === reqId); 
                    if (!req || req.status !== 'pending') return prev; 
                    let newKids = [...prev.kids]; 
                    if (action === 'approve') { 
                        const kidIndex = newKids.findIndex(k => k.id === req.kidId); 
                        if (kidIndex > -1) { 
                            if (req.type === 'earn') { newKids[kidIndex].balance += req.points; } 
                            else { 
                                if (newKids[kidIndex].balance >= req.points) { newKids[kidIndex].balance -= req.points; } 
                                else { showToast('點數不足，無法扣款', 'error'); return prev; } 
                            } 
                        } 
                    } 
                    const newRequests = prev.requests.map(r => r.id === reqId ? { ...r, status: action === 'approve' ? 'approved' : 'rejected' } : r); 
                    return { ...prev, kids: newKids, requests: newRequests }; 
                }); 
                showToast(action === 'approve' ? '已批准' : '已拒絕', action === 'approve' ? 'success' : 'info'); 
            };

            // Process All Requests - Accept IDs to process
            const processAllRequests = (action, targetIds = null) => {
                setData(prev => {
                    let newKids = prev.kids.map(k => ({...k})); // Deep copy
                    let processedCount = 0;
                    
                    const newRequests = prev.requests.map(req => {
                        // Skip if not pending
                        if (req.status !== 'pending') return req;
                        // Skip if not in target list (if list provided)
                        if (targetIds && !targetIds.includes(req.id)) return req;
                        
                        if (action === 'reject') {
                            processedCount++;
                            return { ...req, status: 'rejected' };
                        }

                        // Approve Logic
                        const kidIndex = newKids.findIndex(k => k.id === req.kidId);
                        if (kidIndex === -1) return req;

                        if (req.type === 'earn') {
                            newKids[kidIndex].balance += req.points;
                            processedCount++;
                            return { ...req, status: 'approved' };
                        } else {
                            // Spend
                            if (newKids[kidIndex].balance >= req.points) {
                                newKids[kidIndex].balance -= req.points;
                                processedCount++;
                                return { ...req, status: 'approved' };
                            } else {
                                // Not enough points, keep pending
                                return req; 
                            }
                        }
                    });

                    if (processedCount === 0 && action === 'approve') return prev; // No changes

                    return { ...prev, kids: newKids, requests: newRequests };
                });
                showToast(action === 'approve' ? '已批次同意 (點數不足者除外)' : '已全部拒絕', 'success');
            };

            const updateKidProfile = (updates) => { setData(prev => ({ ...prev, kids: prev.kids.map(k => k.id === activeKidId ? { ...k, ...updates } : k) })); showToast('更新成功', 'success'); };
            const handleImageUpload = (file) => { if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxSize = 200; let width = img.width; let height = img.height; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); updateKidProfile({ avatar: canvas.toDataURL('image/jpeg', 0.8) }); setModalContent(null); }; img.src = e.target.result; }; reader.readAsDataURL(file); };
            
            const handleManualSync = useCallback(async () => {
                if (!ghConfig.token || !ghConfig.repo) return;
                setSyncStatus('syncing');
                try {
                    const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;
                    const res = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } });
                    if (res.ok) {
                        const json = await res.json();
                        const content = decodeURIComponent(escape(window.atob(json.content)));
                        const cloudData = JSON.parse(content);
                        if (cloudData.kids) {
                            isRemoteUpdate.current = true;
                            setData(cloudData);
                            setSyncStatus('success');
                            showToast('已從雲端同步最新資料', 'success');
                            setTimeout(() => setSyncStatus('idle'), 3000);
                        }
                    } else { setSyncStatus('error'); }
                } catch (e) { setSyncStatus('error'); }
            }, [ghConfig]);

            // Fixed: Define activeKid here to avoid ReferenceError in JSX
            const activeKid = data.kids.find(k => k.id === activeKidId);

            return (
                <div className="flex flex-col h-full bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 relative overflow-hidden">
                    <div className="absolute top-[-10%] right-[-10%] w-64 h-64 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
                    <div className="absolute top-[20%] left-[-10%] w-72 h-72 bg-yellow-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
                    <div className="absolute bottom-[-10%] left-[20%] w-80 h-80 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>

                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

                    <header className="px-6 py-4 pt-safe flex justify-between items-center z-10 glass-dark rounded-b-3xl shadow-sm">
                        {currentTab === 'kid' ? (
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setShowProfileMenu(true)}>
                                <div className="relative"><img src={activeKid?.avatar || DEFAULT_AVATAR} className="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md bg-slate-200" />{activeKid && <div className="absolute bottom-0 right-0 bg-green-400 w-3 h-3 rounded-full border border-white"></div>}</div>
                                <div><h1 className="text-lg font-bold text-slate-800 leading-tight">{activeKid?.name || '請新增小孩'}</h1><div className="flex items-center text-yellow-600 font-bold text-sm"><Trophy size={14} className="mr-1 fill-yellow-500" />{activeKid?.balance || 0} 點</div></div>
                            </div>
                        ) : (
                            <div className="flex items-center gap-2"><ShieldCheck className="text-indigo-600" /><h1 className="text-xl font-bold text-slate-800">家長控制台</h1></div>
                        )}
                        <div className="flex items-center gap-2">
                            <div onClick={handleManualSync} className="transition-all cursor-pointer">
                                {syncStatus === 'syncing' && <RefreshCw size={20} className="text-blue-500 animate-spin" />}
                                {syncStatus === 'success' && <CloudCheck size={20} className="text-green-500" />}
                                {syncStatus === 'error' && <AlertTriangle size={20} className="text-red-500" />}
                                {syncStatus === 'idle' && <Cloud size={20} className="text-slate-400" />}
                            </div>
                            {currentTab === 'parent' && isAuthenticated && <button onClick={() => setIsAuthenticated(false)} className="p-2 text-slate-400 hover:text-slate-600"><LogOut size={20}/></button>}
                        </div>
                    </header>

                    <Modal isOpen={showProfileMenu} onClose={() => setShowProfileMenu(false)} title="設定">
                        <div className="space-y-3">
                            <Button variant="glass" className="w-full justify-start" onClick={() => { setShowProfileMenu(false); setModalContent({ type: 'editName' }); }}><Settings size={18} /> 更換名字</Button>
                            <Button variant="glass" className="w-full justify-start" onClick={() => { setShowProfileMenu(false); setModalContent({ type: 'editAvatar' }); }}><User size={18} /> 更換頭像</Button>
                            <div className="h-px bg-slate-200 my-2"></div><div className="text-xs text-slate-400 font-bold mb-2">切換使用者</div>
                            {data.kids.map(kid => (<Button key={kid.id} variant={activeKidId === kid.id ? 'primary' : 'ghost'} className="w-full justify-start" onClick={() => { setActiveKidId(kid.id); setShowProfileMenu(false); }}><img src={kid.avatar} className="w-6 h-6 rounded-full mr-2 object-cover"/> {kid.name}</Button>))}
                        </div>
                    </Modal>

                    <Modal isOpen={modalContent?.type === 'editName'} onClose={() => setModalContent(null)} title="更換名字">
                        <form onSubmit={(e) => { e.preventDefault(); updateKidProfile({ name: e.target.name.value }); setModalContent(null); }}><input name="name" defaultValue={activeKid?.name} className="w-full p-3 rounded-xl bg-slate-50 mb-4 border focus:ring-2 ring-blue-300 outline-none" placeholder="輸入新名字" autoFocus /><Button type="submit" className="w-full">儲存</Button></form>
                    </Modal>

                    <Modal isOpen={modalContent?.type === 'editAvatar'} onClose={() => setModalContent(null)} title="上傳新頭像">
                        <div className="flex flex-col items-center gap-4"><label className="w-32 h-32 rounded-full bg-slate-100 flex items-center justify-center border-4 border-dashed border-slate-300 relative overflow-hidden cursor-pointer hover:bg-slate-200 transition-colors">{activeKid?.avatar && <img src={activeKid.avatar} className="w-full h-full object-cover opacity-50" />}<Upload className="absolute text-slate-500 z-10" /><input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e.target.files[0])} /></label><p className="text-xs text-slate-400">點擊上方圓圈上傳圖片</p></div>
                    </Modal>

                    <main className="flex-1 overflow-y-auto overflow-x-hidden p-4 z-0">
                        {currentTab === 'kid' ? (activeKid ? (<KidView kid={activeKid} tasks={data.tasks} rewards={data.rewards} requests={data.requests} taskCategories={data.taskCategories || []} onRequest={addRequest} />) : <div className="text-center pt-20 text-slate-500">請家長新增使用者</div>) : (isAuthenticated ? (<ParentView data={data} setData={setData} onProcessRequest={processRequest} onProcessAll={processAllRequests} showToast={showToast} />) : (<ParentLogin password={data.settings.password} onLogin={() => setIsAuthenticated(true)} />))}
                    </main>

                    <nav className="absolute bottom-6 mb-safe left-6 right-6 h-16 glass-dark rounded-full flex justify-around items-center shadow-2xl z-20 px-2">
                        <button onClick={() => setCurrentTab('kid')} className={`flex flex-col items-center justify-center w-full h-full rounded-full transition-all ${currentTab === 'kid' ? 'text-blue-500' : 'text-slate-400 hover:text-slate-600'}`}><User size={24} strokeWidth={currentTab === 'kid' ? 2.5 : 2} /><span className="text-[10px] font-bold mt-1">我的專區</span></button>
                        <div className="w-px h-6 bg-slate-300/50"></div>
                        <button onClick={() => { setCurrentTab('parent'); if(!isAuthenticated) setIsAuthenticated(false); }} className={`flex flex-col items-center justify-center w-full h-full rounded-full transition-all relative ${currentTab === 'parent' ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`}>{data.requests.filter(r => r.status === 'pending').length > 0 && <span className="absolute top-3 right-8 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}<ShieldCheck size={24} strokeWidth={currentTab === 'parent' ? 2.5 : 2} /><span className="text-[10px] font-bold mt-1">家長專區</span></button>
                    </nav>
                </div>
            );
        }

        window.onload = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };
    </script>
</body>
</html>
